# ç¬¬187ç« ï¼šå¾©ç¿’ï¼šèªè¨¼ã¯â€œUIâ€ã‚ˆã‚Šâ€œã‚¬ãƒ¼ãƒ‰â€ãŒæœ¬ä½“ğŸ§±

èªè¨¼ã£ã¦ã€ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’ã€Œä½œã‚‹ã“ã¨ã€ã‚ˆã‚Šã‚‚ã€**ã€Œå…¥ã£ã¡ã‚ƒãƒ€ãƒ¡ãªäººã‚’çµ¶å¯¾ã«é€šã•ãªã„ä»•çµ„ã¿ï¼ˆã‚¬ãƒ¼ãƒ‰ï¼‰ã€ã‚’ä½œã‚‹ã“ã¨**ãŒæœ¬ä½“ã ã‚ˆã€œï¼ğŸ˜ºâœ¨
ãƒœã‚¿ãƒ³ã‚’éš ã™ãƒ»ãƒšãƒ¼ã‚¸ã‚’è¦‹ãˆãªãã™ã‚‹â€¦ã ã‘ã ã¨ã€ç°¡å˜ã«çªç ´ã•ã‚Œã¡ã‚ƒã†ã®ğŸ¥²ğŸ’¥

---

## 1) â€œUIã ã‘èªè¨¼â€ãŒå±ãªã„ç†ç”±ğŸ˜±ğŸš¨

ãŸã¨ãˆã°â€¦

* âœ… ç”»é¢ã§ã¯ã€Œç·¨é›†ãƒœã‚¿ãƒ³ã€ãŒéè¡¨ç¤ºã«ãªã£ã¦ã‚‹
* âŒ ã§ã‚‚ã€APIã‚„Server ActionãŒ**èª°ã§ã‚‚å©ã‘ã‚‹**ã¾ã¾ã ã¨â€¦
  â†’ URLç›´æ‰“ã¡ or DevToolsã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œã£ã¦ **ç·¨é›†ã§ãã¡ã‚ƒã†**ğŸ˜‡ğŸ’£

ã¤ã¾ã‚Šâ€¦
**UIã¯â€œè¦ªåˆ‡â€ã®ãŸã‚**ã§ã€
**å®‰å…¨ã¯â€œã‚µãƒ¼ãƒãƒ¼å´ã‚¬ãƒ¼ãƒ‰â€ã§å®ˆã‚‹**ã®ãŒå¤§å‰æã ã‚ˆï¼ğŸ›¡ï¸âœ¨

---

## 2) ã‚¬ãƒ¼ãƒ‰ã¯ã€Œ3æ®µæ§‹ãˆã€ã§è€ƒãˆã‚‹ã®ãŒãƒ©ã‚¯ğŸ˜ğŸ§±ğŸ§±ğŸ§±

![ã‚¬ãƒ¼ãƒ‰ã®3æ®µæ§‹ãˆ](./picture/next_study_187_guard_defense.png)

* **â‘  å…¥å£ã‚¬ãƒ¼ãƒ‰ï¼šMiddleware**ï¼ˆãƒ«ãƒ¼ãƒˆã«å…¥ã‚‹å‰ã®é–€ç•ªï¼‰ğŸ§¤
* **â‘¡ ä¸­èº«ã‚¬ãƒ¼ãƒ‰ï¼šServer Component / layout**ï¼ˆãƒšãƒ¼ã‚¸æœ¬ä½“ã§æœ€çµ‚ç¢ºèªï¼‰ğŸ§Š
* **â‘¢ æ“ä½œã‚¬ãƒ¼ãƒ‰ï¼šRoute Handler / Server Actions**ï¼ˆæ›´æ–°ãƒ»å‰Šé™¤ãªã©â€œæ“ä½œâ€ã®å®ˆã‚Šï¼‰ğŸšª

å›³ã§è¦‹ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ğŸ‘‡ğŸ’¡

```mermaid
flowchart TB
  U["ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œğŸ§‘â€ğŸ’»"] --> UI["UI: ãƒœã‚¿ãƒ³è¡¨ç¤º/éè¡¨ç¤ºğŸ˜º"]
  U --> RQ["ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ğŸ“¨"]

  subgraph "æœ¬ç‰©ã®å®ˆã‚ŠğŸ›¡ï¸ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ï¼‰"
    MW["â‘  Middleware: å…¥å£ã§æ­¢ã‚ã‚‹ğŸ§¤"]
    SC["â‘¡ Server Component/layout: æœ¬ä½“ã§ç¢ºèªğŸ§Š"]
    API["â‘¢ Route Handler/Server Actions: æ“ä½œã‚’å®ˆã‚‹ğŸšª"]
  end

  RQ --> MW
  MW -->|"OK"| SC
  MW -->|"NG"| RED["redirect/login ãªã©ğŸš¦"]
  SC --> API
  API -->|"OK"| OK["å‡¦ç†æˆåŠŸğŸ‰"]
  API -->|"NG"| DENY["403/redirect/ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºğŸ™…â€â™€ï¸"]
```

---

## 3) ãã‚Œãã‚Œã®å½¹å‰²ï¼ˆã“ã“ãŒãƒ†ã‚¹ãƒˆã«å‡ºã‚‹ğŸ˜†ğŸ“Œï¼‰

### â‘  Middlewareï¼šã¾ãšâ€œå…¥å ´â€ã‚’æ­¢ã‚ã‚‹ğŸ§¤ğŸš¦

* **å‘ã„ã¦ã‚‹**ï¼š`/dashboard` ã¨ã‹ã€Œãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆã‚¾ãƒ¼ãƒ³ã€ã¸ã®å…¥å ´åˆ¶é™ğŸ°
* **æ°—æŒã¡**ï¼šæœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰**ãƒšãƒ¼ã‚¸æç”»ã™ã‚‰ã•ã›ãš**ãƒ­ã‚°ã‚¤ãƒ³ã¸é€ã‚‹ğŸ“®

---

### â‘¡ Server Component / layoutï¼šãƒšãƒ¼ã‚¸å´ã§â€œæœ€çµ‚ç¢ºèªâ€ğŸ§Šâœ…

MiddlewareãŒã‚ã£ã¦ã‚‚ã€**ãƒšãƒ¼ã‚¸å´ã§ã‚‚ç¢ºèªã—ã¦ãŠã**ã¨å®‰å¿ƒæ„ŸMAXğŸ¥¹ğŸ›¡ï¸
ï¼ˆè¨­å®šãƒŸã‚¹ãƒ»ä¾‹å¤–ãƒ«ãƒ¼ãƒˆãƒ»ç›´ã‚¢ã‚¯ã‚»ã‚¹â€¦ãœã‚“ã¶ã‚ã‚Šå¾—ã‚‹ã®ã§ğŸ’¦ï¼‰

* **å‘ã„ã¦ã‚‹**ï¼šãƒšãƒ¼ã‚¸è¡¨ç¤ºæ¡ä»¶ï¼ˆä¾‹ï¼šãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆã€æ¨©é™å¿…é ˆï¼‰ğŸ‘‘

---

### â‘¢ Route Handler / Server Actionsï¼šã„ã¡ã°ã‚“å¤§äº‹ãªâ€œæ“ä½œâ€ã®å®ˆã‚ŠğŸšªğŸ’¥

æœ¬å½“ã«å±ãªã„ã®ã¯ã“ã“ï¼ğŸ˜±
ã€Œæ›´æ–°ã€ã€Œå‰Šé™¤ã€ã€ŒæŠ•ç¨¿ã€ã¿ãŸã„ãªæ“ä½œã¯ã€**UIã§éš ã—ã¦ã¦ã‚‚é–¢ä¿‚ãªãå©ã‹ã‚Œã‚‹**å‰æã§å®ˆã‚‹ã‚ˆğŸ§±âœ¨

* **å‘ã„ã¦ã‚‹**ï¼šCRUDå…¨éƒ¨ï¼ˆç‰¹ã« Update/Deleteï¼‰âœï¸ğŸ—‘ï¸
* **ã‚„ã‚‹ã“ã¨**ï¼šã‚µãƒ¼ãƒãƒ¼ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª â†’ æ¨©é™ç¢ºèª â†’ ãƒ€ãƒ¡ãªã‚‰æ‹’å¦ğŸ™…â€â™€ï¸

---

## 4) ãƒŸãƒ‹å®Ÿè£…ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆâ€œå®ˆã‚Šã®å‹â€ï¼‰ğŸ§©âœ¨

> â€»Auth.jsï¼ˆNextAuthç³»ï¼‰ã®æ›¸ãæ–¹ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆã§å°‘ã—å¤‰ã‚ã‚‹ã‘ã©ã€**è€ƒãˆæ–¹ã¯ã“ã‚Œ**ã§OKã ã‚ˆã€œï¼ğŸ˜º

### A) Middlewareã§ã€Œ/dashboardé…ä¸‹ã€ã‚’ãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆã«ã™ã‚‹ğŸ§¤

```ts
// middleware.tsï¼ˆä¾‹ï¼‰
import { NextResponse } from "next/server";
// ä¾‹ï¼šAuth.jså´ã§ç”¨æ„ã—ãŸã€Œã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—é–¢æ•°ã€ã‚’ä½¿ã†æƒ³å®š
import { auth } from "@/auth";

export default auth((req) => {
  const isLoggedIn = !!req.auth;

  if (!isLoggedIn) {
    const url = req.nextUrl.clone();
    url.pathname = "/login";
    url.searchParams.set("from", req.nextUrl.pathname);
    return NextResponse.redirect(url);
  }

  return NextResponse.next();
});

export const config = {
  matcher: ["/dashboard/:path*"],
};
```

---

### B) layoutã§â€œãƒšãƒ¼ã‚¸æœ¬ä½“ã®æœ€çµ‚ç¢ºèªâ€ğŸ§Š

```tsx
// app/dashboard/layout.tsxï¼ˆä¾‹ï¼‰
import { redirect } from "next/navigation";
import { auth } from "@/auth";

export default async function DashboardLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const session = await auth();

  if (!session) {
    redirect("/login");
  }

  return (
    <div>
      <h1>Dashboard</h1>
      {children}
    </div>
  );
}
```

---

### C) Server Actions / Route Handlerã§â€œæ“ä½œã‚’å®ˆã‚‹â€ğŸšªğŸ›¡ï¸

ã€Œãƒœã‚¿ãƒ³æŠ¼ã›ãŸã‹ã€ã˜ã‚ƒãªãã¦ã€**ã‚µãƒ¼ãƒãƒ¼ãŒè¨±å¯ã—ãŸã‹**ã ã‘ãŒæ­£ç¾©ï¼ğŸ˜¼âœ¨

```ts
// app/api/todos/[id]/route.tsï¼ˆä¾‹ï¼‰
import { NextResponse } from "next/server";
import { auth } from "@/auth";

export async function DELETE(
  _req: Request,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;
  const session = await auth();
  if (!session) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  // ã“ã“ã§ã€Œãã®TODOãŒã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç‰©ã‹ï¼Ÿã€ã¿ãŸã„ãªæ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯ã‚‚å¿…é ˆğŸ‘
  // if (!isOwner(session.user.id, params.id)) return 403

  // delete...
  return NextResponse.json({ ok: true });
}
```

---

## 5) ã‚ˆãã‚ã‚‹è½ã¨ã—ç©´ãƒã‚§ãƒƒã‚¯âœ…ğŸ•³ï¸

* âŒ ã€Œãƒœã‚¿ãƒ³éè¡¨ç¤ºã«ã—ãŸã‹ã‚‰å®‰å…¨ã€â†’ **å®‰å…¨ã˜ã‚ƒãªã„**ğŸ˜‡
* âŒ ã€Œãƒšãƒ¼ã‚¸ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³è¦‹ãŸã‹ã‚‰OKã€â†’ **æ“ä½œã‚‚å¿…ãšå®ˆã‚‹**ğŸšª
* âŒ ã€Œãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚‹ã‹ã ã‘è¦‹ãŸã€â†’ **â€œæ¨©é™ï¼ˆadminç­‰ï¼‰â€ã‚‚åˆ¥ã§è¦‹ã‚‹**ğŸ‘‘
* âœ… ã€Œå…¥å£ + æœ¬ä½“ + æ“ä½œã€3ç‚¹ã‚»ãƒƒãƒˆã§å®‰å¿ƒğŸ§±ğŸ§±ğŸ§±âœ¨

---

## 6) ãƒŸãƒ‹æ¼”ç¿’ï¼ˆ15åˆ†ï¼‰â³ğŸŒ¸

æ¬¡ã®3ã¤ã‚’â€œå…¨éƒ¨â€ã§ããŸã‚‰å‹ã¡ã€œï¼ğŸ®ğŸ‰

1. `/dashboard` ã«æœªãƒ­ã‚°ã‚¤ãƒ³ã§å…¥ã£ãŸã‚‰ `/login` ã«é£›ã°ã™ğŸ§¤ğŸš¦
2. `/dashboard` ã® `layout.tsx` ã§ã‚‚æœªãƒ­ã‚°ã‚¤ãƒ³ã‚’ `redirect()` ã™ã‚‹ğŸ§Š
3. `/api/todos/[id]` ã® `DELETE` ã‚’æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰ `401` ã«ã™ã‚‹ğŸšªğŸ›¡ï¸

ã§ããŸã‚‰ã€æœ€å¾Œã«è‡ªåˆ†ã«ã”è¤’ç¾ã‚¹ã‚¤ãƒ¼ãƒ„ğŸ°ã§OKã§ã™ğŸ˜†ğŸ’•

---

## ã¾ã¨ã‚ğŸ€âœ¨

* èªè¨¼ã®æœ¬ä½“ã¯ **UIã˜ã‚ƒãªãâ€œã‚¬ãƒ¼ãƒ‰â€** ğŸ§±ğŸ”‘
* ã‚¬ãƒ¼ãƒ‰ã¯ **å…¥å£ï¼ˆMiddlewareï¼‰â†’æœ¬ä½“ï¼ˆServerï¼‰â†’æ“ä½œï¼ˆAPI/Actionsï¼‰** ã®é †ã§å›ºã‚ã‚‹ğŸ’ª
* ç‰¹ã«å¤§äº‹ãªã®ã¯ **â€œæ“ä½œã®å®ˆã‚Šâ€**ï¼ˆæ›´æ–°ãƒ»å‰Šé™¤ã¯çµ¶å¯¾ã‚µãƒ¼ãƒãƒ¼ã§æ­¢ã‚ã‚‹ï¼‰ğŸšªğŸ›¡ï¸

æ¬¡ã®ç« ã‹ã‚‰ã¯ã€ã“ã“ã¾ã§ã®å®ˆã‚Šã‚’åœŸå°ã«ã—ã¦ã€Œèªè¨¼ä»˜ãTODOã€ã‚’å®Œæˆå½¢ã«å¯„ã›ã¦ã„ãã‚ˆã€œï¼ğŸ˜ºğŸ”¥
