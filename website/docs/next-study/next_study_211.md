# ç¬¬211ç« ï¼šãƒ¢ãƒƒã‚¯ã®è€ƒãˆæ–¹ï¼ˆã‚„ã‚Šã™ãæ³¨æ„ï¼‰ğŸ­

## ä»Šæ—¥ã®ã‚´ãƒ¼ãƒ« ğŸ¯âœ¨

* **ãƒ¢ãƒƒã‚¯ï¼ˆmockï¼‰ã£ã¦ä½•ã®ãŸã‚ï¼Ÿ**ã‚’ã‚¹ãƒƒã‚­ãƒªç†è§£ã™ã‚‹ğŸ˜Š
* **ã€Œã©ã“ã‚’ãƒ¢ãƒƒã‚¯ã—ã¦ã€ã©ã“ã¯æœ¬ç‰©ã®ã¾ã¾ï¼Ÿã€**ã®åˆ¤æ–­ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ğŸ§ 
* Vitestã§ã‚ˆãä½¿ã† **`vi.fn` / `vi.spyOn` / `vi.mock` / `vi.stubGlobal`** ã‚’â€œå¿…è¦ãªåˆ†ã ã‘â€ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ğŸª„ ([vitest.dev][1])

---

## 1) ãƒ¢ãƒƒã‚¯ã£ã¦ãªã«ï¼ŸğŸ­ï¼ˆè¶…ã–ã£ãã‚Šï¼‰

![mocking](./picture/next_study_211_mocking.png)

ãƒ¢ãƒƒã‚¯ã¯ã€ãƒ†ã‚¹ãƒˆä¸­ã ã‘ç™»å ´ã™ã‚‹ **ã€Œä»£å½¹ï¼ˆã‚¹ã‚¿ãƒ³ãƒˆï¼‰ã€** ã ã‚ˆã€œï¼ğŸ¬âœ¨
æœ¬ç‰©ã«é ¼ã‚‹ã¨ã€ãƒ†ã‚¹ãƒˆãŒã“ã†ãªã‚ŠãŒã¡ğŸ‘‡

* ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒé…ã„/è½ã¡ã‚‹â†’ãƒ†ã‚¹ãƒˆãŒä¸å®‰å®šğŸ˜µâ€ğŸ’«
* æ™‚åˆ»ã‚„ä¹±æ•°ã§çµæœãŒå¤‰ã‚ã‚‹â†’å†ç¾ã§ããªã„ğŸ˜­
* ãƒ«ãƒ¼ã‚¿ãƒ¼ã‚„å¤–éƒ¨SDKãŒé‡ã„â†’ãƒ†ã‚¹ãƒˆãŒé…ã„ğŸ¢

ã ã‹ã‚‰ **â€œå¤–éƒ¨ã®ã‚‚ã®â€ã ã‘ä»£å½¹ã«ã—ã¦**ã€ãƒ†ã‚¹ãƒˆã‚’å®‰å®šã•ã›ã‚‹ã®ãŒç›®çš„ã ã‚ˆğŸ’ªğŸ­

---

## 2) ä¼¼ã¦ã‚‹å­ãŸã¡ï¼šMock / Stub / Spy ğŸ‘¯â€â™€ï¸âœ¨

ã–ã£ãã‚Šä½¿ã„åˆ†ã‘ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ï¼

* **Stubï¼ˆã‚¹ã‚¿ãƒ–ï¼‰**ï¼šæˆ»ã‚Šå€¤ã ã‘æ±ºã‚ã‚‹ä¿‚ğŸ“¦ï¼ˆã€Œã“ã‚Œè¿”ã—ã¦ã­ã€ï¼‰
* **Mockï¼ˆãƒ¢ãƒƒã‚¯ï¼‰**ï¼šå‘¼ã°ã‚Œæ–¹ã‚‚ãƒã‚§ãƒƒã‚¯ã—ãŸã„ä¿‚ğŸ“ï¼ˆã€Œä½•å›å‘¼ã‚“ã ï¼Ÿå¼•æ•°ã¯ï¼Ÿã€ï¼‰
* **Spyï¼ˆã‚¹ãƒ‘ã‚¤ï¼‰**ï¼šæœ¬ç‰©ã‚’è¦‹å¼µã‚‹ä¿‚ğŸ•µï¸ï¼ˆã€Œæœ¬ç‰©ã¯å‹•ã‹ã—ã¤ã¤ã€å‘¼ã³å‡ºã—ãƒ­ã‚°ã ã‘å–ã‚‹ã€ï¼‰

Vitestã ã¨ã€ã ã„ãŸã„ã“ã®3ã¤ã§OKğŸ‘‡

* `vi.fn()`ï¼šãƒ¢ãƒƒã‚¯é–¢æ•°ã‚’ä½œã‚‹ğŸ­ ([vitest.dev][2])
* `vi.spyOn(obj, "method")`ï¼šã‚¹ãƒ‘ã‚¤ã™ã‚‹ğŸ•µï¸ ([vitest.dev][2])

---

## 3) ã©ã“ã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹ï¼Ÿã€Œå¢ƒç•Œã ã‘ã€ãŒãŠã™ã™ã‚ğŸš§âœ¨

ã‚³ãƒ„ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã€**ã‚¢ãƒ—ãƒªã®â€œå¢ƒç•Œâ€ã ã‘ãƒ¢ãƒƒã‚¯**ã™ã‚‹ã®ãŒå®‰å®šã—ã‚„ã™ã„ã‚ˆğŸ¯
ï¼ˆå¢ƒç•Œï¼ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã€æ™‚é–“ã€ãƒ–ãƒ©ã‚¦ã‚¶APIã€Nextã®ãƒ«ãƒ¼ã‚¿ãƒ¼ã€å¤–éƒ¨SDKãªã©ï¼‰

å›³ã§ã„ã†ã¨ã“ã“ğŸ‘‡

```mermaid
flowchart TD
  A["ã‚ãªãŸã®UI/ãƒ­ã‚¸ãƒƒã‚¯"] --> B["å¢ƒç•Œ: fetch/Router/Date/å¤–éƒ¨SDK"]
  B --> C["å¤–ã®ä¸–ç•Œ: API/ãƒ–ãƒ©ã‚¦ã‚¶/ã‚¤ãƒ³ãƒ•ãƒ©"]
  A:::good -->|"ãƒ†ã‚¹ãƒˆã§ã¯æœ¬ç‰©ã§OK"| A
  B:::mock -->|"ãƒ†ã‚¹ãƒˆã§ã¯ä»£å½¹ã«ã—ãŒã¡"| B
  classDef mock fill:#ffe6f2,stroke:#ff4da6,stroke-width:2px;
  classDef good fill:#e8fff1,stroke:#00b36b,stroke-width:2px;
```

---

## 4) ã‚„ã‚Šã™ãæ³¨æ„ãƒã‚¤ãƒ³ãƒˆâš ï¸ğŸ§Šï¼ˆãƒ¢ãƒƒã‚¯ã—ã™ãã‚‹ã¨èµ·ãã‚‹äº‹æ•…ï¼‰

ãƒ¢ãƒƒã‚¯ã‚’å¢—ã‚„ã—ã™ãã‚‹ã¨ã€ãƒ†ã‚¹ãƒˆãŒã“ã†ãªã‚ŠãŒã¡ğŸ‘‡

* **å®Ÿè£…ã®ç´°éƒ¨ã«ä¾å­˜**ã—ã¦ã€ã¡ã‚‡ã£ã¨ãƒªãƒ•ã‚¡ã‚¯ã‚¿ã§ãƒ†ã‚¹ãƒˆå´©å£ŠğŸ’¥
* ã€Œç”»é¢ã¨ã—ã¦æ­£ã—ã„ã‹ã€ã‚ˆã‚Šã€Œå‘¼ã³å‡ºã—ã®é †ç•ªãŒåŒã˜ã‹ã€ã¿ãŸã„ãªãƒ†ã‚¹ãƒˆã«ãªã‚‹ğŸŒ€
* æœ¬ç•ªã§ã¯å£Šã‚Œã¦ã‚‹ã®ã«ãƒ†ã‚¹ãƒˆã ã‘é€šã‚‹â€¦ğŸ˜‡

Testing Libraryç³»ã®è€ƒãˆæ–¹ã¯ã€ã–ã£ãã‚Š **â€œãƒ¦ãƒ¼ã‚¶ãƒ¼è¦–ç‚¹ã§ãƒ†ã‚¹ãƒˆã—ã‚ˆã†â€** ãªã®ã§ã€**å†…éƒ¨å®Ÿè£…ã‚’å½“ã¦ã«ã—ã™ãã‚‹ãƒ¢ãƒƒã‚¯**ã¯å¢—ã‚„ã—ã™ãæ³¨æ„ã ã‚ˆã€œï¼ğŸ«¶ ([Kent C. Dodds][3])

---

## 5) åˆ¤æ–­ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆğŸ§­âœ¨ï¼ˆè¿·ã£ãŸã‚‰ã“ã‚Œï¼‰

```mermaid
flowchart TD
  A["ã“ã“ã€ãƒ¢ãƒƒã‚¯ã™ã‚‹ï¼Ÿ"] --> B{"å¤–éƒ¨ä¾å­˜ï¼Ÿ<br>(#quot;ãƒãƒƒãƒˆ/æ™‚é–“/ä¹±æ•°/Routerç­‰#quot;)"}
  B -->|"ã„ã„ãˆ"| C["ãƒ¢ãƒƒã‚¯ã—ãªã„ğŸ‘<br>æœ¬ç‰©ã®ã¾ã¾ãƒ†ã‚¹ãƒˆ"]
  B -->|"ã¯ã„"| D{"é…ã„/ä¸å®‰å®š/å†ç¾ã—ã«ãã„ï¼Ÿ"}
  D -->|"ã¯ã„"| E["å¢ƒç•Œã ã‘ãƒ¢ãƒƒã‚¯ğŸ­<br>æˆ»ã‚Šå€¤ã‚„å‘¼ã°ã‚Œæ–¹ã‚’å›ºå®š"]
  D -->|"ã„ã„ãˆ"| F["æœ¬ç‰©ã§ã‚‚OKğŸ‘Œ<br>(#quot;å¿…è¦ã«ãªã‚‹ã¾ã§æ¸©å­˜#quot;)"]
```

---

## 6) Vitestã§ã®å®šç•ªãƒ¢ãƒƒã‚¯3ç‚¹ã‚»ãƒƒãƒˆğŸ§°âœ¨

### 6-1) `vi.fn()`ï¼šãƒ¢ãƒƒã‚¯é–¢æ•°ï¼ˆå‘¼ã°ã‚ŒãŸã‹ç¢ºèªã—ãŸã„ï¼‰ğŸ“ğŸ­

```ts
import { vi, expect, test } from "vitest";

test("ãƒ¢ãƒƒã‚¯é–¢æ•°ãŒå‘¼ã°ã‚Œã‚‹", () => {
  const onClick = vi.fn();

  onClick("hello");

  expect(onClick).toHaveBeenCalledTimes(1);
  expect(onClick).toHaveBeenCalledWith("hello");
});
```

`vi.fn` ã¯ã€Œå‘¼ã³å‡ºã—å›æ•°ãƒ»å¼•æ•°ã€ãƒã‚§ãƒƒã‚¯ã«å¼·ã„ã‚ˆğŸ’ª ([vitest.dev][2])

---

### 6-2) `vi.spyOn()`ï¼šæœ¬ç‰©ã‚’å‹•ã‹ã—ã¤ã¤è¨˜éŒ²ğŸ•µï¸âœ¨

ã€Œãƒ­ã‚°ãŒå‡ºãŸã‹ã€ã¿ãŸã„ãªã®ã«ä¾¿åˆ©ã€œï¼

```ts
import { vi, expect, test } from "vitest";

test("console.error ã‚’ç›£è¦–ã™ã‚‹", () => {
  const spy = vi.spyOn(console, "error").mockImplementation(() => {});

  console.error("oops");

  expect(spy).toHaveBeenCalledWith("oops");

  spy.mockRestore(); // å¾Œç‰‡ä»˜ã‘ğŸ§¹
});
```

â€»ã‚¹ãƒ‘ã‚¤ã¯ **å¾Œç‰‡ä»˜ã‘** å¤§äº‹ã ã‚ˆğŸ§¹âœ¨ï¼ˆå¿˜ã‚Œã‚‹ã¨ä»–ã®ãƒ†ã‚¹ãƒˆã«å½±éŸ¿ã—ãŒã¡ï¼‰

---

### 6-3) `vi.mock()`ï¼šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã”ã¨å·®ã—æ›¿ãˆï¼ˆNextã®hookç­‰ï¼‰ğŸ§©ğŸ­

Next.jsï¼ˆApp Routerï¼‰ã§è¶…ã‚ˆãã‚ã‚‹ã®ãŒ `next/navigation` ã®hooksã ã‚ˆã­ğŸš€
ãƒ†ã‚¹ãƒˆã ã¨ã€ŒRouterãŒãƒã‚¦ãƒ³ãƒˆã•ã‚Œã¦ãªã„ã‚ˆã€ç³»ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚„ã™ãã¦ã€**ã“ã“ã‚’ãƒ¢ãƒƒã‚¯**ã™ã‚‹ã®ãŒå®šç•ªï¼ğŸ›£ï¸ ([GitHub][4])

ä¾‹ï¼šãƒœã‚¿ãƒ³æŠ¼ã—ãŸã‚‰ `router.push("/mypage")` ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆâœ¨

**ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**ï¼ˆä¾‹ï¼š`app/components/GoMyPageButton.tsx`ï¼‰

```tsx
"use client";

import { useRouter } from "next/navigation";

export function GoMyPageButton() {
  const router = useRouter();

  return (
    <button onClick={() => router.push("/mypage")}>
      ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸
    </button>
  );
}
```

**ãƒ†ã‚¹ãƒˆ**ï¼ˆä¾‹ï¼š`GoMyPageButton.test.tsx`ï¼‰

```tsx
import { render, screen } from "@testing-library/react";
import userEvent from "@testing-library/user-event";
import { vi, expect, test } from "vitest";
import { GoMyPageButton } from "./GoMyPageButton";

const pushMock = vi.fn();

vi.mock("next/navigation", () => ({
  useRouter: () => ({ push: pushMock }),
}));

test("ã‚¯ãƒªãƒƒã‚¯ã§ /mypage ã«é·ç§»ã™ã‚‹", async () => {
  const user = userEvent.setup();

  render(<GoMyPageButton />);
  await user.click(screen.getByRole("button", { name: "ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸" }));

  expect(pushMock).toHaveBeenCalledWith("/mypage");
});
```

ãƒã‚¤ãƒ³ãƒˆğŸ¯

* ãƒ«ãƒ¼ã‚¿ãƒ¼æœ¬ä½“ã‚’å†ç¾ã—ã‚ˆã†ã¨ã—ãªã„ğŸ™…â€â™€ï¸
* **ã“ã®ãƒ†ã‚¹ãƒˆã§å¿…è¦ãªæœ€å°é™ï¼ˆ`push`ã ã‘ï¼‰** ã‚’å·®ã—æ›¿ãˆã‚‹ğŸ­âœ¨

---

## 7) fetchã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹ï¼š2ã¤ã®è€ƒãˆæ–¹ğŸŒŠğŸ§ª

### A) â€œæ‰‹ã§fetchã‚’å·®ã—æ›¿ãˆã‚‹â€ï¼ˆå°ã•ãæ¸ˆã‚€ãªã‚‰OKï¼‰ğŸ§¤

Vitestã«ã¯ `vi.stubGlobal` ãŒã‚ã‚‹ã‚ˆğŸª„ï¼ˆãŸã ã—è‡ªå‹•ãƒªã‚»ãƒƒãƒˆã«æ³¨æ„ï¼ï¼‰ ([vitest.dev][5])

```ts
import { vi, afterEach } from "vitest";

afterEach(() => {
  vi.unstubAllGlobals(); // å¾Œç‰‡ä»˜ã‘ğŸ§¹ï¼ˆã¾ãŸã¯ config ã§ unstubGlobalsï¼‰
});

vi.stubGlobal("fetch", vi.fn(async () => {
  return {
    ok: true,
    json: async () => ({ name: "Hanako" }),
  } as any;
}));
```

---

### B) â€œMSWã§APIã‚’è‡ªç„¶ã«ãƒ¢ãƒƒã‚¯â€ï¼ˆãŠã™ã™ã‚ã•ã‚ŒãŒã¡ï¼‰ğŸ›°ï¸âœ¨

Testing Libraryã®ä¾‹ã§ã¯ã€`fetch` ã‚’ç›´æ¥ã‚¹ã‚¿ãƒ–ã™ã‚‹ã‚ˆã‚Š **MSWï¼ˆMock Service Workerï¼‰** ã¿ãŸã„ã«ã€Œé€šä¿¡ã£ã½ãã€ãƒ¢ãƒƒã‚¯ã™ã‚‹ã®ãŒæ¨ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ã‚ˆğŸ“® ([ãƒ†ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒ©ã‚¤ãƒ–ãƒ©ãƒª][6])
ï¼ˆã“ã®ç« ã§ã¯â€œè€ƒãˆæ–¹â€ã ã‘ã§OKï¼æ¬¡ã®ç« ã‚„èª²é¡Œã§å°å…¥ã§ã‚‚ğŸ™†â€â™€ï¸ï¼‰

---

## 8) Next.jsï¼ˆApp Routerï¼‰ã ã¨ã€ã“ã“æ³¨æ„âš ï¸ğŸ§Š

* **`async` ãª Server Component** ã¯ã€ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆVitestï¼‰ã§æ‰±ã„ã¥ã‚‰ã„ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ã‚ˆã€œã€‚ãã†ã„ã†ã®ã¯ **E2Eå¯„ã‚Š**ã§è¦‹ã‚‹åˆ¤æ–­ã‚‚ã‚¢ãƒªğŸ¬ ([Next.js][7])
* ã ã‹ã‚‰ã“ãã€ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã§ã¯

  * **Client Componentã®UIã¨æ“ä½œ**
  * **å¢ƒç•Œï¼ˆRouter/fetchç­‰ï¼‰ã‚’æœ€å°ãƒ¢ãƒƒã‚¯**
    ãŒæ°—æŒã¡ã‚ˆãã¾ã¨ã¾ã‚Šã‚„ã™ã„ã‚ˆğŸ˜Šâœ¨

---

## 9) ã¾ã¨ã‚ï¼šãƒ¢ãƒƒã‚¯ã¯ã€Œå¿…è¦ãªåˆ†ã ã‘ã€ğŸ­ğŸ«¶

è¦šãˆã‚‹åˆè¨€è‘‰ã¯ã“ã‚Œã€œï¼ğŸ’

* âœ… **å¤–éƒ¨ï¼ˆå¢ƒç•Œï¼‰ã ã‘ãƒ¢ãƒƒã‚¯**ã—ãŒã¡
* âœ… **æˆ»ã‚Šå€¤å›ºå®šï¼‹å‘¼ã°ã‚Œæ–¹ç¢ºèª**ãŒä¸»ãªç”¨é€”
* âš ï¸ **å®Ÿè£…ã®ç´°éƒ¨ã‚’å†ç¾ã—ã‚ˆã†ã¨ã—ãªã„**ï¼ˆãƒ†ã‚¹ãƒˆãŒå£Šã‚Œã‚„ã™ããªã‚‹ï¼‰ ([Kent C. Dodds][3])

---

## ãƒŸãƒ‹ç·´ç¿’ï¼ˆ3åˆ†ï¼‰â±ï¸ğŸ£

1. `GoMyPageButton` ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€`"/settings"` ã«é£›ã¶ãƒœã‚¿ãƒ³ã‚’ä½œã£ã¦ã¿ã¦ã­âš™ï¸âœ¨
2. ãƒ†ã‚¹ãƒˆã§ã¯ `pushMock` ãŒ `"/settings"` ã§å‘¼ã°ã‚ŒãŸã‹ç¢ºèªã—ã¦ã¿ã‚ˆã†ğŸ¯ğŸ­
3. ä½™è£•ãŒã‚ã£ãŸã‚‰ã€ãƒœã‚¿ãƒ³æ–‡è¨€ã‚’å¤‰ãˆã¦ã‚‚ãƒ†ã‚¹ãƒˆãŒå£Šã‚Œã«ãã„æ›¸ãæ–¹ï¼ˆ`getByRole`ï¼‰ã‚’æ„è­˜ã—ã¦ã¿ã¦ã­ğŸ‘€ğŸ’¡

---

[1]: https://vitest.dev/api/vi?utm_source=chatgpt.com "Vitest"
[2]: https://vitest.dev/api/mock?utm_source=chatgpt.com "Mocks"
[3]: https://kentcdodds.com/blog/common-mistakes-with-react-testing-library?utm_source=chatgpt.com "Common mistakes with React Testing Library"
[4]: https://github.com/vercel/next.js/discussions/48937?utm_source=chatgpt.com "How to mock useRouter from next/navigation? #48937"
[5]: https://vitest.dev/guide/mocking?utm_source=chatgpt.com "Mocking | Guide"
[6]: https://testing-library.com/docs/react-testing-library/example-intro/?utm_source=chatgpt.com "Example"
[7]: https://nextjs.org/docs/app/guides/testing/vitest?utm_source=chatgpt.com "Testing: Vitest"
