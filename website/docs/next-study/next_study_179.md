# ç¬¬179ç« ï¼šãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’èª­ã‚€ï¼ˆServerã§å®ˆã‚‹ï¼‰ğŸ›¡ï¸

ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ã¯ã“ã‚Œã ã‚ˆã€œï¼ğŸ¯
**ã€Œãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚‹äººã ã‘è¦‹ã‚Œã‚‹ãƒšãƒ¼ã‚¸ã€ã‚’ã€â€œã‚µãƒ¼ãƒãƒ¼å´â€ã§ã¡ã‚ƒã‚“ã¨å®ˆã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹**ã“ã¨ğŸ’ª
ï¼ˆâ€»ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§è¡¨ç¤ºã‚’éš ã™ã ã‘ã ã¨ã€å®ˆã‚Œã¦ãªã„ã“ã¨ãŒã‚ã‚‹ã®â€¦ï¼ğŸ˜–ï¼‰

---

## 1) ã¾ãšå¤§äº‹ï¼šãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã¯ã€ŒServerã§åˆ¤æ–­ã€ãŒåŸºæœ¬ğŸ§ŠğŸ›¡ï¸

ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ãƒšãƒ¼ã‚¸ãŒé–‹ã‹ã‚Œã‚‹ã¨ãã€ã‚µãƒ¼ãƒãƒ¼ã¯ **Cookieï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ‰‹ãŒã‹ã‚ŠğŸªï¼‰** ã‚’è¦‹ã¦ã€Œã“ã®äººãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚‹ï¼Ÿã€ã‚’åˆ¤æ–­ã§ãã‚‹ã‚ˆâœ…
ãã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãªã‘ã‚Œã° **ãã“ã§æ­¢ã‚ã‚‹ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ï¼‰** ã®ãŒå¼·ã„ï¼ğŸš§â¡ï¸ğŸšª
Next.js ã¯ Server Component ã‹ã‚‰ `redirect()` ãŒä½¿ãˆã‚‹ã‹ã‚‰ã€ã“ã“ã§ã‚¬ãƒ¼ãƒ‰ã§ãã‚‹ã‚ˆã€œï¼([Next.js][1])

---

## 2) å…¨ä½“ã®æµã‚Œã‚’å›³ã§ã¤ã‹ã‚‚ã†ğŸ‘€ğŸ§ ï¼ˆMermaidï¼‰

![next_study_179_server_protect](./picture/next_study_179_server_protect.png)

```mermaid
flowchart TD
  A["BrowserãŒ /mypage ã‚’é–‹ã"] --> B["Server ComponentãŒå®Ÿè¡Œã•ã‚Œã‚‹"]
  B --> C["auth() ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ğŸª"]
  C --> D{"ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼Ÿ"}
  D -->|"Yes"| E["ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºğŸ‰"]
  D -->|"No"| F["redirect(#quot;'/login'#quot;)ğŸšª"]
```

ã€Œ**ãƒšãƒ¼ã‚¸ã‚’è¿”ã™å‰ã«**ãƒã‚§ãƒƒã‚¯ã—ã¦ã‚‹ã€ã®ãŒãƒã‚¤ãƒ³ãƒˆã ã‚ˆã€œï¼âœ¨

---

## 3) Serverã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’èª­ã‚€ï¼š`auth()` ã‚’ä½¿ã†ğŸªğŸ“–

Auth.jsï¼ˆNextAuth v5ç³»ï¼‰ã§ã¯ **`auth()`** ã§ã‚µãƒ¼ãƒãƒ¼å´ã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–ã‚Šã«ã„ãã®ãŒåŸºæœ¬ãƒ«ãƒ¼ãƒˆã ã‚ˆğŸ§¡
ï¼ˆv5ç§»è¡Œã§ã‚‚ `auth()` ãŒä¸­å¿ƒã«ãªã£ã¦ã‚‹ã‚ˆã€œï¼‰([authjs.dev][2])

> âœ… å‰ã®ç« ã¾ã§ã§ã€ã ã„ãŸã„ `auth.ts`ï¼ˆã¾ãŸã¯ `src/auth.ts`ï¼‰ã‚’ä½œã£ã¦ã‚‹æƒ³å®šã ã‚ˆï¼

---

## 4) å®Ÿè·µï¼šãƒšãƒ¼ã‚¸ã‚’â€œã‚µãƒ¼ãƒãƒ¼ã§â€ä¿è­·ã™ã‚‹ğŸ›¡ï¸âœ¨

### âœ… ãƒ‘ã‚¿ãƒ¼ãƒ³Aï¼š1ãƒšãƒ¼ã‚¸ã ã‘å®ˆã‚‹ï¼ˆã„ã¡ã°ã‚“ç›´æ„Ÿçš„ï¼‰ğŸŒ¸

ä¾‹ï¼š`app/mypage/page.tsx`

```tsx
import { auth } from "@/auth";
import { redirect } from "next/navigation";

export default async function MyPage() {
  const session = await auth();

  // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãªã‘ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ğŸšª
  if (!session?.user) {
    redirect("/login");
  }

  return (
    <main style={{ padding: 24 }}>
      <h1>ãƒã‚¤ãƒšãƒ¼ã‚¸ ğŸ âœ¨</h1>
      <p>ã‚ˆã†ã“ãï¼ğŸ‰</p>

      <ul>
        <li>nameï¼š{session.user.name ?? "ï¼ˆæœªè¨­å®šï¼‰"}</li>
        <li>emailï¼š{session.user.email ?? "ï¼ˆæœªè¨­å®šï¼‰"}</li>
      </ul>
    </main>
  );
}
```

ã“ã“ã§ä½¿ã£ã¦ã‚‹ `redirect()` ã¯ Server Component ã§ä½¿ãˆã‚‹ã‚ˆã€œï¼([Next.js][1])
ã“ã®æ›¸ãæ–¹ã ã¨ã€**æœªãƒ­ã‚°ã‚¤ãƒ³ã®äººã¯æœ€åˆã‹ã‚‰ä¸­èº«ã‚’å—ã‘å–ã‚Œãªã„**ã®ã§å®‰å¿ƒåº¦é«˜ã„ğŸ›¡ï¸âœ¨

---

### âœ… ãƒ‘ã‚¿ãƒ¼ãƒ³Bï¼šã¾ã¨ã‚ã¦å®ˆã‚‹ï¼ˆProtected Layoutï¼‰ğŸ“¦ğŸ›¡ï¸

ã€Œ/mypage ã‚‚ /settings ã‚‚å…¨éƒ¨ãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆã«ã—ãŸã„ï¼ã€ã¿ãŸã„ãªã¨ãã¯ã€**ãƒ«ãƒ¼ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ï¼‹layout** ãŒè¶…ä¾¿åˆ©ğŸ’¡

ä¾‹ï¼šã“ã‚“ãªæ§‹æˆã«ã™ã‚‹ã‚ˆğŸ‘‡

* `app/(protected)/layout.tsx`
* `app/(protected)/mypage/page.tsx`
* `app/(protected)/settings/page.tsx`

`app/(protected)/layout.tsx`

```tsx
import { auth } from "@/auth";
import { redirect } from "next/navigation";

export default async function ProtectedLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const session = await auth();

  if (!session?.user) {
    redirect("/login");
  }

  return <>{children}</>;
}
```

ã“ã‚Œã§ `(protected)` ã®ä¸­ã«å…¥ã‚ŒãŸãƒšãƒ¼ã‚¸å…¨éƒ¨ãŒã€ã¾ã¨ã‚ã¦ã‚¬ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã‚ˆã€œï¼ğŸ›¡ï¸âœ¨
ï¼ˆURLã¯ `(protected)` ãŒä»˜ã‹ãªã„ã®ã‚‚å¬‰ã—ã„ğŸ“¦ï¼‰

---

## 5) ã¤ã„ã§ã«ï¼šAPIï¼ˆRoute Handlerï¼‰ã‚‚å®ˆã‚Œã‚‹ã‚ˆğŸšªğŸ§ª

ãƒšãƒ¼ã‚¸ã ã‘å®ˆã£ã¦ã‚‚ã€**API ãŒé–‹ã„ã¦ãŸã‚‰æŠœã‘é“**ã«ãªã‚‹ã“ã¨ãŒã‚ã‚‹ã‚ˆã­ğŸ˜‡
Auth.js å´ã§ã‚‚ã€Œã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç„¡ã‘ã‚Œã° 401 è¿”ã™ã€ã¿ãŸã„ãªå®ˆã‚Šæ–¹ãŒç´¹ä»‹ã•ã‚Œã¦ã‚‹ã‚ˆ([authjs.dev][3])

ä¾‹ï¼š`app/api/private/route.ts`

```ts
import { auth } from "@/auth";

export async function GET() {
  const session = await auth();

  if (!session?.user) {
    return Response.json({ error: "Unauthenticated" }, { status: 401 });
  }

  return Response.json({ message: "OK âœ…", user: session.user });
}
```

---

## 6) ã‚ˆãã‚ã‚‹ãƒãƒã‚Šã©ã“ã‚é›†ğŸŒ€ï¼ˆå…ˆã«æ½°ãã€œï¼ğŸ§¯ï¼‰

* **ã€ŒClientã§éš ã›ã°OKã€ã«ãªã£ã¡ã‚ƒã†**
  â†’ ãã‚Œã ã¨ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çš„ã«ã¯å–ã‚Œã¡ã‚ƒã†å¯èƒ½æ€§ãŒã‚ã‚‹ã‚ˆğŸ˜–
  **å®ˆã‚Šã¯Server**ãŒåŸºæœ¬ğŸ›¡ï¸

* **`auth()` ã¯ Server ç”¨**
  â†’ Client Component ã§å‘¼ã¶å‰æã˜ã‚ƒãªã„ã‚ˆã€œï¼ï¼ˆå½¹å‰²åˆ†æ‹…ã ã­ğŸ­ï¼‰

* **`session?.user` ã‚’è¦‹ã‚‹ã®ãŒã‚·ãƒ³ãƒ—ãƒ«**
  â†’ `session` ãŒ `null` ã®ã“ã¨ã‚‚ã‚ã‚‹ã‹ã‚‰ã€`?.` ã‚’ä½¿ã£ã¦å®‰å…¨ã«ã­ğŸ§·

---

## 7) ãƒŸãƒ‹ç·´ç¿’ï¼ˆ10ã€œ20åˆ†ï¼‰ğŸ‹ï¸â€â™€ï¸âœ¨

### ğŸ¯ãŠé¡Œï¼šãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆã‚¨ãƒªã‚¢ã‚’ä½œã‚ã†ğŸ ğŸ”

1. `(protected)` ãƒ«ãƒ¼ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œã‚‹ğŸ“¦
2. `layout.tsx` ã§ `auth()` â†’ æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰ `/login` ã¸ğŸšª
3. `mypage/page.tsx` ã¨ `settings/page.tsx` ã‚’ä½œã£ã¦ã€ä½•ã‹è¡¨ç¤ºã—ã¦ã¿ã‚‹ğŸ¨

ã§ããŸã‚‰ã“ã†ãªã‚‹ã‚ˆğŸ‘‡

* ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãªã„ï¼š**ã©ã®ãƒšãƒ¼ã‚¸é–‹ã„ã¦ã‚‚ `/login` ã«é£›ã¶**ğŸš€
* ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚‹ï¼š**æ™®é€šã«è¦‹ã‚Œã‚‹**ğŸ‰

---

ã“ã®ç« ã¯ã“ã“ã¾ã§ï¼ğŸ€
æ¬¡ã®ç« ï¼ˆç¬¬180ç« ï¼‰ã§ã¯ã€åŒã˜ã€Œä¿è­·ã€ã‚’ **Middleware ã¨çµ„ã¿åˆã‚ã›ã¦**ã•ã‚‰ã«å¼·ãã™ã‚‹è€ƒãˆæ–¹ã«é€²ã‚ã‚‹ã‚ˆã€œğŸ§¤âœ¨

[1]: https://nextjs.org/docs/app/guides/redirecting?utm_source=chatgpt.com "Guides: Redirecting"
[2]: https://authjs.dev/getting-started/migrating-to-v5?utm_source=chatgpt.com "Migrating to v5"
[3]: https://authjs.dev/getting-started/session-management/protecting?utm_source=chatgpt.com "Protecting Resources"
