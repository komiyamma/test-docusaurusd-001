# ç¬¬75ç« ï¼šServerã§ `fetch` ã™ã‚‹ã®ãŒåŸºæœ¬ã«ãªã‚‹è©±ğŸµ

ã“ã“ã‹ã‚‰ã®Next.jsï¼ˆApp Routerï¼‰ã¯ã­ã€**ã€Œã¾ãšServerã§ãƒ‡ãƒ¼ã‚¿ã‚’å–ã£ã¦ç”»é¢ã‚’ä½œã‚‹ã€**ãŒåŸºæœ¬ã®è€ƒãˆæ–¹ã«ãªã‚‹ã‚ˆã€œï¼ğŸ˜‹ğŸ«¶
ï¼ˆãã—ã¦å¿…è¦ãªã¨ã“ã‚ã ã‘ã‚’Clientã«ã™ã‚‹æ„Ÿã˜ğŸ®ï¼‰

---

## ãªã‚“ã§Serverã§ `fetch` ãŒåŸºæœ¬ãªã®ï¼ŸğŸ¤”ğŸ’¡

### 1) ç”»é¢ãŒâ€œå…ˆã«â€å‡ºã›ã‚‹ï¼ˆä½“æ„ŸãŒé€Ÿã„ï¼‰âš¡ğŸª„

Serverã§ãƒ‡ãƒ¼ã‚¿ã‚’å–ã£ã¦HTMLã‚’ä½œã£ã¦ã‹ã‚‰è¿”ã™ã®ã§ã€**æœ€åˆã®è¡¨ç¤ºãŒæ°—æŒã¡ã‚ˆã**ãªã‚Šã‚„ã™ã„ã‚ˆã€œï¼âœ¨

### 2) APIã‚­ãƒ¼ã¨ã‹ç§˜å¯†ã‚’å®ˆã‚Œã‚‹ğŸ”ğŸ›¡ï¸

Serverãªã‚‰ `.env.local` ã®ç§˜å¯†æƒ…å ±ã‚’ä½¿ã£ã¦ã‚‚ã€**ãƒ–ãƒ©ã‚¦ã‚¶ã«æ¼ã‚Œã«ãã„**ã‚ˆï¼ï¼ˆè¶…å¤§äº‹ğŸ’¥ï¼‰

### 3) ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®JavaScriptã‚’å¢—ã‚„ã—ã«ãã„ğŸ“¦â¡ï¸ğŸª¶

Clientã§ `useEffect` ã—å§‹ã‚ã‚‹ã¨ã€çŠ¶æ…‹ç®¡ç†ãŒå¢—ãˆãŒã¡â€¦ğŸ¥º
Serverä¸­å¿ƒã ã¨ã€**ã‚·ãƒ³ãƒ—ãƒ«ã«ä½œã‚Šã‚„ã™ã„**ã‚ˆã€œï¼ğŸ§¼âœ¨

### 4) SEOçš„ã«ã‚‚æœ‰åˆ©ã«ãªã‚Šã‚„ã™ã„ğŸ”ğŸ“

HTMLã«ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ãŸçŠ¶æ…‹ã§è¿”ã—ã‚„ã™ã„ã®ã§ã€æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã«ã‚‚èª­ã¿ã‚„ã™ã„å½¢ã«ãªã‚ŠãŒã¡ğŸ‘âœ¨

### 5) Next.jsãŒâ€œè³¢ãâ€æœ€é©åŒ–ã—ã‚„ã™ã„ğŸ§ âœ¨

Next.jsã® `fetch` ã¯ã€ã‚ã¨ã§å‡ºã¦ãã‚‹**ã‚­ãƒ£ãƒƒã‚·ãƒ¥**ã¨ã‚‚ä»²è‰¯ã—ã ã‚ˆğŸ§Šï¼ˆè©³ã—ãã¯æ¬¡ã®ç« ã§ï¼ï¼‰

---

## å›³ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ğŸ“¨â¡ï¸ğŸµï¼ˆServer fetch ã®æµã‚Œï¼‰

```mermaid
flowchart LR
  U["ãƒ–ãƒ©ã‚¦ã‚¶ğŸ§‘â€ğŸ’»"] -->|"ãƒšãƒ¼ã‚¸è¦æ±‚"| N["Next.js ã‚µãƒ¼ãƒãƒ¼ğŸ–¥ï¸"]
  N -->|"Server Componentå®Ÿè¡Œ"| SC["ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆğŸ§Š"]
  SC -->|"fetch()"| API["å¤–éƒ¨APIğŸŒ"]
  API -->|"JSONãªã©"| SC
  SC -->|"HTMLç”ŸæˆğŸ§"| N
  N -->|"HTMLã‚’è¿”ã™âœ¨"| U
  N -->|"å¿…è¦ãªã‚‰JSã‚‚é…ä¿¡ğŸ®"| U
```

![Server Fetch Flow](./picture/next_study_075_server_fetch.png)

ãƒã‚¤ãƒ³ãƒˆã¯ã“ã‚ŒğŸ‘‡
**ã€Œãƒ–ãƒ©ã‚¦ã‚¶ãŒç›´æ¥APIã¸å–ã‚Šã«è¡Œãã€ã˜ã‚ƒãªãã¦ã€ã¾ãšServerãŒå–ã‚Šã«è¡Œã**ã‚¤ãƒ¡ãƒ¼ã‚¸ã ã‚ˆã€œğŸµâœ¨

---

## æœ€å°ã‚³ãƒ¼ãƒ‰ï¼šServer Componentã§ `fetch` ã—ã¦è¡¨ç¤ºã™ã‚‹ğŸ§ŠğŸ“¥

App Routerã§ã¯ã€åŸºæœ¬ã®ãƒšãƒ¼ã‚¸ï¼ˆ`page.tsx`ï¼‰ã¯**Server Componentï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰**ã ã‹ã‚‰ã€æ™®é€šã« `await fetch()` ã§ãã‚‹ã‚ˆï¼

```tsx
// app/page.tsx
type Todo = {
  id: number;
  title: string;
};

export default async function Page() {
  const res = await fetch("https://jsonplaceholder.typicode.com/todos?_limit=5");

  if (!res.ok) {
    // é€šä¿¡å¤±æ•—ãªã‚‰ã€ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦æ‰±ã†ï¼ˆã®ã¡ã® error.tsx ã§è‰¯ã„æ„Ÿã˜ã«ã§ãã‚‹ï¼‰
    throw new Error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸğŸ¥º");
  }

  const todos: Todo[] = await res.json();

  return (
    <main style={{ padding: 16 }}>
      <h1>Serverã§fetchã—ãŸTODOä¸€è¦§ğŸµ</h1>
      <ul>
        {todos.map((t) => (
          <li key={t.id}>âœ… {t.title}</li>
        ))}
      </ul>
    </main>
  );
}
```

âœ… ã“ã‚Œã§ã€Œãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸã¨ãã€ã«ServerãŒå–å¾—ã—ã¦ã€HTMLã‚’ä½œã£ã¦è¿”ã—ã¦ãã‚Œã‚‹ã‚ˆã€œï¼âœ¨

---

## Clientã§å–ã‚‹å ´åˆã¨ä½•ãŒé•ã†ï¼ŸğŸ®ğŸ†šğŸ§Š

### Client fetchï¼ˆ`useEffect`ï¼‰ã®é›°å›²æ°—ğŸ˜µâ€ğŸ’«

ã€Œç”»é¢ãŒå‡ºã¦ã‹ã‚‰å–ã‚Šã«è¡Œãã€ã®ã§ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚„çŠ¶æ…‹ç®¡ç†ãŒå¢—ãˆãŒã¡ï¼

```tsx
"use client";

import { useEffect, useState } from "react";

type Todo = { id: number; title: string };

export default function Page() {
  const [todos, setTodos] = useState<Todo[]>([]);

  useEffect(() => {
    fetch("https://jsonplaceholder.typicode.com/todos?_limit=5")
      .then((r) => r.json())
      .then(setTodos);
  }, []);

  return (
    <main>
      <h1>Clientã§fetchã—ãŸTODOğŸ®</h1>
      <ul>
        {todos.map((t) => (
          <li key={t.id}>{t.title}</li>
        ))}
      </ul>
    </main>
  );
}
```

**ã©ã£ã¡ãŒè‰¯ã„ï¼Ÿ**ã®ç­”ãˆã¯ã ã„ãŸã„ã“ã‚ŒğŸ‘‡

* **ã¾ãšServer fetch**ï¼šä¸€è¦§è¡¨ç¤ºãƒ»è©³ç´°è¡¨ç¤ºãƒ»åˆæœŸè¡¨ç¤ºã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ğŸ“„âœ¨
* **Client fetch**ï¼šæ¤œç´¢æ¡ä»¶ã‚’è§¦ã£ãŸç¬é–“ã«æ›´æ–°ã—ãŸã„ã€ã¨ã‹ã€å…¥åŠ›ã«åˆã‚ã›ã¦å¤‰ã‚ã‚‹UIğŸ”ğŸ®

ï¼ˆClientå´ã§å–ã‚‹è©±ã¯ã€ã‚‚ã£ã¨å¾Œã‚ã®ç« ã§ã¡ã‚ƒã‚“ã¨æ•´ç†ã™ã‚‹ã‚ˆğŸ«¶ï¼‰

---

## ãƒŸãƒ‹æ¼”ç¿’ğŸ¯ï¼š`/users` ãƒšãƒ¼ã‚¸ã‚’Server fetchã§ä½œã‚ã†ğŸŒ¸

### 1) ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹ğŸ“âœ¨

`app/users/page.tsx` ã‚’ä½œæˆï¼

### 2) ã‚³ãƒ”ãƒšã§OKğŸ™†â€â™€ï¸ğŸ’–

```tsx
// app/users/page.tsx
type User = {
  id: number;
  name: string;
  email: string;
};

export default async function UsersPage() {
  const res = await fetch("https://jsonplaceholder.typicode.com/users");

  if (!res.ok) {
    throw new Error("ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãŒå–ã‚Œãªã‹ã£ãŸã‚ˆğŸ¥º");
  }

  const users: User[] = await res.json();

  return (
    <main style={{ padding: 16 }}>
      <h1>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ï¼ˆServer fetchï¼‰ğŸµâœ¨</h1>

      <ul>
        {users.map((u) => (
          <li key={u.id} style={{ marginBottom: 8 }}>
            <div>ğŸ‘¤ {u.name}</div>
            <div>ğŸ“§ {u.email}</div>
          </li>
        ))}
      </ul>
    </main>
  );
}
```

### 3) èµ·å‹•ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ğŸš€

VS Codeã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼ˆPowerShellã§ã‚‚OKï¼‰ã§ğŸ‘‡

```bash
npm run dev
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ğŸ‘‡
`http://localhost:3000/users` ã«è¡Œã‘ãŸã‚‰æˆåŠŸã€œï¼ğŸ‰ğŸ‰ğŸ‰

---

## ã‚ˆãã‚ã‚‹ã¤ã¾ãšããƒã‚¤ãƒ³ãƒˆğŸª¤ï¼ˆã“ã“ã ã‘æ³¨æ„ï¼ï¼‰

* **`"use client"` ã‚’ä»˜ã‘ã‚‹ã¨Server fetchã®è©±ã˜ã‚ƒãªããªã‚‹**ï¼ˆClientã«ãªã£ã¡ã‚ƒã†ï¼‰ğŸ®âš ï¸
* **Server Componentã§ã¯ `useState` / `useEffect` ã¯ä½¿ãˆãªã„**ï¼ˆä½¿ã†ãªã‚‰Clientï¼‰ğŸ§ŠğŸ™…â€â™€ï¸
* **ç§˜å¯†æƒ…å ±ï¼ˆAPIã‚­ãƒ¼ã¨ã‹ï¼‰ã¯Clientã«æŒãŸã›ãªã„**ï¼ˆã¾ãšServerã§å®ˆã‚‹ï¼‰ğŸ”âœ¨

---

## ã¾ã¨ã‚ğŸµğŸ’–

* App Routerã¯ **Server ComponentãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**ğŸ§Š
* ã ã‹ã‚‰ã¾ãšã¯ **Serverã§ `fetch` â†’ ç”»é¢ã‚’ä½œã‚‹**ãŒåŸºæœ¬âœ¨
* Clientã«ã™ã‚‹ã®ã¯ **â€œæ“ä½œãŒå¿…è¦ãªã¨ã“ã‚ã ã‘â€**ğŸ®ğŸ«¶

æ¬¡ã®ç« ã§ã€Œãªã‚“ã§å‹æ‰‹ã«é€Ÿããªã‚‹ã®ï¼Ÿï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰ã€ã‚’æ°—æŒã¡ã‚ˆãç†è§£ã—ã¦ã„ã“ã†ã­ã€œğŸ§Šâš¡ğŸ˜†
