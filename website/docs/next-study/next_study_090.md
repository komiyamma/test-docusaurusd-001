# ç¬¬90ç« ï¼šå¾©ç¿’ï¼šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§æ··ä¹±ã—ãªã„ãŸã‚ã®3ã¤ã®è³ªå•ğŸ§ 

ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã£ã¦ã€**é€Ÿããªã‚‹ä»£ã‚ã‚Šã«ã€Œã„ã¤æ›´æ–°ã•ã‚Œã‚‹ã®ï¼Ÿã€ãŒåˆ†ã‹ã‚Šã«ãã„**ã®ãŒè½ã¨ã—ç©´ã ã‚ˆã­ğŸ¥²
ã§ã‚‚å¤§ä¸ˆå¤«ï¼ã“ã“ã§ã¯ **3ã¤ã®è³ªå•**ã§ã€æ¯å›ãƒ–ãƒ¬ãšã«åˆ¤æ–­ã§ãã‚‹â€œè€ƒãˆæ–¹ã®å‹â€ã‚’ä½œã‚‹ã‚ˆã€œğŸ˜ŠğŸ’•

---

## ã¾ãšè¶…ã–ã£ãã‚Šï¼šNext.jsã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ã€Œ1ç¨®é¡ã€ã˜ã‚ƒãªã„ğŸ˜³ğŸ§Š

Next.jsã«ã¯ä¸»ã«ã€ã“ã‚“ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚‹ã‚ˆğŸ‘‡ï¼ˆç´°ã‹ã„å®Ÿè£…ã‚’å…¨éƒ¨è¦šãˆã‚‹å¿…è¦ã¯ãªã„ã‚ˆï¼ï¼‰
ã€Œã„ã¾ä½•ãŒåŠ¹ã„ã¦ã‚‹ï¼Ÿã€ã®æ··ä¹±ã‚’æ¸›ã‚‰ã™ãŸã‚ã«ã€å­˜åœ¨ã ã‘æŠŠæ¡ã—ã¦ãŠã“ã€œğŸ«¶
ï¼ˆRequest Memoization / Data Cache / Full Route Cache / Router Cacheï¼‰ ([Next.js][1])

---

## âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§æ··ä¹±ã—ãªã„ãŸã‚ã®ã€Œ3ã¤ã®è³ªå•ã€ğŸ§ âœ¨

ã“ã“ãŒæœ¬é¡Œï¼ã“ã®3ã¤ã‚’é †ç•ªã«èãã ã‘ã§OKã ã‚ˆğŸ™†â€â™€ï¸ğŸŒ¸

### è³ªå•â‘ ï¼šãã®ãƒ‡ãƒ¼ã‚¿ã€**èª°ã®ãŸã‚**ï¼ŸğŸ‘¤ğŸŒ

* âœ… **ã¿ã‚“ãªåŒã˜**ï¼ˆä¾‹ï¼šãƒ–ãƒ­ã‚°è¨˜äº‹ä¸€è¦§ã€å•†å“ä¸€è¦§ã€å­¦æ ¡ã®ãŠçŸ¥ã‚‰ã›ï¼‰
  â†’ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã‚„ã™ã„âœ¨
* âŒ **äººã«ã‚ˆã£ã¦é•ã†**ï¼ˆä¾‹ï¼šãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã€ã‚«ãƒ¼ãƒˆã€ãƒã‚¤ãƒšãƒ¼ã‚¸ï¼‰
  â†’ åŸºæœ¬ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãªã„ï¼ˆã¾ãŸã¯å·¥å¤«ãŒå¿…è¦ï¼‰ğŸ”’

---

### è³ªå•â‘¡ï¼šãã®ãƒ‡ãƒ¼ã‚¿ã€**ã©ã‚Œãã‚‰ã„æ–°é®®**ã§ã‚ã‚‹ã¹ãï¼Ÿâ±ï¸ğŸ¥—

* ğŸŸ¢ **å¸¸ã«æœ€æ–°ãŒå¿…è¦**ï¼ˆä¾‹ï¼šåœ¨åº«ã€æ®‹å¸­ã€ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆï¼‰
  â†’ `no-store`ï¼ˆæ¯å›å–ã‚Šã«è¡Œãï¼‰ğŸ”¥
* ğŸŸ¡ **ã¡ã‚‡ã„å¤ãã¦ã‚‚OK**ï¼ˆä¾‹ï¼šãƒ©ãƒ³ã‚­ãƒ³ã‚°ã€ãƒ‹ãƒ¥ãƒ¼ã‚¹ã€ä»Šæ—¥ã®å¤©æ°—ï¼‰
  â†’ `revalidate: ç§’`ï¼ˆå®šæœŸæ›´æ–°ï¼‰ğŸ”
* ğŸ”µ **ã»ã¼å¤‰ã‚ã‚‰ãªã„**ï¼ˆä¾‹ï¼šåˆ©ç”¨è¦ç´„ã€å›ºå®šã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼‰
  â†’ `force-cache`ï¼ˆã—ã£ã‹ã‚Šã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰ğŸ§Š

---

### è³ªå•â‘¢ï¼šæ›´æ–°ã¯ **æ™‚é–“ã§ã‚„ã‚‹ï¼Ÿãã‚Œã¨ã‚‚ã‚¤ãƒ™ãƒ³ãƒˆã§ã‚„ã‚‹ï¼Ÿ**â°ğŸ¯

* â° **æ™‚é–“ã§æ›´æ–°**ï¼š
  â†’ `next: { revalidate: 3600 }` ã¿ãŸã„ã«ã€Œä½•ç§’ã”ã¨ã€
* ğŸ¯ **ã‚¤ãƒ™ãƒ³ãƒˆã§æ›´æ–°**ï¼š
  â†’ ã€ŒæŠ•ç¨¿ã—ãŸã€ã€Œä¿å­˜ã—ãŸã€ã¿ãŸã„ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ `revalidatePath` / `revalidateTag`
* ğŸ”„ **ä»Šã“ã®ç”»é¢ã ã‘æ›´æ–°ã—ãŸã„**ï¼š
  â†’ `router.refresh()`ï¼ˆç”»é¢ã®å†å–å¾—ï¼‰â€»ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥è‡ªä½“ã¯æ¶ˆã•ãªã„ ([Next.js][1])

---

## å›³è§£ï¼š3ã¤ã®è³ªå•ã§æ±ºã‚ã‚‹â€œã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ†å²â€ğŸ—ºï¸ğŸ§Š

![Cache Decision Tree](./picture/next_study_090_cache_decision.png)

```mermaid
flowchart TD
  A["ãƒ‡ãƒ¼ã‚¿å–å¾—ã—ãŸã„"] --> B{"è³ªå•â‘  ã¿ã‚“ãªåŒã˜ï¼Ÿ"}
  B -->|"No"| C["å€‹äººãƒ‡ãƒ¼ã‚¿å¯„ã‚Š"]
  C --> D{"è³ªå•â‘¡ å¸¸ã«æœ€æ–°ï¼Ÿ"}
  D -->|"Yes"| E["fetch: cache='no-store'"]
  D -->|"No"| F["ç›®çš„ã«å¿œã˜ã¦ revalidate ã‹è¨­è¨ˆè¦‹ç›´ã—"]
  B -->|"Yes"| G["å…±æœ‰ãƒ‡ãƒ¼ã‚¿å¯„ã‚Š"]
  G --> H{"è³ªå•â‘¡ ã©ã‚Œãã‚‰ã„æ–°é®®ï¼Ÿ"}
  H -->|"ã»ã¼å¤‰ã‚ã‚‰ãªã„"| I["fetch: cache='force-cache'"]
  H -->|"ãŸã¾ã«æ›´æ–°"| J["fetch: next.revalidate=ç§’"]
  H -->|"å¸¸ã«æœ€æ–°"| E
  J --> K{"è³ªå•â‘¢ æ›´æ–°ã¯æ™‚é–“ï¼Ÿã‚¤ãƒ™ãƒ³ãƒˆï¼Ÿ"}
  K -->|"æ™‚é–“"| L["revalidate(#quot;ç§’#quot;)ã§OK"]
  K -->|"ã‚¤ãƒ™ãƒ³ãƒˆ"| M["revalidatePath / revalidateTag"]
```

---

## Next.js 2025ã®é‡è¦ãƒã‚¤ãƒ³ãƒˆï¼ˆã“ã“ã ã‘ã¯çŸ¥ã£ã¦ãŠãã¨å‹ã¡ï¼‰ğŸ†âœ¨

### âœ… `fetch` ã¯ â€œåŸºæœ¬ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œãªã„â€ ã¨æ€ã£ã¦OKğŸ™†â€â™€ï¸

Next.jsã§ã¯ã€**`fetch` ã®çµæœã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œãªã„**ã‚ˆã€‚
ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãŸã„ãªã‚‰ã€æ˜ç¤ºçš„ã« `cache: 'force-cache'` ã‚’ä»˜ã‘ã‚‹ã®ãŒåˆ†ã‹ã‚Šã‚„ã™ã„ğŸ‘Œ ([Next.js][2])

### âœ… é–‹ç™ºä¸­ï¼ˆ`npm run dev`ï¼‰ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥æŒ™å‹•ãŒåˆ†ã‹ã‚Šã«ãã„ğŸ¥²

é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€HMRï¼ˆãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ï¼‰ã®éƒ½åˆã§ `fetch` ã®æŒ™å‹•ãŒæœ¬ç•ªã¨é•ã£ã¦è¦‹ãˆã‚‹ã“ã¨ãŒã‚ã‚‹ã‚ˆã€œï¼ ([Next.js][1])
ã€Œã‚­ãƒ£ãƒƒã‚·ãƒ¥åŠ¹ã„ã¦ã‚‹ï¼Ÿã€ã‚’ã¡ã‚ƒã‚“ã¨è¦‹ãŸã„æ™‚ã¯ã€å¾ŒåŠã®ãƒŸãƒ‹å®Ÿé¨“ã¿ãŸã„ã« **æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã§ç¢ºèª**ãŒå®‰å¿ƒâœ¨

---

## è¿·ã£ãŸã‚‰ã“ã®æ—©è¦‹è¡¨ğŸ§¾âœ¨ï¼ˆè¶…ä½¿ã†ï¼‰

| ç›®çš„      | ã ã„ãŸã„ã®ç­”ãˆ                    | ä¾‹               |
| ------- | -------------------------- | --------------- |
| ã¨ã«ã‹ãæœ€æ–°  | `cache: 'no-store'`        | æ®‹å¸­ / åœ¨åº« / ãƒã‚¤ãƒšãƒ¼ã‚¸ |
| å®šæœŸæ›´æ–°ã§OK | `next: { revalidate: 60 }` | ãƒ©ãƒ³ã‚­ãƒ³ã‚° / ãƒ‹ãƒ¥ãƒ¼ã‚¹    |
| ã»ã¼å›ºå®š    | `cache: 'force-cache'`     | åˆ©ç”¨è¦ç´„ / å›ºå®šãƒšãƒ¼ã‚¸    |

---

## ãƒŸãƒ‹å®Ÿé¨“ï¼š3ç¨®é¡ã®fetchã‚’â€œè¦‹ãˆã‚‹åŒ–â€ã—ã‚ˆã†ğŸ”¬ğŸ§ªâœ¨

ã€Œã»ã‚“ã¨ã«å¤‰ã‚ã‚‹ï¼Ÿæ­¢ã¾ã‚‹ï¼Ÿã€ã‚’ã€**æ™‚åˆ»ã§ç¢ºèª**ã™ã‚‹ã‚ˆâŒšğŸ’•

### â‘  APIã‚’ä½œã‚‹ï¼ˆç¾åœ¨æ™‚åˆ»ã‚’è¿”ã™ï¼‰ğŸ•’

`app/api/now/route.ts`

```ts
export const dynamic = "force-dynamic";

export async function GET() {
  return Response.json({
    now: new Date().toISOString(),
  });
}
```

### â‘¡ 3ãƒ‘ã‚¿ãƒ¼ãƒ³ã§è¡¨ç¤ºã™ã‚‹ãƒšãƒ¼ã‚¸ã‚’ä½œã‚‹ğŸ“„

`app/cache-check/page.tsx`

```ts
async function getNowNoStore() {
  const res = await fetch("http://localhost:3000/api/now", { cache: "no-store" });
  return res.json() as Promise<{ now: string }>;
}

async function getNowRevalidate10() {
  const res = await fetch("http://localhost:3000/api/now", {
    next: { revalidate: 10 },
  });
  return res.json() as Promise<{ now: string }>;
}

async function getNowForceCache() {
  const res = await fetch("http://localhost:3000/api/now", { cache: "force-cache" });
  return res.json() as Promise<{ now: string }>;
}

export default async function Page() {
  const [a, b, c] = await Promise.all([
    getNowNoStore(),
    getNowRevalidate10(),
    getNowForceCache(),
  ]);

  return (
    <main style={{ padding: 24, fontFamily: "system-ui" }}>
      <h1>ã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Ÿé¨“ğŸ§ŠğŸ”ğŸ”¥</h1>

      <ul>
        <li>ğŸ”¥ no-storeï¼š{a.now}</li>
        <li>ğŸ” revalidate(10s)ï¼š{b.now}</li>
        <li>ğŸ§Š force-cacheï¼š{c.now}</li>
      </ul>

      <p>ãƒ–ãƒ©ã‚¦ã‚¶æ›´æ–°ï¼ˆF5ï¼‰ã—ã¦ã€æ™‚åˆ»ã®å¤‰åŒ–ã‚’è¦‹ã¦ã­ğŸ˜Š</p>
    </main>
  );
}
```

### â‘¢ æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã§ç¢ºèªï¼ˆå¤§äº‹ï¼ï¼‰ğŸ§¸âœ¨

PowerShellã§ğŸ‘‡

```bash
npm run build
npm start
```

* ğŸ”¥ `no-store`ï¼šæ¯å›å¤‰ã‚ã‚‹ã¯ãš
* ğŸ” `revalidate(10)`ï¼š10ç§’éããŸã‚‰æ›´æ–°ã•ã‚Œã‚‹ã¯ãš
* ğŸ§Š `force-cache`ï¼šãšã£ã¨åŒã˜ã«ãªã‚Šã‚„ã™ã„ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒåŠ¹ãï¼‰ ([Next.js][3])

---

## ã‚ˆãã‚ã‚‹æ··ä¹±ã‚ã‚‹ã‚ã‚‹ğŸ˜‚ğŸŒ€ï¼ˆâ†’3ã¤ã®è³ªå•ã§è§£æ±ºï¼‰

### ğŸ˜µã€Œæ›´æ–°ã—ãŸã®ã«ç”»é¢ãŒå¤‰ã‚ã‚‰ãªã„ï¼ã€

ğŸ‘‰ è³ªå•â‘¢ã§ç¢ºèªï¼š

* â€œãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥è‡ªä½“â€ã‚’æ›´æ–°ã—ãŸã„ï¼Ÿ â†’ `revalidatePath` / `revalidateTag`
* â€œä»Šã®ç”»é¢ã‚’å†å–å¾—ã—ãŸã„ã ã‘â€ï¼Ÿ â†’ `router.refresh()` ([Next.js][1])

### ğŸ˜µã€Œæˆ»ã‚‹ãƒœã‚¿ãƒ³ã§å¤ã„è¡¨ç¤ºã«ãªã‚‹â€¦ã€

ğŸ‘‰ ãã‚Œã€**Router Cacheï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ï¼‰**ã®å½±éŸ¿ã‹ã‚‚ï¼
å¿…è¦ãªã‚‰ `router.refresh()` ã‚’ä½¿ã†åˆ¤æ–­ã‚‚ã‚ã‚‹ã‚ˆğŸ”„ ([Next.js][1])

---

## æœ€å¾Œã®ã¾ã¨ã‚ï¼šã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ğŸ¯âœ¨

è¿·ã£ãŸã‚‰ã€ã“ã®é †ã§è‡ªåˆ†ã«èãã ã‘ï¼ğŸ¥°

1. **èª°ã®ãƒ‡ãƒ¼ã‚¿ï¼Ÿ**ï¼ˆã¿ã‚“ãªåŒã˜ï¼Ÿå€‹äººï¼Ÿï¼‰ğŸ‘¤ğŸŒ
2. **é®®åº¦ã©ã‚Œãã‚‰ã„ï¼Ÿ**ï¼ˆå¸¸ã«ï¼ŸãŸã¾ã«ï¼Ÿã»ã¼å›ºå®šï¼Ÿï¼‰â±ï¸
3. **æ›´æ–°ã‚¹ã‚¤ãƒƒãƒã¯ï¼Ÿ**ï¼ˆæ™‚é–“ï¼Ÿã‚¤ãƒ™ãƒ³ãƒˆï¼Ÿç”»é¢æ›´æ–°ã ã‘ï¼Ÿï¼‰â°ğŸ¯ğŸ”„

ã“ã‚Œã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¿·å­ã€ã‹ãªã‚Šæ¸›ã‚‹ã‚ˆã€œğŸ«¶ğŸ§Šâœ¨

[1]: https://nextjs.org/docs/app/guides/caching "Guides: Caching | Next.js"
[2]: https://nextjs.org/docs/app/getting-started/caching-and-revalidating "Getting Started: Caching and Revalidating | Next.js"
[3]: https://nextjs.org/docs/app/api-reference/functions/fetch "Functions: fetch | Next.js"
