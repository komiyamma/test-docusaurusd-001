# ç¬¬143ç« ï¼šãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã‚µãƒ¼ãƒãƒ¼ã§ã‚‚å¿…é ˆğŸ›¡ï¸

ã€ŒServer Actionsã§ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã§ãã‚‹ãªã‚‰ã€ã‚‚ã†å®‰å¿ƒã§ã—ã‚‡ï¼ŸğŸ˜Œã€
â€¦ã£ã¦æ€ã„ãŒã¡ãªã‚“ã ã‘ã©ã€**ã‚µãƒ¼ãƒãƒ¼å´ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¯çµ¶å¯¾ã«å¿…è¦**ã§ã™â€¼ï¸ğŸ›¡ï¸

ãªãœãªã‚‰ã€ãƒ–ãƒ©ã‚¦ã‚¶ã¯â€œæ­£ç›´è€…â€ã˜ã‚ƒãªã„ã‹ã‚‰â€¦ğŸ˜ˆğŸ’»
ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ã‚’æ”¹é€ ã—ã¦ã€å¤‰ãªå€¤ã‚’é€ã‚‹ã®ã¯ç°¡å˜ã«ã§ãã¡ã‚ƒã†ã‚“ã ã‚ˆã­ï¼‰

---

### ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ğŸ¯âœ¨

* âœ… **ã‚µãƒ¼ãƒãƒ¼å´ã§å…¥åŠ›ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ç†ç”±**ãŒã‚ã‹ã‚‹
* âœ… Server Actionã§**å®‰å…¨ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**ã™ã‚‹å½¢ãŒä½œã‚Œã‚‹
* âœ… **ã‚¨ãƒ©ãƒ¼ã‚’ç”»é¢ã«è¿”ã™**æµã‚ŒãŒã¤ã‹ã‚ã‚‹

---

## 1) ãªã‚“ã§ã‚µãƒ¼ãƒãƒ¼ã§ã‚‚å¿…è¦ãªã®ï¼ŸğŸ¤”ğŸ›¡ï¸

ãŸã¨ãˆã°ã€ŒTODOã®ã‚¿ã‚¤ãƒˆãƒ«ã€ã‚’é€ã‚‹ãƒ•ã‚©ãƒ¼ãƒ ãŒã‚ã‚‹ã¨ã—ã¦â€¦

* ç©ºæ–‡å­—ï¼ˆ""ï¼‰ã‚’é€ã‚‰ã‚Œã‚‹ğŸ˜µ
* 10ä¸‡æ–‡å­—ã¿ãŸã„ãªè¶…é•·æ–‡ã‚’é€ã‚‰ã‚Œã‚‹ğŸ“šğŸ’¥
* å¤‰ãªå‹ï¼ˆæ•°å€¤ã¨ã‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰ã‚’é€ã‚‰ã‚Œã‚‹ğŸ§©ğŸ’£
* ç”»é¢ã‚’é€šã•ãšã€APIã¿ãŸã„ã«ç›´æ¥å©ã‹ã‚Œã‚‹ğŸ¯

ã“ã†ã„ã†ã®ã£ã¦ã€**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å…¥åŠ›æ¬„ã ã‘é ‘å¼µã£ã¦ã‚‚é˜²ã’ã¾ã›ã‚“**ğŸ™…â€â™€ï¸
æœ€çµ‚çš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã£ã¦å‡¦ç†ã™ã‚‹ã®ã¯ã‚µãƒ¼ãƒãƒ¼ãªã®ã§ã€**æœ€å¾Œã®é–€ç•ªã¯ã‚µãƒ¼ãƒãƒ¼**ã§ã™ğŸ§¤ğŸšªâœ¨

---

## 2) å›³è§£ï¼šServer Actionã§ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®æµã‚ŒğŸ“®â¡ï¸ğŸ›¡ï¸â¡ï¸âœ…

![ã‚¤ãƒ¡ãƒ¼ã‚¸å›³](./picture/next_study_143_server_validation.png)

```mermaid
flowchart TD
  A["ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ (#quot;Browser#quot;) ğŸ“¨"] --> B["Server Action å®Ÿè¡Œ ğŸ§‘â€ğŸ³"]
  B --> C{"ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³OK? ğŸ›¡ï¸"}
  C -->|"No"| D["ã‚¨ãƒ©ãƒ¼ã‚’æ•´å½¢ã—ã¦è¿”ã™ ğŸ§¯"]
  C -->|"Yes"| E["DBä¿å­˜ãªã©ã®å‡¦ç† ğŸ—ƒï¸"]
  E --> F["æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ ğŸ‰"]
  D --> G["ç”»é¢ã§ã‚¨ãƒ©ãƒ¼è¡¨ç¤º ğŸ˜¢"]
  F --> H["ç”»é¢ã§æˆåŠŸè¡¨ç¤º ğŸ˜Š"]
```

---

## 3) ãŠã™ã™ã‚ï¼šZodã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã—ã‚ˆã†ğŸ§©âœ¨

Next.jsã®ãƒ•ã‚©ãƒ¼ãƒ ã¯ã€**æ–‡å­—åˆ—ãƒ»å¿…é ˆãƒ»é•·ã•ãƒ»å½¢å¼**ã¿ãŸã„ãªãƒã‚§ãƒƒã‚¯ãŒå¤šã„ã‚ˆã­ğŸ’¡
ãã“ã§ä¾¿åˆ©ãªã®ãŒ **Zod**ï¼ˆå‹ã£ã½ãæ›¸ã‘ã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰ã§ã™âœ¨

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆWindows / PowerShellã§ã‚‚OKï¼‰ğŸªŸğŸ’»

```bash
npm i zod
```

---

## 4) å®Ÿè£…ä¾‹ï¼šTODOè¿½åŠ ã®Server Actionã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å…¥ã‚Œã‚‹â•ğŸ›¡ï¸

### âœ… 4-1. Server Actionï¼ˆã‚µãƒ¼ãƒãƒ¼å´ï¼‰ `app/actions/todo.ts`

* `safeParse` ã§å¤±æ•—ã—ã¦ã‚‚è½ã¡ãªã„ã‚ˆã†ã«ã™ã‚‹ã®ãŒãƒã‚¤ãƒ³ãƒˆğŸ‘
* è¿”ã‚Šå€¤ã‚’ **ã€ŒæˆåŠŸ or å¤±æ•—ã€**ã§æƒãˆã‚‹ã¨ç”»é¢ãŒä½œã‚Šã‚„ã™ã„ã‚ˆâœ¨

```ts
// app/actions/todo.ts
"use server";

import { z } from "zod";

const TodoSchema = z.object({
  title: z
    .string()
    .trim()
    .min(1, "ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã ã‚ˆâœï¸")
    .max(50, "ã‚¿ã‚¤ãƒˆãƒ«ã¯50æ–‡å­—ã¾ã§ã ã‚ˆğŸ“"),
});

export type AddTodoState =
  | { ok: true }
  | { ok: false; fieldErrors: { title?: string[] }; formError?: string };

export async function addTodoAction(
  _prevState: AddTodoState,
  formData: FormData
): Promise<AddTodoState> {
  // FormDataã¯ä½•ãŒå…¥ã£ã¦ãã‚‹ã‹ä¿¡ç”¨ã—ãªã„ï¼ğŸ™…â€â™€ï¸
  const rawTitle = formData.get("title");

  // ã€Œæ–‡å­—åˆ—ã˜ã‚ƒãªã‘ã‚Œã°å³ã‚¨ãƒ©ãƒ¼ã€ã«ã—ã¦ãŠãã¨å®‰å…¨ğŸ›¡ï¸
  if (typeof rawTitle !== "string") {
    return { ok: false, formError: "ä¸æ­£ãªé€ä¿¡ã ã‚ˆğŸ¥²" };
  }

  const parsed = TodoSchema.safeParse({ title: rawTitle });

  if (!parsed.success) {
    return {
      ok: false,
      fieldErrors: parsed.error.flatten().fieldErrors,
    };
  }

  // ã“ã“ã¾ã§æ¥ãŸã‚‰ validated âœ…
  const { title } = parsed.data;

  // æœ¬å½“ã¯ã“ã“ã§DBä¿å­˜ãªã©ã‚’ã™ã‚‹ï¼ˆä¾‹ï¼šPrismaãªã©ï¼‰ğŸ—ƒï¸
  // await db.todo.create({ data: { title } });

  return { ok: true };
}
```

---

### âœ… 4-2. ç”»é¢å´ï¼ˆClient Componentï¼‰ `app/todos/page.tsx`

* `useActionState` ã§ **ã‚¨ãƒ©ãƒ¼ã‚’å—ã‘å–ã£ã¦è¡¨ç¤º**ã§ãã‚‹ã‚ˆğŸ˜Œâœ¨
* ã‚¨ãƒ©ãƒ¼ã¯èµ¤å­—ã«ã—ãªãã¦ã‚‚OKï¼ˆã¾ãšå‡ºã›ã‚Œã°å‹ã¡ï¼ï¼‰ğŸ

```tsx
// app/todos/page.tsx
"use client";

import { useActionState } from "react";
import type { AddTodoState } from "../actions/todo";
import { addTodoAction } from "../actions/todo";

const initialState: AddTodoState = { ok: true };

export default function TodosPage() {
  const [state, formAction, isPending] = useActionState(addTodoAction, initialState);

  const titleErrors = state.ok ? undefined : state.fieldErrors?.title;
  const formError = state.ok ? undefined : state.formError;

  return (
    <main style={{ padding: 16 }}>
      <h1>TODOè¿½åŠ â•</h1>

      <form action={formAction} style={{ display: "grid", gap: 8, maxWidth: 420 }}>
        <label>
          ã‚¿ã‚¤ãƒˆãƒ«âœï¸
          <input
            name="title"
            placeholder="ä¾‹ï¼šãƒ¬ãƒãƒ¼ãƒˆæå‡ºã™ã‚‹ğŸ“š"
            aria-invalid={Boolean(titleErrors?.length)}
            style={{ width: "100%", padding: 8 }}
            disabled={isPending}
          />
        </label>

        {titleErrors?.length ? (
          <ul style={{ margin: 0, paddingLeft: 18 }}>
            {titleErrors.map((msg, i) => (
              <li key={i}>{msg}</li>
            ))}
          </ul>
        ) : null}

        {formError ? <p>{formError}</p> : null}

        <button type="submit" disabled={isPending} style={{ padding: 10 }}>
          {isPending ? "é€ä¿¡ä¸­â€¦â³" : "è¿½åŠ ã™ã‚‹â•"}
        </button>

        {!state.ok ? null : (
          <p style={{ opacity: 0.8 }}>
            â€»æˆåŠŸã—ãŸã‚‰æœ¬å½“ã¯ä¸€è¦§æ›´æ–°ã¨ã‹ã™ã‚‹ã‚ˆğŸ˜Šï¼ˆã“ã“ã§ã¯åœŸå°ã ã‘ï¼ï¼‰
          </p>
        )}
      </form>
    </main>
  );
}
```

---

## 5) ã‚µãƒ¼ãƒãƒ¼ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã€Œæœ€ä½ãƒ©ã‚¤ãƒ³ã€ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆâœ…ğŸ›¡ï¸

ãƒ•ã‚©ãƒ¼ãƒ ã‚’å—ã‘å–ã‚‹Server Actionã«ã¯ã€ã¨ã‚Šã‚ãˆãšã“ã‚Œå…¥ã‚Œã‚‹ã¨å®‰å¿ƒåº¦ã‚¢ãƒƒãƒ—âœ¨

* âœ… **å‹ãƒã‚§ãƒƒã‚¯**ï¼ˆæ–‡å­—åˆ—ï¼Ÿæ•°å€¤ï¼Ÿï¼‰
* âœ… **trim**ï¼ˆå‰å¾Œã®ç©ºç™½ã‚’æ¶ˆã™ï¼‰
* âœ… **å¿…é ˆ**ï¼ˆç©ºã¯ãƒ€ãƒ¡ï¼‰
* âœ… **æœ€å¤§é•·**ï¼ˆé•·ã™ãã‚‹å…¥åŠ›ã‚’é˜²ãï¼‰
* âœ… **å½¢å¼**ï¼ˆãƒ¡ãƒ¼ãƒ«ã€URLãªã©ãŒã‚ã‚‹ãªã‚‰ï¼‰

---

## 6) ãƒŸãƒ‹ç·´ç¿’ğŸ’âœ¨ï¼ˆ5åˆ†ã§OKï¼‰

ä¸Šã®ä¾‹ã‚’ã¡ã‚‡ã„æ”¹é€ ã—ã¦ğŸ‘‡ã‚’è¿½åŠ ã—ã¦ã¿ã¦ã­ğŸ˜†

* ã‚¿ã‚¤ãƒˆãƒ«ãŒ **ã€Œtestã€** ã®ã¨ãã¯å¼¾ãï¼ˆä¾‹ï¼š`refine` ã‚’ä½¿ã†ï¼‰ğŸ™…â€â™€ï¸
* ã‚¨ãƒ©ãƒ¼æ–‡è¨€ã‚’ã‚‚ã†å°‘ã—å„ªã—ãã™ã‚‹ğŸ«¶
* `max(50)` ã‚’ `max(30)` ã«å¤‰ãˆã¦ã€é•·æ–‡ã‚’è©¦ã™ğŸ“

---

ã“ã‚Œã§ã€Œã‚µãƒ¼ãƒãƒ¼ã§ã‚‚ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¿…é ˆğŸ›¡ï¸ã€ã£ã¦æ„Ÿè¦šãŒæ´ã‚ãŸã¯ãšï¼ğŸ˜Šâœ¨
æ¬¡ã¯ã€Œã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã¯ã©ã†ã™ã‚‹ï¼Ÿã€ã£ã¦è©±ã«é€²ã‚€ã¨ã€ã•ã‚‰ã«ä½¿ã„ã‚„ã™ã„ãƒ•ã‚©ãƒ¼ãƒ ã«ãªã‚‹ã‚ˆã€œğŸŒ¸
