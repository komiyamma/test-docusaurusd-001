# ç¬¬81ç« ï¼šãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é‡è¤‡ã‚’æ¸›ã‚‰ã™è€ƒãˆæ–¹ï¼ˆåŒã˜ãƒ‡ãƒ¼ã‚¿ã¯å…±æœ‰ï¼‰ğŸ±

ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ã¯ã“ã‚Œã ã‚ˆã€œï¼ğŸ’¡
**ã€ŒåŒã˜ãƒ‡ãƒ¼ã‚¿ãŒæ¬²ã—ã„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒä½•å€‹ã‚ã£ã¦ã‚‚ã€ãƒ ãƒ€ã«åŒã˜é€šä¿¡ï¼ˆor DBå•ã„åˆã‚ã›ï¼‰ã‚’å¢—ã‚„ã•ãªã„ã€**ã‚ˆã†ã«ã™ã‚‹ã“ã¨ğŸ§ ğŸ’•

---

## 1) ã‚ã‚ŠãŒã¡ãªäº‹æ•…ï¼šåŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’3å›å–ã‚Šã«è¡Œã£ã¦ã‚‹ğŸ˜‡ğŸ“¡ğŸ“¡ğŸ“¡

ãŸã¨ãˆã°ã€ã“ã‚“ãªç”»é¢ğŸ‘‡

* ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã€Œã“ã‚“ã«ã¡ã¯ã€â—¯â—¯ã•ã‚“ã€ğŸ˜Š
* æœ¬æ–‡ã«ã€Œãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã€ğŸ“„
* ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ã€Œã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€âš™ï¸

å…¨éƒ¨ã€ŒåŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã€ãŒå¿…è¦ãªã®ã«ã€å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒãã‚Œãã‚Œ `fetch("/api/me")` ã—ãŸã‚‰â€¦
**åŒã˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä½•å›ã‚‚é£›ã‚“ã˜ã‚ƒã†**ã“ã¨ãŒã‚ã‚‹ã‚ˆã­ã€œğŸ˜­ğŸ’¸ï¼ˆé…ããªã‚‹ãƒ»æ–™é‡‘ã‚„åˆ¶é™ãŒã‚­ãƒ„ã„ãƒ»ãƒ­ã‚°ãŒã†ã‚‹ã•ã„ï¼‰

---

## 2) ã¾ãšçŸ¥ã£ã¦ãŠããŸã„ï¼šNext.jsã«ã¯ã€ŒåŒã˜fetchã¯1å›ã«ã¾ã¨ã‚ã‚‹ã€ä»•çµ„ã¿ãŒã‚ã‚‹ğŸ€

Next.js ã¯ `fetch` ã‚’æ‹¡å¼µã—ã¦ã„ã¦ã€**URLã¨ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒåŒã˜ `fetch` ã‚’è‡ªå‹•ã§ãƒ¡ãƒ¢åŒ–ï¼ˆé‡è¤‡æ’é™¤ï¼‰**ã—ã¦ãã‚Œã‚‹ã‚ˆâœ…
ã ã‹ã‚‰ã€**åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’è¤‡æ•°ç®‡æ‰€ã§ `fetch` ã—ã¦ã‚‚ã€ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­ã¯1å›ã«ã¾ã¨ã¾ã‚‹**ã“ã¨ãŒã‚ã‚‹ã®âœ¨ ([Next.js][1])

ã—ã‹ã‚‚ãƒã‚¤ãƒ³ãƒˆï¼
`{ cache: "no-store" }` ã¿ãŸã„ã« **ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãªã„è¨­å®šã§ã‚‚**ã€ã€Œé‡è¤‡æ’é™¤ï¼ˆãƒ¡ãƒ¢åŒ–ï¼‰ã€è‡ªä½“ã¯åŠ¹ãï¼ˆï¼åŒã˜ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ‘ã‚¹ä¸­ã®äºŒé‡é€šä¿¡ã¯é¿ã‘ã‚‰ã‚Œã‚‹ï¼‰ã‚ˆğŸµ ([Next.js][1])

> ãŸã ã—ã€**URLã‚„optionsãŒã¡ã‚‡ã£ã¨ã§ã‚‚é•ã†ã¨åˆ¥ç‰©æ‰±ã„**ã«ãªã‚‹ã‚ˆâš ï¸ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã€ã‚¯ã‚¨ãƒªã€`next: { revalidate }` ãªã©ã‚‚å«ã‚ã¦ï¼‰

---

## 3) å›³ã§ã¤ã‹ã‚€ï¼šé‡è¤‡ã—ã¦ã‚‹çŠ¶æ…‹ vs å…±æœ‰ã§ãã¦ã‚‹çŠ¶æ…‹ğŸ§©

### âŒ é‡è¤‡ã—ã¦ã‚‹çŠ¶æ…‹ï¼ˆãƒ ãƒ€ãŒç™ºç”Ÿï¼‰ğŸ’¦

```mermaid
flowchart TD
  L["Layout"] --> F1["fetch /api/me"]
  P["Page"] --> F2["fetch /api/me"]
  S["Sidebar"] --> F3["fetch /api/me"]
  F1 --> API["(#quot;API#quot;)"]
  F2 --> API
  F3 --> API
```

### âœ… å…±æœ‰ã§ãã¦ã‚‹çŠ¶æ…‹ï¼ˆ1å›ã§ã¿ã‚“ãªä½¿ã†ï¼‰ğŸ±âœ¨

```mermaid
flowchart TD
  L["Layout"] --> G["getCurrentUser()"]
  P["Page"] --> G
  S["Sidebar"] --> G
  G --> F["fetch /api/me"]
  F --> API["(#quot;API#quot;)"]
  G --> R["åŒã˜çµæœã‚’é…ã‚‹"]
  R --> L
  R --> P
  R --> S
```

![Request Memoization](./picture/next_study_081_request_memoization.png)

---

## 4) å®Ÿæˆ¦ãƒ†ã‚¯ï¼š3ã¤ã®ã€Œé‡è¤‡ã‚’æ¸›ã‚‰ã™ä½œæ³•ã€ğŸŒŸ

### ä½œæ³•Aï¼šãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’ã€Œ1ã¤ã®é–¢æ•°ã€ã«é›†ã‚ã‚‹ğŸ“¦ï¼ˆæœ€é‡è¦ï¼ï¼‰

åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šã«è¡Œãå‡¦ç†ã‚’ã€ã‚ã¡ã“ã¡ã«æ•£ã‚‰ã•ãªã„ã§
`src/lib/` ã« **1æœ¬åŒ–**ã—ã¡ã‚ƒã†ã®ãŒè¶…ãŠã™ã™ã‚ğŸ¥°

### ä½œæ³•Bï¼š`cache()` ã§ã€ŒåŒã˜å¼•æ•°ãªã‚‰åŒã˜çµæœã€ã‚’ä¿è¨¼ã™ã‚‹ğŸª

`fetch` ä»¥å¤–ï¼ˆDB/ORM/SDKï¼‰ã£ã¦ã€Nextã® `fetch` é‡è¤‡æ’é™¤ãŒåŠ¹ã‹ãªã„ã“ã¨ãŒã‚ã‚‹ã®ã­ğŸ˜µ
ãã“ã§ **Reactã® `cache()`** ã‚’ä½¿ã†ã¨ã€**åŒã˜å¼•æ•°ã®å‘¼ã³å‡ºã—ã¯1å›ã«ã¾ã¨ã¾ã‚‹**ã‚ˆâœ¨

### ä½œæ³•Cï¼šã€ŒåŒã˜URL/åŒã˜optionsã€ã‚’å®ˆã‚‹ğŸ§·

åŒã˜ã«è¦‹ãˆã¦ã€åœ°å‘³ã«é•ã†ã¨åˆ¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¤å®šã«ãªã‚‹ã‚ˆâš ï¸
ä¾‹ï¼š

* `?t=${Date.now()}` ã‚’ä»˜ã‘ã¦ã‚‹ğŸ§¨ï¼ˆæ¯å›é•ã†URLã«ãªã‚‹ï¼‰
* `headers` ãŒã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã”ã¨ã«é•ã†ğŸ“®
* `cache`/`next` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒãƒãƒ©ãƒãƒ©ğŸŒ€

---

## 5) ãƒãƒ³ã‚ºã‚ªãƒ³ï¼šãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒšãƒ¼ã‚¸ã§åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å…±æœ‰ã™ã‚‹ğŸ˜ŠğŸª„

### â‘  `src/lib/getUser.ts` ã‚’ä½œã‚‹ğŸ“„

```ts
// src/lib/getUser.ts
import { cache } from "react";

export type User = {
  id: number;
  name: string;
  username: string;
  email: string;
};

// åŒã˜ id ãªã‚‰çµæœï¼ˆPromiseï¼‰ã‚’å…±æœ‰ã—ã¦ãã‚Œã‚‹âœ¨
export const getUser = cache(async (id: number): Promise<User> => {
  console.log("[getUser] fetching...", id); // ã‚µãƒ¼ãƒãƒ¼å´ãƒ­ã‚°ã§å›æ•°ãƒã‚§ãƒƒã‚¯ğŸ‘€

  const res = await fetch(`https://jsonplaceholder.typicode.com/users/${id}`, {
    cache: "no-store", // ä»Šå›ã¯ã€Œæ¯å›æ–°é®®ã€ã ã‘ã©ã€é‡è¤‡æ’é™¤ã¯åŠ¹ãğŸµ
  });

  if (!res.ok) throw new Error("Failed to fetch user");
  return res.json();
});
```

### â‘¡ ãƒ˜ãƒƒãƒ€ãƒ¼ç”¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ `components/UserHello.tsx` ğŸ€

```ts
// components/UserHello.tsx
import { getUser } from "@/lib/getUser";

export default async function UserHello() {
  const user = await getUser(1);

  return (
    <div style={{ padding: 12, borderBottom: "1px solid #ddd" }}>
      ã“ã‚“ã«ã¡ã¯ã€<b>{user.name}</b> ã•ã‚“ ğŸ˜ŠğŸŒ¸
    </div>
  );
}
```

### â‘¢ ãƒšãƒ¼ã‚¸å´ `app/page.tsx` ğŸ“„

```ts
// app/page.tsx
import { getUser } from "@/lib/getUser";

export default async function Page() {
  const user = await getUser(1);

  return (
    <main style={{ padding: 12 }}>
      <h1>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h1>
      <ul>
        <li>name: {user.name}</li>
        <li>username: {user.username}</li>
        <li>email: {user.email}</li>
      </ul>
    </main>
  );
}
```

### â‘£ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¡¨ç¤º `app/layout.tsx` ğŸ§±

```ts
// app/layout.tsx
import type { ReactNode } from "react";
import UserHello from "@/components/UserHello";

export default function RootLayout({ children }: { children: ReactNode }) {
  return (
    <html lang="ja">
      <body>
        <UserHello />
        {children}
      </body>
    </html>
  );
}
```

âœ… ã“ã‚Œã§ã€**ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒšãƒ¼ã‚¸ãŒä¸¡æ–¹ `getUser(1)` ã‚’å‘¼ã‚“ã§ã‚‚**
`cache()` ã®ãŠã‹ã’ã§ **åŒã˜ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­ã¯1å›ã«ã¾ã¨ã¾ã‚Šã‚„ã™ã„**ã‚ˆã€œğŸ±âœ¨

> é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã¯HMRã‚„ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æŒ™å‹•ã®éƒ½åˆã§ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®šãŒæœŸå¾…é€šã‚Šã«è¦‹ãˆãªã„ã“ã¨ã‚‚ã‚ã‚‹ã‚ˆï¼ˆæœ¬ç•ªã¨å®Œå…¨ã«åŒã˜ã§ã¯ãªã„ï¼‰ğŸ‘€ ([Next.js][1])

---

## 6) ã‚ˆãã‚ã‚‹è½ã¨ã—ç©´ï¼ˆã“ã“ã ã‘è¦‹ã¦ï¼ï¼‰âš ï¸ğŸ¥º

* **URLãŒæ¯å›é•ã†**ï¼ˆä¾‹ï¼š`Date.now()`ã€ãƒ©ãƒ³ãƒ€ãƒ ï¼‰ğŸ² â†’ å…±æœ‰ã§ããªã„
* **fetchã®optionsãŒé•ã†**ï¼ˆheaders/next/cacheï¼‰ğŸ§· â†’ åˆ¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ‰±ã„
* **åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’Server Actionã§å–ã‚Šã«è¡Œã£ã¦ã‚‹**ï¼ˆPOSTæ‰±ã„ï¼‰ğŸ“® â†’ é‡è¤‡ã—ã‚„ã™ã„ï¼ˆâ€»èª­ã¿å–ã‚Šã¯åŸºæœ¬ `fetch`/DBç›´ã§ï¼‰
* **ã€Œã¨ã‚Šã‚ãˆãš no-storeã€ä¹±ç”¨**ğŸ”¥ â†’ â€œæ¯å›å–ã‚Šã«è¡Œãâ€ã®ã§ã€å¿…è¦ãªã¨ã“ã‚ã ã‘ã«ã—ã‚ˆã€œï¼ˆã“ã®ç« ã¯ã€Œé‡è¤‡æ’é™¤ã€ãŒä¸»å½¹ï¼ï¼‰

---

## 7) ãƒŸãƒ‹èª²é¡Œï¼ˆ5åˆ†ï¼‰ğŸ§ªğŸ€

1. `components/UserMiniCard.tsx` ã‚’ä½œã£ã¦ã€ã¾ãŸ `getUser(1)` ã‚’å‘¼ã¶
2. `layout.tsx` ã« `<UserMiniCard />` ã‚’è¿½åŠ 
3. ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã®ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã§ **`[getUser] fetching... 1` ãŒå¢—ãˆã™ããªã„**ã‹è¦³å¯ŸğŸ‘€âœ¨

ã§ããŸã‚‰å‹ã¡ã€œï¼ğŸ‰ğŸ‰ğŸ‰

[1]: https://nextjs.org/docs/app/guides/caching "Guides: Caching | Next.js"
