# ç¬¬160ç« ï¼šå¾©ç¿’ï¼šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¯â€œæ¯å›ã¡ã‚‡ã„æ„è­˜â€ãŒæœ€å¼·ğŸ’ª

ã“ã“ã¾ã§æ¥ãŸã‚ãªãŸã€ãˆã‚‰ã™ãã‚‹ã€œï¼ğŸ“ğŸ’•
ã“ã®ç« ã¯ã€Œé›£ã—ã„æŠ€ã€ã˜ã‚ƒãªãã¦ã€**æ¯å›ã¡ã‚‡ã£ã¨ã ã‘æ„è­˜ã—ã¦äº‹æ•…ã‚’é˜²ãç¿’æ…£**ã‚’ã¾ã¨ã‚ã‚‹å›ã ã‚ˆğŸ˜ŠğŸŒ¸

---

## ä»Šæ—¥ã®ã‚´ãƒ¼ãƒ«ğŸ¯âœ¨

* ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ã€Œã‚¤ãƒ™ãƒ³ãƒˆã€ã˜ã‚ƒãªãã€Œç¿’æ…£ã€ã«ã™ã‚‹ğŸ§ ğŸ”
* Next.jsã§ç‰¹ã«äº‹æ•…ã‚Šã‚„ã™ã„ãƒã‚¤ãƒ³ãƒˆã‚’ã€ãƒã‚§ãƒƒã‚¯é …ç›®ã«ã§ãã‚‹âœ…ğŸ“
* â€œä»Šã®è‡ªåˆ†â€ã§ã‚‚ã§ãã‚‹ã€æœ€å°ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’æŒã¡å¸°ã‚‹ğŸ âœ¨

---

## â€œæ¯å›ã¡ã‚‡ã„æ„è­˜â€ã£ã¦ã€ã“ã†ã„ã†ã“ã¨ã ã‚ˆğŸ«¶

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã£ã¦ã€Œå®Œç’§ã€ã‚’ç›®æŒ‡ã™ã¨ã—ã‚“ã©ã„â€¦ğŸ¥²
ã ã‹ã‚‰ãŠã™ã™ã‚ã¯ã“ã‚ŒğŸ‘‡

> **ã€Œä½œã‚‹ãŸã³ã«ã€åŒã˜å°ã•ãªç¢ºèªã‚’ã™ã‚‹ã€**
> â†’ ã“ã‚Œã ã‘ã§äº‹æ•…ç‡ãŒãã£ã¨ä¸‹ãŒã‚‹ã‚ˆğŸ“‰âœ¨

Next.jsã¯Server Componentsã‚„Server Actionsã§ã€Œã‚µãƒ¼ãƒãƒ¼å¯„ã‚Šã€ã«ãªã‚‹ã¶ã‚“ã€**ãƒ‡ãƒ¼ã‚¿ã®æ‰±ã„æ–¹ã®å‰æãŒå¤‰ã‚ã‚‹**ã®ãŒãƒã‚¤ãƒ³ãƒˆã ã‚ˆã€œï¼ğŸ§ŠğŸ”„ ([Next.js][1])

---

## ã¾ãšã¯ã“ã‚Œã ã‘è¦šãˆã¦ğŸ’¡ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®â€œ5ã¤ã®è³ªå•â€ğŸ–ï¸ğŸ›¡ï¸

### â‘  å…¥åŠ›ã¯ä¿¡ç”¨ã—ã¦ãªã„ï¼ŸğŸ§¨

* ãƒ•ã‚©ãƒ¼ãƒ ã€URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€Cookieã€å¤–éƒ¨APIâ€¦ãœã‚“ã¶ã€Œæ€ªã—ã„ã€å‰æğŸ˜ˆ
* **ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**ã™ã‚‹ï¼ˆã“ã“è¶…å¤§äº‹ï¼‰ğŸ›¡ï¸

### â‘¡ è¡¨ç¤ºã§å±ãªã„ã“ã¨ã—ã¦ãªã„ï¼ŸğŸ–¼ï¸

* JSXã¯åŸºæœ¬ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦ãã‚Œã‚‹ã‹ã‚‰å®‰å…¨å¯„ã‚Šâ˜ºï¸
* ã§ã‚‚ **`dangerouslySetInnerHTML` ã¯æœ€çµ‚æ‰‹æ®µ**ã ã‚ˆğŸ™…â€â™€ï¸ğŸ’¥ï¼ˆã‚„ã‚‹ãªã‚‰ã‚µãƒ‹ã‚¿ã‚¤ã‚ºå¿…é ˆï¼‰ ([React][2])

### â‘¢ ã€Œè¦‹ãˆã¦ã„ã„ãƒ‡ãƒ¼ã‚¿ã€ã ã‘è¿”ã—ã¦ã‚‹ï¼ŸğŸ«£

* APIã‚„Server Actionsã§ã€**å¿…è¦ãªã‚‚ã®ã ã‘è¿”ã™**ï¼ˆä¸¸ã”ã¨è¿”ã—ç¦æ­¢ï¼‰ğŸ“¦âœ‚ï¸

### â‘£ æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’â€œã©ã“ã§â€ã‚„ã£ã¦ã‚‹ï¼ŸğŸšª

* Middlewareã¯ä¾¿åˆ©ã ã‘ã©ã€**ãã‚Œã ã‘ã«é ¼ã‚‰ãªã„**ï¼ˆUXã®é–€ç•ªãã‚‰ã„ã«ï¼‰ğŸ§¤
* æœ¬å‘½ã¯ **ãƒ‡ãƒ¼ã‚¿ã«è§¦ã‚Œã‚‹å ´æ‰€ï¼ˆServer Actions / Route Handlers / DBã‚¢ã‚¯ã‚»ã‚¹å±¤ï¼‰ã§æ¯å›ãƒã‚§ãƒƒã‚¯**ğŸ”’ ([Next.js][3])

### â‘¤ ç§˜å¯†ï¼ˆenvï¼‰ã¨ä¾å­˜é–¢ä¿‚ã€æ”¾ç½®ã—ã¦ãªã„ï¼ŸğŸ”ğŸ“¦

* `NEXT_PUBLIC_` ãŒä»˜ãç’°å¢ƒå¤‰æ•°ã¯**ãƒ–ãƒ©ã‚¦ã‚¶ã«å‡ºã‚‹**ï¼ç§˜å¯†ã«ã—ã¡ã‚ƒãƒ€ãƒ¡ğŸ™…â€â™€ï¸ ([Next.js][4])
* ä¾å­˜é–¢ä¿‚ã¯ **`npm audit`** ã§å®šæœŸç‚¹æ¤œğŸ©ºï¼ˆæ”¾ç½®ãŒä¸€ç•ªã“ã‚ã„ï¼‰ ([docs.npmjs.com][5])

---

## å›³è§£ï¼šNext.jsã®â€œå®ˆã‚‹å ´æ‰€â€ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ğŸ›¡ï¸ğŸ§±

![Security Habit](./picture/next_study_160_security_habit.png)

ã€Œã©ã“ã§å®ˆã‚‹ã‹ã€ãŒåˆ†ã‹ã‚‹ã¨è¿·å­ã«ãªã‚‰ãªã„ã‚ˆğŸ˜ŠğŸ—ºï¸

```mermaid
flowchart TD
  U["ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œğŸ§‘â€ğŸ’»"] --> IN["å…¥åŠ›: ãƒ•ã‚©ãƒ¼ãƒ /URL/Cookie"]
  IN --> MW["MiddlewareğŸ§¤<br/>â€»ä¸»ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ/è»½ã„åˆ¤å®š"]
  MW --> R["Route / Page"]
  R --> SA["Server Actions / Route HandlersğŸšª"]
  SA --> VAL["ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ğŸ§¼"]
  VAL --> AUTHZ["èªå¯ãƒã‚§ãƒƒã‚¯ğŸ”‘<br/>ã“ã®äººãŒè§¦ã£ã¦ã„ã„ï¼Ÿ"]
  AUTHZ --> DB["DB/å¤–éƒ¨APIğŸ—ƒï¸ğŸŒ"]
  DB --> OUT["è¿”ã™ãƒ‡ãƒ¼ã‚¿ã‚’æœ€å°åŒ–ğŸ“¦âœ‚ï¸"]
  OUT --> UI["è¡¨ç¤ºï¼ˆXSSæ³¨æ„ï¼‰ğŸ–¼ï¸"]
```

---

## â€œæ¯å›ã¡ã‚‡ã„æ„è­˜â€ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆâœ…ğŸ“ï¼ˆã‚³ãƒ”ãƒšOKï¼‰

é–‹ç™ºã®åŒºåˆ‡ã‚Šï¼ˆæ©Ÿèƒ½1å€‹ã§ããŸæ™‚ï¼‰ã«ã€ã“ã‚Œã ã‘è¦‹ã‚‹ğŸ‘€âœ¨

* [ ] **å…¥åŠ›ã¯ã‚µãƒ¼ãƒãƒ¼ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**ã—ãŸï¼ŸğŸ§¼
* [ ] **èªå¯ï¼ˆã“ã®äººOKï¼Ÿï¼‰ã‚’ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å‰ã«**å…¥ã‚ŒãŸï¼ŸğŸ”‘
* [ ] **`dangerouslySetInnerHTML` ä½¿ã£ã¦ãªã„ï¼Ÿ**ï¼ˆä½¿ã†ãªã‚‰ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼‰ğŸ™…â€â™€ï¸ ([React][2])
* [ ] **è¿”ã™ãƒ‡ãƒ¼ã‚¿ãŒå¤šã™ããªã„ï¼Ÿ**ï¼ˆä¸è¦ãªæƒ…å ±è¿”ã—ã¦ãªã„ï¼Ÿï¼‰ğŸ“¦âœ‚ï¸
* [ ] **`.env.local` ã«ç§˜å¯†ç½®ã„ãŸï¼Ÿ `NEXT_PUBLIC_` ã«ç½®ã„ã¦ãªã„ï¼Ÿ**ğŸ” ([Next.js][4])
* [ ] **CSP/ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼**ã‚’æ„è­˜ã—ãŸï¼ŸğŸ§±ï¼ˆæœ€å°ã§OKï¼‰ ([Next.js][6])
* [ ] **`npm audit`** ã‚’ãŸã¾ã«å›ã—ãŸï¼ŸğŸ©º ([docs.npmjs.com][7])

---

## ãƒŸãƒ‹æ¼”ç¿’ğŸ’»âœ¨ï¼š30ç§’ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç‚¹æ¤œã‚³ãƒãƒ³ãƒ‰ã‚’ä½œã‚ã†ğŸ§ªğŸ€

Windowsã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§OKã ã‚ˆã€œğŸªŸğŸ’•

### â‘  package.json ã« â€œç‚¹æ¤œã‚³ãƒãƒ³ãƒ‰â€ã‚’ç”¨æ„âœ…

ï¼ˆã™ã§ã«ã‚ã£ãŸã‚‰è¿½åŠ ã—ãªãã¦OKï¼ï¼‰

```json
{
  "scripts": {
    "check:security": "npm audit",
    "check:all": "npm run lint && npm run check:security"
  }
}
```

* `npm audit` ã¯ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯ã ã‚ˆğŸ©ºğŸ“¦ ([docs.npmjs.com][5])
* ä½™è£•ãŒå‡ºãŸã‚‰ã€æœˆ1ã§å›ã™ã ã‘ã§ã‚‚ã‹ãªã‚Šé•ã†ğŸ”âœ¨

---

## ãƒŸãƒ‹æ¼”ç¿’ğŸ’»âœ¨ï¼šãƒ˜ãƒƒãƒ€ãƒ¼ã§â€œã‚¬ãƒ¼ãƒ‰æ„Ÿâ€ã‚’å‡ºã™ğŸ§±ğŸ›¡ï¸

Next.jsã¯ `next.config.js` ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ã‘ã‚‰ã‚Œã‚‹ã‚ˆğŸ“¬ ([Next.js][8])
ã•ã‚‰ã«CSPï¼ˆContent Security Policyï¼‰ã‚‚å¤§äº‹ãªé˜²å¾¡ã«ãªã‚‹ã‚ˆğŸ§±âœ¨ ([Next.js][6])

â€»ä¸‹ã¯ã€Œæœ€å°ã®é›°å›²æ°—ã‚µãƒ³ãƒ—ãƒ«ã€ã ã‚ˆï¼ˆã‚¢ãƒ—ãƒªè¦ä»¶ã§èª¿æ•´ã—ã¦ã­ï¼‰ğŸ˜Š

```js
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  async headers() {
    return [
      {
        source: "/(.*)",
        headers: [
          { key: "X-Content-Type-Options", value: "nosniff" },
          { key: "Referrer-Policy", value: "strict-origin-when-cross-origin" },
          { key: "X-Frame-Options", value: "DENY" }
        ],
      },
    ];
  },
};

module.exports = nextConfig;
```

---

## ã‚ˆãã‚ã‚‹â€œã†ã£ã‹ã‚Šäº‹æ•…â€ã‚ã‚‹ã‚ã‚‹ğŸ£ğŸ’¥ï¼ˆå›é¿ãƒ¯ãƒ¼ãƒ‰ä»˜ãï¼‰

* ã€Œ`NEXT_PUBLIC_` ã«APIã‚­ãƒ¼å…¥ã‚Œã¡ã‚ƒã£ãŸğŸ˜‡ã€
  â†’ **ãã‚Œã€ãƒ–ãƒ©ã‚¦ã‚¶ã«å‡ºã‚‹å‰æ**ã ã‚ˆï¼ç§˜å¯†ã¯ã‚µãƒ¼ãƒãƒ¼å´ã®envã¸ğŸ” ([Next.js][4])
* ã€Œèªè¨¼ã—ã¦ã‚‹ã‹ã‚‰OKã§ã—ã‚‡ï¼Ÿã§DBè¿”ã—ã™ãã€
  â†’ **æœ€å°ã®ãƒ‡ãƒ¼ã‚¿ã ã‘è¿”ã™**ï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å…¨éƒ¨è¿”ã•ãªã„ï¼‰ğŸ“¦âœ‚ï¸
* ã€ŒMiddlewareã§å®ˆã£ã¦ã‚‹ã‹ã‚‰å®‰å¿ƒã€
  â†’ **ãƒ‡ãƒ¼ã‚¿ã«è§¦ã‚‹å ´æ‰€ã§ã‚‚èªå¯ãƒã‚§ãƒƒã‚¯**ãŒæœ¬å‘½ã ã‚ˆğŸ”‘ ([Next.js][3])
* ã€Œ`dangerouslySetInnerHTML` ä¾¿åˆ©ã€œï¼ã€
  â†’ åŸå‰‡NGğŸ™…â€â™€ï¸ï¼ˆä½¿ã†ãªã‚‰ä¿¡é ¼ã§ãã‚‹/ã‚µãƒ‹ã‚¿ã‚¤ã‚ºæ¸ˆã¿ã ã‘ï¼‰ ([React][2])

---

## 1åˆ†ã‚¯ã‚¤ã‚ºâ±ï¸ğŸ“âœ¨ï¼ˆç­”ãˆã¯ä¸‹ğŸ‘‡ï¼‰

1. `NEXT_PUBLIC_` ãŒä»˜ãç’°å¢ƒå¤‰æ•°ã¯ã©ã“ã§èª­ã‚ã‚‹ï¼ŸğŸŒ
2. `dangerouslySetInnerHTML` ãŒå±ãªã„ç†ç”±ã¯ï¼ŸğŸ§¨
3. æ¨©é™ãƒã‚§ãƒƒã‚¯ã¯ã€Œã©ã“ã§ã‚„ã‚‹ã€ã®ãŒä¸€ç•ªå¤§äº‹ï¼ŸğŸ”‘

**ç­”ãˆğŸ€**

1. ãƒ–ãƒ©ã‚¦ã‚¶å´ã«ã‚‚ãƒãƒ³ãƒ‰ãƒ«ã•ã‚Œå¾—ã‚‹ï¼ç§˜å¯†ã¯ç½®ã„ã¡ã‚ƒãƒ€ãƒ¡ã ã‚ˆğŸ” ([Next.js][4])
2. HTMLã‚’ãã®ã¾ã¾æ³¨å…¥ã§ãã¦ã€XSSã®å…¥å£ã«ãªã‚Šã‚„ã™ã„ã‹ã‚‰ã ã‚ˆğŸ§¨ ([React][2])
3. **ãƒ‡ãƒ¼ã‚¿ã«è§¦ã‚Œã‚‹ç›´å‰ï¼ˆServer Actions / Route Handlers / DBã‚¢ã‚¯ã‚»ã‚¹ï¼‰**ãŒæœ€é‡è¦ã ã‚ˆğŸ”’ ([Next.js][3])

---

## ä»Šæ—¥ã®ã¾ã¨ã‚ğŸâœ¨

* ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¯ã€Œä¸€æ’ƒå¿…æ®ºã€ã˜ã‚ƒãªãã¦ **å°ã•ã„ç¢ºèªã®ç©ã¿é‡ã­**ğŸ”ğŸ›¡ï¸
* Next.jsã¯ã‚µãƒ¼ãƒãƒ¼å¯„ã‚Šã ã‹ã‚‰ã“ãã€**ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å‰ã®èªå¯ï¼†ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**ãŒè¶…å¤§äº‹ğŸ”‘ğŸ§¼ ([Next.js][1])
* è¿·ã£ãŸã‚‰ã“ã®åˆè¨€è‘‰ğŸ‘‡
  **ã€Œå…¥åŠ›ã¯ç–‘ã†ãƒ»å‡ºåŠ›ã¯æ…é‡ãƒ»ç§˜å¯†ã¯å‡ºã•ãªã„ãƒ»ä¾å­˜ã¯ç‚¹æ¤œã€**ğŸ’ªâœ¨

[1]: https://nextjs.org/docs/app/guides/data-security?utm_source=chatgpt.com "Guides: Data Security"
[2]: https://react.dev/reference/react-dom/components/common?utm_source=chatgpt.com "Common components (e.g. <div>)"
[3]: https://nextjs.org/docs/app/guides/authentication?utm_source=chatgpt.com "Guides: Authentication"
[4]: https://nextjs.org/docs/pages/guides/environment-variables?utm_source=chatgpt.com "Guides: Environment Variables"
[5]: https://docs.npmjs.com/auditing-package-dependencies-for-security-vulnerabilities/?utm_source=chatgpt.com "Auditing package dependencies for security vulnerabilities"
[6]: https://nextjs.org/docs/app/guides/content-security-policy?utm_source=chatgpt.com "Guides: Content Security Policy"
[7]: https://docs.npmjs.com/cli/v9/commands/npm-audit?utm_source=chatgpt.com "npm-audit"
[8]: https://nextjs.org/docs/app/api-reference/config/next-config-js/headers?utm_source=chatgpt.com "next.config.js: headers"
