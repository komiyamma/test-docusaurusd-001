# ç¬¬116ç« ï¼šAPIã‚’â€œä½œã‚Šã™ããªã„â€æ–¹é‡ï¼ˆServer Actionsã¨ã‚‚æ¯”è¼ƒï¼‰âš–ï¸

ã€ŒNext.jsã§ã‚¢ãƒ—ãƒªå†…APIï¼ˆRoute Handlersï¼‰ä½œã‚Œã‚‹ã®åˆ†ã‹ã£ãŸï¼â€¦ã§ã‚‚ã€ã“ã‚Œå…¨éƒ¨APIã«ã—ãŸæ–¹ãŒã„ã„ã®ï¼ŸğŸ¤”ã€
â†’ **çµè«–ï¼šä½œã‚Šã™ããªã„ã®ãŒæ­£ç¾©**ã§ã™ğŸ™†â€â™€ï¸âœ¨
APIã¯ä¾¿åˆ©ã ã‘ã©ã€å¢—ãˆã‚‹ã»ã© **ä¿å®ˆãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»å‹ç®¡ç†**ãŒã—ã‚“ã©ããªã‚‹ã‚“ã ã‚ˆã­â€¦ğŸ¥¹ğŸ’¦

---

## ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ğŸ¯

* **Route Handlerï¼ˆ`app/api/.../route.ts`ï¼‰ã‚’ä½œã‚‹ã¹ãå ´é¢**ãŒåˆ†ã‹ã‚‹ğŸšª
* **Server Actionsï¼ˆ= React Server Functionsï¼‰ã§ååˆ†ãªå ´é¢**ãŒåˆ†ã‹ã‚‹ğŸ§‘â€ğŸ³
* ã€Œè¿·ã£ãŸã¨ãã®åˆ¤æ–­ãƒ«ãƒ¼ãƒ«ã€ãŒæ‰‹ã«å…¥ã‚‹ğŸ§­âœ¨

---

## ãã‚‚ãã‚‚ï¼šAPIã‚’å¢—ã‚„ã™ã¨ä½•ãŒå¢—ãˆã‚‹ï¼ŸğŸ“ˆğŸ˜µ

APIï¼ˆRoute Handlerï¼‰ã‚’1å€‹ä½œã‚‹ãŸã³ã«ã€ã ã„ãŸã„ã“ã†ã„ã†â€œå®¿é¡Œâ€ãŒå¢—ãˆã¾ã™ğŸ‘‡

* å…¥åŠ›ãƒã‚§ãƒƒã‚¯ï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ğŸ›¡ï¸
* èªè¨¼ãƒ»èªå¯ï¼ˆèª°ãŒå©ã‘ã‚‹ï¼Ÿï¼‰ğŸ”
* ã‚¨ãƒ©ãƒ¼å½¢å¼ã®çµ±ä¸€ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆãŒå›°ã‚‹ï¼‰ğŸ§¯
* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰è¨­è¨ˆï¼ˆ200/400/500â€¦ï¼‰ğŸš¦
* å‹ã®å…±æœ‰ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã¨ã‚ºãƒ¬ã‚‹ã¨åœ°ç„ï¼‰ğŸ§·
* CORSã‚„Webhookå¯¾å¿œï¼ˆå¿…è¦ãªã‚‰ï¼‰ğŸŒğŸ””
* ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–ï¼ˆå°†æ¥ã®è‡ªåˆ†ã«èª¬æ˜ï¼‰ğŸ“

ã‚‚ã¡ã‚ã‚“å¿…è¦ãªã‚‰ã‚„ã‚‹ã‘ã©ã€**å†…éƒ¨ã®ç”»é¢ã ã‘ã§ä½¿ã†å‡¦ç†ã¾ã§å…¨éƒ¨APIã«ã™ã‚‹ã¨ã€è² å‚µãŒå¢—ãˆãŒã¡**ã§ã™ğŸ’¸ğŸ˜‡

---

## Server Actionsï¼ˆServer Functionsï¼‰ã£ã¦ä½•ãŒã†ã‚Œã—ã„ã®ï¼ŸğŸª„

Next.jsã§ã¯ã€ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚’ **Reactã®Server Functionsï¼ˆServer Actionsï¼‰** ã§ã‚„ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã¾ã™ã€‚
Server Actionã¯ **ã‚µãƒ¼ãƒãƒ¼ã§å‹•ãasyncé–¢æ•°**ã§ã€`'use server'` ã§å®šç¾©ã—ã¾ã™ã€‚å‘¼ã³å‡ºã—ã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çµŒç”±ãªã®ã§asyncå¿…é ˆã€ãã—ã¦è£å´ã¯ **POSTã§å®Ÿè¡Œã•ã‚Œã‚‹**ã®ãŒãƒã‚¤ãƒ³ãƒˆã ã‚ˆã€œğŸ“®âœ¨ ([Next.js][1])

ã•ã‚‰ã«Next.jsã§ã¯ã€ActionãŒå‹•ã„ãŸã‚ã¨ **UIã¨æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’ã¾ã¨ã‚ã¦è¿”ã›ã‚‹**ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­è¨ˆã¨çµ±åˆã•ã‚Œã¦ã‚‹ï¼‰ã®ã§ã€ãƒ•ãƒ­ãƒ³ãƒˆãŒãƒ©ã‚¯ã«ãªã‚ŠãŒã¡ã§ã™ğŸ«¶ ([Next.js][1])
ï¼ˆãã—ã¦Server Actionsã¯Next.js 14ã§å®‰å®šæ©Ÿèƒ½ã«ãªã£ã¦ã€åŸºæœ¬ONã§ã™âœ…ï¼‰ ([Next.js][2])

---

## Route Handlersï¼ˆAPIï¼‰ã¯ã©ã‚“ãªæ™‚ã«å¿…è¦ï¼ŸğŸšªğŸ“¡

Route Handlerã¯ `route.ts` ã« **HTTPãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆGET/POST/PUTâ€¦ï¼‰** ã‚’æ›¸ã‘ã¦ã€Request/Responseã‚’ç›´æ¥æ‰±ãˆã‚‹ã®ãŒå¼·ã¿ï¼([Next.js][3])
CORSã‚„Webhookå—ä¿¡ã¿ãŸã„ãªã€ŒHTTPã£ã½ã„ã“ã¨ã€ã‚‚å¾—æ„ã§ã™ğŸŒğŸ”” ([Next.js][3])

---

## ä½¿ã„åˆ†ã‘ã®è¶…ã–ã£ãã‚Šçµè«–âš–ï¸âœ¨

### âœ… Server Actions ã‚’é¸ã³ã‚„ã™ã„å ´é¢ğŸ§‘â€ğŸ³

* **è‡ªåˆ†ã®Next.jsã‚¢ãƒ—ãƒªã®UIã‹ã‚‰ã—ã‹å‘¼ã°ãªã„**ï¼ˆå†…éƒ¨å°‚ç”¨ï¼‰ğŸ 
* **ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒ»ãƒœã‚¿ãƒ³æ“ä½œã§DBæ›´æ–°**ã¿ãŸã„ãªâ€œç”»é¢ã®å»¶é•·â€ğŸ§¾â¡ï¸ğŸ—ƒï¸
* **å‹ã‚’è‡ªç„¶ã«æƒãˆãŸã„**ï¼ˆé–¢æ•°ã®å¼•æ•°ãƒ»æˆ»ã‚Šå€¤ã§æƒã†ï¼‰ğŸ§·
* ç„¡é§„ãª `fetch('/api/...')` ã‚’æ¸›ã‚‰ã—ã¦ã‚¹ãƒƒã‚­ãƒªã—ãŸã„ğŸ§¼âœ¨

### âœ… Route Handlersï¼ˆAPIï¼‰ã‚’é¸ã¶ã¹ãå ´é¢ğŸšªğŸ“¡

* **å¤–éƒ¨ã‚¢ãƒ—ãƒªï¼ˆãƒ¢ãƒã‚¤ãƒ«/åˆ¥ã‚µãƒ¼ãƒ“ã‚¹ï¼‰ã«ã‚‚å…¬é–‹ã™ã‚‹API**ğŸ“±ğŸŒ
* **Webhookã®å—ã‘å£ãŒå¿…è¦**ğŸ”” ([Next.js][3])
* **CORSãŒå¿…è¦**ï¼ˆåˆ¥ã‚ªãƒªã‚¸ãƒ³ã‹ã‚‰å©ã‹ã‚Œã‚‹ï¼‰ğŸŒ ([Next.js][3])
* **GETã§æä¾›ã—ãŸã„**ï¼ˆServer Actionsã¯å‘¼ã³å‡ºã—ãŒåŸºæœ¬POSTï¼‰ğŸ“¤ ([Next.js][1])
* **HTTPã®ç´°ã‹ã„åˆ¶å¾¡ãŒå¿…è¦**ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹/ãƒ˜ãƒƒãƒ€ãƒ¼/ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ç­‰ï¼‰ğŸ§ª ([Next.js][3])

---

## åˆ¤æ–­ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆğŸ§­ï¼ˆè¿·ã£ãŸã‚‰ã“ã‚Œï¼ï¼‰

![åˆ¤æ–­ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ](./picture/next_study_116_actions_vs_handlers.png)

```mermaid
flowchart TD
  A["ã‚„ã‚ŠãŸã„å‡¦ç†"] --> B{"å¤–éƒ¨(#quot;åˆ¥ã‚¢ãƒ—ãƒª/ä»–ã‚µãƒ¼ãƒ“ã‚¹#quot;)ã‹ã‚‰å©ãï¼Ÿ"}
  B -->|"Yes"| RH["Route Handler(#quot;API#quot;)ã«ã™ã‚‹ğŸšªğŸ“¡"]
  B -->|"No"| C{"Webhook / CORS / GETãªã©<br>HTTPéƒ½åˆãŒå¼·ã„ï¼Ÿ"}
  C -->|"Yes"| RH
  C -->|"No"| SA["Server Actionã«ã™ã‚‹ğŸ§‘â€ğŸ³âœ¨"]
  RH --> D["APIã¯ã€Œå¢ƒç•Œã€ğŸ§±<br>èªè¨¼/æ¤œè¨¼/ã‚¨ãƒ©ãƒ¼å½¢å¼ã‚’ä¸å¯§ã«"]
  SA --> E["UIã‹ã‚‰ç›´æ¥å‘¼ã¶æ„Ÿè¦šğŸ«¶<br>å‹ãƒ»å¾€å¾©ãƒ»å®Ÿè£…ãŒã‚·ãƒ³ãƒ—ãƒ«"]
```

---

## ã‚¤ãƒ¡ãƒ¼ã‚¸å›³ï¼šå‘¼ã³å‡ºã—ã®é•ã„ğŸ‘€âœ¨

```mermaid
flowchart LR
  subgraph SA["Server Actions ğŸ§‘â€ğŸ³"]
    UI1["UI"] -->|"form action / formAction"| SF["Server Function"]
    SF --> DB1["(#quot;DB/å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹#quot;)"]
    SF --> UI1
  end

  subgraph RH["Route Handlers ğŸšª"]
    UI2["UI"] -->|"fetch"| API["/app/api/.../route.ts/"]
    API --> DB2["(#quot;DB/å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹#quot;)"]
    API -->|"JSON"| UI2
  end
```

---

## ãƒŸãƒ‹ä¾‹ï¼šå†…éƒ¨ã ã‘ã®ã€ŒTODOè¿½åŠ ã€ã¯Server Actionã§ååˆ†ğŸ’¡ğŸ«¶

### âœ… Server Actionï¼ˆå†…éƒ¨å°‚ç”¨ã®è¿½åŠ å‡¦ç†ï¼‰

```ts
// app/todos/actions.ts
export async function addTodo(formData: FormData) {
  'use server'

  const title = String(formData.get('title') ?? '').trim()
  if (!title) {
    return { ok: false, message: 'ã‚¿ã‚¤ãƒˆãƒ«å…¥ã‚Œã¦ã­ğŸ™‚' }
  }

  // ã“ã“ã§DBè¿½åŠ ï¼ˆä¾‹ï¼‰
  // await db.todo.create({ data: { title } })

  // ç”»é¢ã®å†å–å¾—ï¼ˆå¿…è¦ãªã‚‰ï¼‰
  // revalidatePath('/todos')

  return { ok: true }
}
```

### âœ… ãƒšãƒ¼ã‚¸å´ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ç›´ã§å‘¼ã¶ï¼‰

```tsx
// app/todos/page.tsx
import { addTodo } from './actions'

export default function TodosPage() {
  return (
    <main>
      <h1>TODO</h1>

      <form action={addTodo}>
        <input name="title" placeholder="ã‚„ã‚‹ã“ã¨" />
        <button type="submit">è¿½åŠ â•</button>
      </form>
    </main>
  )
}
```

ã“ã®å½¢ã ã¨ã€**ã‚ã–ã‚ã– `/api/todos` ã‚’ä½œã£ã¦ fetch ã—ã¦â€¦**ã£ã¦ã„ã†å›ã‚Šé“ãŒæ¸›ã‚‹ã‚ˆã€œğŸ¥³âœ¨
ï¼ˆã‚‚ã¡ã‚ã‚“ã€Œå¤–éƒ¨ã«ã‚‚å…¬é–‹ã™ã‚‹ã€ãªã‚‰APIã«ã™ã‚‹ã®ãŒæ­£è§£ï¼ï¼‰

---

## ã‚ã‚ŠãŒã¡ãªè½ã¨ã—ç©´âš ï¸ğŸ˜µâ€ğŸ’«

* ã€Œã¨ã‚Šã‚ãˆãšå…¨éƒ¨APIã«ã—ã‚ˆï¼ã€â†’ **å¢ƒç•Œã ã‚‰ã‘ã«ãªã£ã¦ç®¡ç†ã‚³ã‚¹ãƒˆçˆ†å¢—**ğŸ’¥
* ã€ŒAPIä½œã£ãŸã®ã«ã€çµå±€ã‚¢ãƒ—ãƒªå†…ã‹ã‚‰ã—ã‹å©ã„ã¦ãªã„ã€â†’ **Server Actionã§ã‚ˆã‹ã£ãŸæ¡ˆä»¶**ğŸ¥¹
* ã€Œå¤–éƒ¨å…¬é–‹ãªã®ã«Server Actionã§æ¸ˆã¾ã›ã‚ˆã†ã¨ã™ã‚‹ã€â†’ **CORS/Webhook/ä»•æ§˜å…¬é–‹ãŒè‹¦ã—ããªã‚‹**ğŸŒªï¸

---

## ã¾ã¨ã‚ğŸ§âœ¨ï¼ˆã“ã®ç« ã®çµè«–ï¼‰

* **å†…éƒ¨UIã®æ›´æ–°**ã¯ã€ã¾ãš **Server Actionsï¼ˆServer Functionsï¼‰** ã‚’ç¬¬ä¸€å€™è£œã«ğŸ§‘â€ğŸ³ ([Next.js][1])
* **å¤–éƒ¨ã«å…¬é–‹ã™ã‚‹/HTTPéƒ½åˆãŒå¼·ã„**ãªã‚‰ **Route Handlersï¼ˆAPIï¼‰** ğŸšª ([Next.js][3])
* APIã¯ä¾¿åˆ©ã ã‘ã©ã€**å¢—ã‚„ã™ã»ã©â€œå¢ƒç•Œã®å®¿é¡Œâ€ãŒå¢—ãˆã‚‹**ã®ã§ã€å¿…è¦ãªã¨ãã ã‘ä½œã‚ã†ã­ğŸ«¶âœ¨

[1]: https://nextjs.org/docs/app/getting-started/updating-data "Getting Started: Updating Data | Next.js"
[2]: https://nextjs.org/docs/app/api-reference/config/next-config-js/serverActions "next.config.js: serverActions | Next.js"
[3]: https://nextjs.org/docs/app/api-reference/file-conventions/route "File-system conventions: route.js | Next.js"
