# ç¬¬95ç« ï¼šã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ï¼šé€šä¿¡/ã‚³ãƒ¼ãƒ‰/æƒ³å®šå¤–ã‚’åˆ†ã‘ã‚‹ğŸ§¯

ã‚¢ãƒ—ãƒªã§ã€Œã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸï¼ã€ã£ã¦æ™‚ã€ãœã‚“ã¶åŒã˜æ‰±ã„ã«ã™ã‚‹ã¨â€¦
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å‡ºã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚ã€ç›´ã—æ–¹ã‚‚ã€ãƒ­ã‚°ã®æ®‹ã—æ–¹ã‚‚ã‚´ãƒãƒ£ã‚´ãƒãƒ£ã«ãªã‚ŠãŒã¡ğŸ˜µâ€ğŸ’«ğŸ’¦

ãªã®ã§ä»Šæ—¥ã¯ **ã‚¨ãƒ©ãƒ¼ã‚’3ç¨®é¡ã«åˆ†ã‘ã‚‹** ç·´ç¿’ã‚’ã™ã‚‹ã‚ˆã€œï¼ğŸ§ ğŸ«¶

---

## ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ğŸ¯

* ã‚¨ãƒ©ãƒ¼ã‚’ **é€šä¿¡ï¼ˆå¤–ã®éƒ½åˆï¼‰ / ã‚³ãƒ¼ãƒ‰ï¼ˆè‡ªåˆ†ã®ãƒã‚°ï¼‰ / æƒ³å®šå¤–ï¼ˆã©ã£ã¡ã‹åˆ†ã‹ã‚‰ã‚“ï¼‰** ã«åˆ†ã‘ã‚‰ã‚Œã‚‹âœ¨
* ã€Œä»Šã¯ä½•ã‚’ã™ã¹ãï¼Ÿã€ãŒè¿·ã‚ãªããªã‚‹ï¼ˆå†è©¦è¡Œï¼Ÿãƒã‚°ä¿®æ­£ï¼Ÿãƒ­ã‚°ï¼Ÿï¼‰ğŸ”ğŸ› ï¸ğŸ“

---

## ã¾ãšã¯çµè«–ï¼šã‚¨ãƒ©ãƒ¼ã¯3ç¨®é¡ã§è€ƒãˆã‚‹ğŸ§©

### â‘  é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç³»ï¼‰ğŸ“¡âš¡

ã€Œå¤–ã¨ã®ã‚„ã‚Šå–ã‚Šã€ãŒã†ã¾ãã„ã‹ãªã„ã‚„ã¤ï¼

* ã‚µãƒ¼ãƒãƒ¼ã«ç¹‹ãŒã‚‰ãªã„ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã€DNSã€ãƒãƒ¼ãƒˆé•ã„ï¼‰ğŸ“´
* ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆâ³
* CORSãªã©ï¼ˆä¸»ã«ãƒ–ãƒ©ã‚¦ã‚¶å´ï¼‰ğŸš§
* `fetch` ãŒ **ä¾‹å¤–ï¼ˆthrowï¼‰** ã‚’å‡ºã™ã‚¿ã‚¤ãƒ—ãŒå¤šã„

âœ… å¯¾å¿œã®æ–¹å‘æ€§ï¼š
**â€œå†è©¦è¡Œâ€ ã¨ â€œå„ªã—ã„æ¡ˆå†…â€** ãŒå¼·ã„ğŸ’ªâœ¨
ï¼ˆã€Œé€šä¿¡ãŒä¸å®‰å®šã‹ã‚‚ã€‚ã‚‚ã†ä¸€å›ãŸã‚ã—ã¦ã­ğŸ™ã€ã¿ãŸã„ã«ï¼‰

---

### â‘¡ ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ï¼ˆãƒã‚°ï¼‰ğŸ›ğŸ’¥

ã€Œè‡ªåˆ†ã®ã‚³ãƒ¼ãƒ‰ã€ãŒåŸå› ã§è½ã¡ã‚‹ã‚„ã¤ï¼

* `undefined` ã« `.map()` ã—ã¡ã‚ƒã£ãŸğŸ˜‡
* nullãƒã‚§ãƒƒã‚¯å¿˜ã‚ŒãŸ
* å‹ãƒ»ãƒ­ã‚¸ãƒƒã‚¯ãƒŸã‚¹
* ã‚µãƒ¼ãƒãƒ¼/ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã©ã£ã¡ã§ã‚‚èµ·ã“ã‚‹

âœ… å¯¾å¿œã®æ–¹å‘æ€§ï¼š
**ç›´ã™ã®ãŒæœ¬ç­‹** ğŸ› ï¸ï¼ˆã§ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯â€œè½ã¡ãªã„ç”»é¢â€ã‚‚ç”¨æ„ã™ã‚‹ï¼‰ğŸ§¯

---

### â‘¢ æƒ³å®šå¤–ã‚¨ãƒ©ãƒ¼ï¼ˆåˆ†é¡ã§ããªã„/ãƒ¬ã‚¢ã‚±ãƒ¼ã‚¹ï¼‰ğŸ²ğŸŒªï¸

ã€Œãˆã€ãã‚“ãªã“ã¨ã‚ã‚‹ï¼Ÿã€ã£ã¦ã‚„ã¤ï¼

* ãŸã¾ã«ã ã‘èµ·ã“ã‚‹
* å¤–éƒ¨APIã®è¿”ã™JSONå½¢ãŒæ€¥ã«å¤‰ã‚ã£ãŸğŸ“¦
* ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå†…éƒ¨ã®ä¾‹å¤–
* ã“ã¡ã‚‰ã®æƒ³å®šæ¼ã‚Œ

âœ… å¯¾å¿œã®æ–¹å‘æ€§ï¼š
**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯å®‰å…¨ãªè¡¨ç¤º** ï¼‹ **ãƒ­ã‚°ã‚’æ®‹ã™** ğŸ“ğŸ”’
ï¼ˆåŸå› èª¿æŸ»ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã®ãŒè¶…å¤§äº‹ï¼ï¼‰

---

## å›³ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å›ºã‚ã‚ˆã†ğŸ“Œï¼ˆã‚¨ãƒ©ãƒ¼ã®åˆ†å²ï¼‰

![Error Types](./picture/next_study_095_error_types.png)

```mermaid
flowchart TD
  A["ãƒ‡ãƒ¼ã‚¿å–å¾— fetch"] --> B{"çµæœã©ã†ã ã£ãŸï¼Ÿ"}
  B -->|"é€šä¿¡ã§ããšä¾‹å¤–"| N["é€šä¿¡ã‚¨ãƒ©ãƒ¼ğŸ“¡: å†è©¦è¡Œ/æ¡ˆå†…"]
  B -->|"é€šä¿¡ã¯ã§ããŸãŒ res.ok=false"| H["APIã‚¨ãƒ©ãƒ¼ğŸš¦: 404/500ãªã©<br/>ï¼é€šä¿¡ã˜ã‚ƒãªãã€Œå¿œç­”ã‚¨ãƒ©ãƒ¼ã€"]
  B -->|"å–å¾—å¾Œã®å‡¦ç†ã§ä¾‹å¤–"| C["ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ğŸ›: ãƒã‚°ä¿®æ­£ãŒæœ¬å‘½"]
  B -->|"åŸå› ä¸æ˜/ãƒ¬ã‚¢"| U["æƒ³å®šå¤–ğŸ²: é€€é¿UI + ãƒ­ã‚°"]
```

ãƒã‚¤ãƒ³ãƒˆğŸ’¡
**ã€Œé€šä¿¡ã‚¨ãƒ©ãƒ¼ã€ã¨ã€ŒHTTPã‚¨ãƒ©ãƒ¼ï¼ˆ404/500ï¼‰ã€ã¯åˆ¥ç‰©**ã«ãªã‚Šã‚„ã™ã„ã‚ˆï¼

* é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼šãã‚‚ãã‚‚å±Šã„ã¦ãªã„ğŸ“´
* HTTPã‚¨ãƒ©ãƒ¼ï¼šå±Šã„ãŸã‘ã©ã€ŒçµæœãŒã‚¨ãƒ©ãƒ¼ã€ğŸš¦

---

## ã‚ã‚ŠãŒã¡è½ã¨ã—ç©´ï¼š`fetch` ã¯ 404/500 ã§ã¯æŠ•ã’ãªã„ğŸ™…â€â™€ï¸

Next.js/Nodeã® `fetch` ã¯ã€**404ã‚„500ã§ã‚‚åŸºæœ¬ã¯æˆåŠŸæ‰±ã„ï¼ˆä¾‹å¤–ã˜ã‚ƒãªã„ï¼‰** ã§ `Response` ãŒè¿”ã‚‹ã‚ˆã€œğŸ˜³
ã ã‹ã‚‰ **`res.ok` ã‚’å¿…ãšè¦‹ã‚‹**ã®ãŒå¤§äº‹âœ¨

---

## å®Ÿæˆ¦ï¼šã‚¨ãƒ©ãƒ¼ã‚’3ç¨®é¡ã«â€œã‚¿ã‚°ä»˜ã‘â€ã—ã¦æ‰±ã†ğŸ·ï¸ğŸ§ 

ã“ã“ã§ã¯ã€Œåˆ†é¡ã—ã¦æŠ•ã’ç›´ã™ã€ã ã‘ã‚„ã£ã¦ã¿ã‚ˆã€œï¼
ï¼ˆè¡¨ç¤ºã®ä»•ä¸Šã’ã¯ã€ã“ã®å…ˆã§ `error.tsx` ãªã©ã«ç¹‹ãŒã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ğŸ«¶ï¼‰

### 1) ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥ã‚’ä½œã‚‹ï¼ˆè¶…ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰âœ¨

```ts
// lib/errors.ts
export type AppErrorKind = "network" | "http" | "code" | "unknown";

export class AppError extends Error {
  constructor(
    public kind: AppErrorKind,
    message: string,
    public status?: number
  ) {
    super(message);
    this.name = "AppError";
  }
}
```

### 2) `fetch` ã‚’åŒ…ã‚€é–¢æ•°ï¼ˆé€šä¿¡/HTTP ã‚’åˆ†ã‘ã‚‹ï¼‰ğŸ“¦

```ts
// lib/fetchJson.ts
import { AppError } from "./errors";

export async function fetchJson<T>(url: string): Promise<T> {
  let res: Response;

  // âœ… é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼ˆä¾‹å¤–ã«ãªã‚‹ã“ã¨ãŒå¤šã„ï¼‰
  try {
    res = await fetch(url, { cache: "no-store" });
  } catch (e) {
    throw new AppError("network", "é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸğŸ“¡ ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã­ï¼");
  }

  // âœ… HTTPã‚¨ãƒ©ãƒ¼ï¼ˆ404/500ãªã©ï¼šres.okã§åˆ¤å®šï¼‰
  if (!res.ok) {
    throw new AppError(
      "http",
      `ã‚µãƒ¼ãƒãƒ¼ãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¾ã—ãŸğŸš¦ (${res.status})`,
      res.status
    );
  }

  // âœ… JSONãƒ‘ãƒ¼ã‚¹å¤±æ•—ãªã©ï¼ˆæƒ³å®šå¤–å¯„ã‚Šï¼‰
  try {
    return (await res.json()) as T;
  } catch (e) {
    throw new AppError("unknown", "ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæƒ³å®šã¨é•ã†ã¿ãŸã„ğŸ“¦ğŸ’¦");
  }
}
```

ã“ã“ã§ã‚„ã£ã¦ã‚‹ã“ã¨ã¯è¶…é‡è¦ğŸ‘

* **é€šä¿¡ã§ããªã„** â†’ `"network"`
* **é€šä¿¡ã¯ã§ããŸãŒå¤±æ•—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹** â†’ `"http"`
* **ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å½¢ãŒå¤‰** â†’ `"unknown"`

---

## ãƒŸãƒ‹ç·´ç¿’ï¼šã‚ã–ã¨3ç¨®é¡ã‚’èµ·ã“ã—ã¦â€œåˆ†é¡ã§ããŸï¼â€ã‚’ä½“é¨“ğŸ”¬âœ¨

### æ‰‹é †Aï¼šãƒ†ã‚¹ãƒˆç”¨APIã‚’ä½œã‚‹ğŸ§ª

`app/api/demo/route.ts` ã‚’ä½œã£ã¦ã­ğŸ‘‡

```ts
// app/api/demo/route.ts
import { NextResponse } from "next/server";

export async function GET(req: Request) {
  const { searchParams } = new URL(req.url);
  const mode = searchParams.get("mode");

  if (mode === "500") {
    return NextResponse.json({ message: "ã‚ã–ã¨500ï¼" }, { status: 500 });
  }

  if (mode === "badjson") {
    // JSONã˜ã‚ƒãªã„ã‚‚ã®ã‚’è¿”ã™ï¼ˆãƒ‘ãƒ¼ã‚¹å¤±æ•—ç”¨ï¼‰
    return new Response("not json", {
      status: 200,
      headers: { "content-type": "text/plain" },
    });
  }

  return NextResponse.json({ ok: true, time: Date.now() });
}
```

### æ‰‹é †Bï¼šãƒšãƒ¼ã‚¸å´ã§å‘¼ã¶ï¼ˆServer Componentã§OKï¼‰ğŸ“„

`app/demo/page.tsx` ã‚’ä½œã£ã¦ã­ğŸ‘‡

```tsx
// app/demo/page.tsx
import { fetchJson } from "@/lib/fetchJson";
import { AppError } from "@/lib/errors";

export default async function DemoPage() {
  try {
    // âœ… ã“ã“ã‚’åˆ‡ã‚Šæ›¿ãˆã¦è©¦ã—ã¦ã­ï¼
    // const data = await fetchJson<any>("http://localhost:3000/api/demo?mode=500");
    // const data = await fetchJson<any>("http://localhost:3000/api/demo?mode=badjson");
    const data = await fetchJson<any>("http://localhost:3000/api/demo");

    return (
      <main>
        <h1>Demo âœ…</h1>
        <pre>{JSON.stringify(data, null, 2)}</pre>
      </main>
    );
  } catch (e) {
    const err = e instanceof AppError ? e : new AppError("unknown", "è¬ã‚¨ãƒ©ãƒ¼ã ã‚ˆã€œğŸ˜µâ€ğŸ’«");

    // ã“ã“ã§ã¯ â€œåˆ†é¡ã§ãã¦ã‚‹ã‹â€ ã‚’ç¢ºèªã™ã‚‹ã ã‘ï¼
    return (
      <main>
        <h1>ã‚¨ãƒ©ãƒ¼ç™ºç”ŸğŸ§¯</h1>
        <p>kind: {err.kind}</p>
        <p>{err.message}</p>
        {err.status && <p>status: {err.status}</p>}
      </main>
    );
  }
}
```

### æ‰‹é †Cï¼šé€šä¿¡ã‚¨ãƒ©ãƒ¼ã‚‚è©¦ã™ğŸ“¡ï¼ˆè¶…ã‹ã‚“ãŸã‚“ï¼‰

ã“ã‚Œã ã‘ã¯ã€Œã¤ãªãŒã‚‰ãªã„URLã€ã«ã—ã¦ã¿ã¦ã­ğŸ‘‡
ï¼ˆä¾‹ï¼šãƒãƒ¼ãƒˆã‚’å¤‰ãˆã‚‹ï¼‰

```ts
// ä¾‹ï¼šå­˜åœ¨ã—ãªã„ãƒãƒ¼ãƒˆã«ã™ã‚‹
const data = await fetchJson<any>("http://localhost:3999/api/demo");
```

âœ… æœŸå¾…ã™ã‚‹è¡¨ç¤ºã‚¤ãƒ¡ãƒ¼ã‚¸

* `mode=500` â†’ kind ãŒ `"http"`
* `mode=badjson` â†’ kind ãŒ `"unknown"`
* `localhost:3999` â†’ kind ãŒ `"network"`

---

## ã¾ã¨ã‚ğŸ€ï¼ˆã“ã“ã ã‘è¦šãˆã‚Œã°OKï¼ï¼‰

* ã‚¨ãƒ©ãƒ¼ã¯ã¾ãš **ã€Œé€šä¿¡ã€ã€Œã‚³ãƒ¼ãƒ‰ã€ã€Œæƒ³å®šå¤–ã€** ã«åˆ†ã‘ã‚‹ğŸ§ âœ¨
* `fetch` ã¯ **404/500ã§æŠ•ã’ãªã„** ã“ã¨ãŒå¤šã„ â†’ **`res.ok` ã§åˆ†ã‘ã‚‹**ğŸš¦
* åˆ†ã‘ã‚‰ã‚Œã‚‹ã¨ã€ã‚„ã‚‹ã“ã¨ãŒæ±ºã¾ã‚‹ğŸ‘‡

  * é€šä¿¡ï¼šå†è©¦è¡ŒğŸ”ï¼‹æ¡ˆå†…ğŸ«¶
  * ã‚³ãƒ¼ãƒ‰ï¼šä¿®æ­£ğŸ› ï¸
  * æƒ³å®šå¤–ï¼šé€€é¿UIğŸ§¯ï¼‹ãƒ­ã‚°ğŸ“

---

æ¬¡ã¯ã“ã®â€œåˆ†é¡â€ã‚’æ´»ã‹ã—ã¦ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å„ªã—ã„ã‚¨ãƒ©ãƒ¼ç”»é¢**ã«ã—ã¦ã„ãã¨ä¸€æ°—ã«ã‚¢ãƒ—ãƒªã£ã½ããªã‚‹ã‚ˆã€œï¼ğŸ˜Šâœ¨
