# ç¬¬153ç« ï¼šCSRFã®ã–ã£ãã‚Šï¼ˆã‚¯ãƒƒã‚­ãƒ¼èªè¨¼ã®æ™‚ã«æ„è­˜ï¼‰ğŸª

## ä»Šæ—¥ã®ã‚´ãƒ¼ãƒ«ğŸ¯âœ¨

* CSRFãŒã€Œã©ã‚“ãªäº‹æ•…ã€ãªã®ã‹ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ãã‚‹ğŸ‘€
* ã€Œã‚¯ãƒƒã‚­ãƒ¼èªè¨¼ã®ã¨ãã«ç‰¹ã«æ³¨æ„âš ï¸ã€ãªç†ç”±ãŒã‚ã‹ã‚‹ğŸª
* Next.jsã§ã®â€œã–ã£ãã‚Šå¯¾ç­–ã‚»ãƒƒãƒˆâ€ã‚’æŒã¡å¸°ã‚Œã‚‹ğŸ§°âœ…

---

## CSRFã£ã¦ãªã«ï¼ŸğŸ¤”

CSRFï¼ˆCross-Site Request Forgeryï¼‰ã¯ã€**ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã‚ãªãŸ**ã‚’åˆ©ç”¨ã—ã¦ã€**åˆ¥ã‚µã‚¤ãƒˆã‹ã‚‰å‹æ‰‹ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é£›ã°ã•ã‚Œã‚‹æ”»æ’ƒ**ã ã‚ˆã€œğŸ˜±
ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã€Œãƒ­ã‚°ã‚¤ãƒ³ç”¨ã‚¯ãƒƒã‚­ãƒ¼ğŸªã€ã‚’è‡ªå‹•ã§é€ã£ã¡ã‚ƒã†ã“ã¨ãŒã‚ã‚‹ã‹ã‚‰ã€ã‚µãƒ¼ãƒãƒ¼ãŒã€Œæœ¬äººã®æ“ä½œã ï¼ã€ã£ã¦å‹˜é•ã„ã—ã‚„ã™ã„ã®ãŒãƒã‚¤ãƒ³ãƒˆğŸ¥²
ï¼ˆå®šç¾©ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯OWASPã‚„MDNãŒã‚ã‹ã‚Šã‚„ã™ã„ã‚ˆï¼‰([OWASP Foundation][1])

---

## ã„ã¤å±ãªã„ã®ï¼Ÿï¼ˆã“ã“å¤§äº‹ï¼‰âš ï¸ğŸª

ç‰¹ã«å±ãªã„ã®ã¯ã“ã‚“ãªã¨ãğŸ‘‡

* **ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ã‚¯ãƒƒã‚­ãƒ¼ã§æŒã£ã¦ã‚‹**ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³Cookieãªã©ï¼‰ğŸª
* **â€œçŠ¶æ…‹ãŒå¤‰ã‚ã‚‹æ“ä½œâ€**ãŒã‚ã‚‹ï¼ˆè¿½åŠ ã€æ›´æ–°ã€å‰Šé™¤ã€è³¼å…¥ã€é€é‡‘â€¦ï¼‰ğŸ§¾ğŸ’¸
* ãã®æ“ä½œãŒ **å¤–éƒ¨ã‚µã‚¤ãƒˆã‹ã‚‰ã§ã‚‚å®Ÿè¡Œã§ãã¡ã‚ƒã†å½¢**ã«ãªã£ã¦ã‚‹ï¼ˆå¯¾ç­–ãŒè–„ã„ï¼‰ğŸ˜µ

é€†ã«ã€**è¡¨ç¤ºã™ã‚‹ã ã‘ï¼ˆGETã§èª­ã‚€ã ã‘ï¼‰**ã®APIã¯ã€CSRFã¨ã„ã†ã‚ˆã‚Šã¯åˆ¥ã®è«–ç‚¹ã«ãªã‚Šã‚„ã™ã„ã‚ˆï¼ˆã¨ã¯ã„ãˆè¨­è¨ˆã¯å¤§äº‹ï¼‰ğŸ“–âœ¨

---

## å›³ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼CSRFã®å…¸å‹ãƒ‘ã‚¿ãƒ¼ãƒ³ğŸ§ ğŸ§¨ï¼ˆMermaidï¼‰

![CSRF Shield](./picture/next_study_153_csrf_shield.png)

```mermaid
sequenceDiagram
  participant U as Userï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸­ğŸ™‚ï¼‰
  participant T as ã‚ãªãŸã®ã‚µã‚¤ãƒˆï¼ˆTargetï¼‰
  participant A as æ‚ªã„ã‚µã‚¤ãƒˆï¼ˆAttackerğŸ˜ˆï¼‰

  U->>T: ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆCookieãŒä¿å­˜ã•ã‚Œã‚‹ğŸªï¼‰
  U->>A: ã†ã£ã‹ã‚Šæ‚ªã„ã‚µã‚¤ãƒˆã‚’è¦‹ã‚‹ğŸ‘€
  A->>T: éš ã—POSTã‚’é€ã‚‹ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ãŒCookieã‚‚ä¸€ç·’ã«é€ã‚‹ğŸªï¼‰
  T-->>U: ã‚µãƒ¼ãƒãƒ¼ãŒã€Œæœ¬äººæ“ä½œã€ã¨å‹˜é•ã„ã—ã¦å‡¦ç†å®Ÿè¡ŒğŸ˜±
```

---

## é˜²ãæ–¹ã®åŸºæœ¬ã‚»ãƒƒãƒˆğŸ§°ğŸ›¡ï¸ï¼ˆNext.jsè¦–ç‚¹ã‚‚æ··ãœã‚‹ã‚ˆï¼‰

### 1) SameSite Cookie ã‚’ç†è§£ã™ã‚‹ğŸªâœ¨

Cookieã«ã¯ `SameSite` ã£ã¦å±æ€§ãŒã‚ã£ã¦ã€**åˆ¥ã‚µã‚¤ãƒˆç”±æ¥ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«Cookieã‚’ä»˜ã‘ã«ãã**ã§ãã‚‹ã‚ˆğŸ’ª

* `Strict`ï¼šã‹ãªã‚Šå¼·ã„ï¼ˆåŸºæœ¬â€œåŒä¸€ã‚µã‚¤ãƒˆâ€ã ã‘ï¼‰ğŸ§±
* `Lax`ï¼šå®Ÿç”¨ãƒãƒ©ãƒ³ã‚¹å‹ï¼ˆå¤šãã®CSRFã‚’æ¸›ã‚‰ã›ã‚‹ï¼‰âš–ï¸
* `None`ï¼šã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã§ã‚‚é€ã‚‹ï¼ˆï¼CSRFçš„ã«ã¯å¼±ã„ï¼‰â€»`Secure`å¿…é ˆã«ãªã‚ŠãŒã¡ğŸ”“â†’ğŸ”

MDNã‚‚ã€ŒSameSiteãŒCSRFã®è»½æ¸›ã«å½¹ç«‹ã¤ã€ã£ã¦èª¬æ˜ã—ã¦ã‚‹ã‚ˆ([MDN Web Docs][2])

---

### 2) Server Actions ã¯â€œä½•ã‚‚ã—ãªãã¦OKâ€ã§ã¯ãªã„ã‘ã©ã€ã‹ãªã‚Šå®ˆã‚‰ã‚Œã¦ã‚‹ğŸ›¡ï¸âœ¨

Next.jsã®ã‚¬ã‚¤ãƒ‰ã§ã‚‚ã€Server Actionsã¯`<form>`ã‹ã‚‰å‘¼ã¹ã‚‹ã¶ã‚“CSRFã®è©±é¡ŒãŒå‡ºã‚‹ã‘ã©ã€**POSTã®ã¿**ï¼†**ç¾ä»£ãƒ–ãƒ©ã‚¦ã‚¶ã®SameSiteãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**ãªã©ã§ã€Œå¤šãã®ã‚±ãƒ¼ã‚¹ã§é˜²ãã‚„ã™ã„ã€ã£ã¦æ•´ç†ãŒã•ã‚Œã¦ã‚‹ã‚ˆ([Next.js][3])
ã•ã‚‰ã«Next.jså´ã§ **`Origin` ã¨ `Host`ï¼ˆã‚„ `X-Forwarded-Host`ï¼‰ã®ç…§åˆ**ãªã©ã‚‚è¿½åŠ é˜²å¾¡ã¨ã—ã¦è§¦ã‚Œã‚‰ã‚Œã¦ã‚‹ã‚ˆ([Next.js][4])

ãŸã ã—â€¦ğŸ‘‡

* `SameSite=None` ã‚’ä½¿ã†å¿…è¦ãŒå‡ºãŸ
* å¤–éƒ¨ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰å©ã‘ã‚‹APIã‚’ä½œã£ãŸ
* å¤ã„ç’°å¢ƒãƒ»ç‰¹æ®Šãªæ§‹æˆ
  ã¿ãŸã„ãªã¨ãã¯ã€**è¿½åŠ ã®å¯¾ç­–ã‚’æ¤œè¨**ã—ã‚ˆã€œâš ï¸

---

### 3) Route Handlerï¼ˆè‡ªä½œAPIï¼‰ã¯è‡ªåˆ†ã§ã‚¬ãƒ¼ãƒ‰ã—ã‚ˆã†ğŸšªğŸ§¤

Route Handlerã¯è‡ªç”±åº¦ãŒé«˜ã„ã¶ã‚“ã€**è‡ªåˆ†ã§â€œå…¥å£ãƒã‚§ãƒƒã‚¯â€**ã‚’å…¥ã‚Œã‚‹ã®ãŒå®‰å¿ƒã ã‚ˆğŸ˜Š
Next.jsã§ã¯ `headers()` / `cookies()` ã‚’Route Handlerã§èª­ã‚ã‚‹ã‚ˆã€ã£ã¦å…¬å¼ã«ã‚‚è¼‰ã£ã¦ã‚‹ğŸ“Œ([nextjs.im][5])

#### ã¾ãšæœ€å°ï¼šOriginãƒã‚§ãƒƒã‚¯ï¼ˆåŒä¸€ã‚ªãƒªã‚¸ãƒ³ä»¥å¤–ã¯403ï¼‰ğŸš«

ã€Œå¤–éƒ¨ã‚µã‚¤ãƒˆã‹ã‚‰ã®â€œå‹æ‰‹POSTâ€ã‚’é€šã—ã«ããã™ã‚‹ã€ç¬¬ä¸€æ­©ï¼ğŸ›¡ï¸

```ts
// app/api/todos/route.ts
import { headers } from "next/headers";

async function isSameOrigin(request: Request) {
  const h = await headers();
  const origin = h.get("origin");
  if (!origin) return false; // OriginãŒç„¡ã„ãªã‚‰å³ã—ã‚ã«è½ã¨ã™ï¼ˆæ–¹é‡ã§OKï¼‰

  const expectedOrigin = new URL(request.url).origin;
  return origin === expectedOrigin;
}

export async function POST(request: Request) {
  if (!(await isSameOrigin(request))) {
    return Response.json({ error: "CSRFã®ç–‘ã„ãŒã‚ã‚‹ã®ã§æ‹’å¦ã—ã¾ã—ãŸğŸ›¡ï¸" }, { status: 403 });
  }

  // âœ… ã“ã“ã‹ã‚‰ä¸‹ã« â€œè¿½åŠ /æ›´æ–°/å‰Šé™¤â€ ãªã©ã®å‡¦ç†ã‚’æ›¸ã
  return Response.json({ ok: true });
}
```

> ãƒ¡ãƒ¢ğŸ“ï¼š`Origin`ãŒç„¡ã„ã‚±ãƒ¼ã‚¹ã‚‚ã‚ã‚‹ã®ã§ã€ã€Œ`Referer`ã‚‚è¦‹ã‚‹ã€ã€Œè¨±å¯ã‚ªãƒªã‚¸ãƒ³ã‚’ãƒªã‚¹ãƒˆåŒ–ã™ã‚‹ã€ãªã©ã€é‹ç”¨ã«åˆã‚ã›ã¦å¼·åŒ–ã§ãã‚‹ã‚ˆã€œï¼ˆNext.jsã®è€ƒãˆæ–¹ã§ã‚‚â€œOriginç¢ºèªâ€ãŒè¿½åŠ é˜²å¾¡ã¨ã—ã¦èªã‚‰ã‚Œã¦ã‚‹ï¼‰([Next.js][4])

---

### 4) ã‚‚ã£ã¨å …ãã™ã‚‹ãªã‚‰ï¼šCSRFãƒˆãƒ¼ã‚¯ãƒ³ğŸŸï¸âœ¨

ã€Œãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŒã£ã¦ã‚‹äººã ã‘OKã€ã«ã™ã‚‹ç‹é“å¯¾ç­–ã‚‚ã‚ã‚‹ã‚ˆï¼

* ã‚µãƒ¼ãƒãƒ¼ãŒ**äºˆæ¸¬ã§ããªã„ãƒˆãƒ¼ã‚¯ãƒ³**ã‚’ç™ºè¡ŒğŸ²
* ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã«ãã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¸€ç·’ã«é€ã‚‹ğŸ“¨
* ã‚µãƒ¼ãƒãƒ¼ã§ä¸€è‡´ç¢ºèªâœ…

ã“ã®æ–¹å‘æ€§ã¯OWASPã®ãƒãƒ¼ãƒˆã‚·ãƒ¼ãƒˆã‚„ã€Webã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è§£èª¬ï¼ˆPortSwiggerï¼‰ã§ã‚‚å®šç•ªã¨ã—ã¦ç´¹ä»‹ã•ã‚Œã¦ã‚‹ã‚ˆ([OWASP Cheat Sheet Series][6])

---

## ã¾ã¨ã‚ï¼šã“ã®ç« ã®â€œåˆè¨€è‘‰â€ğŸªğŸ›¡ï¸âœ¨

* **CSRFã¯ã€Œãƒ­ã‚°ã‚¤ãƒ³Cookieã®è‡ªå‹•é€ä¿¡ã€ã‚’æ‚ªç”¨ã•ã‚Œã‚‹äº‹æ•…**ğŸ˜±([OWASP Foundation][1])
* **SameSiteã¯ã‹ãªã‚ŠåŠ¹ã**ã‘ã©ã€æ§‹æˆæ¬¡ç¬¬ã§è¿½åŠ å¯¾ç­–ã‚‚å¿…è¦ğŸª([MDN Web Docs][2])
* **Server Actionsã¯å®ˆã‚ŠãŒã‚ã‚‹å‰æã§ã‚‚ã€æ²¹æ–­ã›ãšè¨­è¨ˆã™ã‚‹**ğŸ§ ([Next.js][3])
* **è‡ªä½œAPIï¼ˆRoute Handlerï¼‰ã¯Originãƒã‚§ãƒƒã‚¯ã‹ã‚‰ã§OK**â†’å¿…è¦ãªã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã¸ğŸŸï¸([nextjs.im][5])

---

## ãŠã¾ã‘ï¼šé˜²å¾¡ã®å…¨ä½“åƒã‚’1æšã§ğŸ—ºï¸âœ¨ï¼ˆMermaidï¼‰

```mermaid
flowchart LR
  R["çŠ¶æ…‹å¤‰æ›´ã®POSTãŒæ¥ãŸğŸ“¨"] --> S{"SameSiteã§CookieãŒ<br/>ãã‚‚ãã‚‚ä»˜ã‹ãªã„ï¼ŸğŸª"}
  S -->|"Yes"| OK1["æ”»æ’ƒãŒæˆç«‹ã—ã«ãã„âœ…"]
  S -->|"No"| O{"Origin/RefererãŒ<br/>è‡ªã‚µã‚¤ãƒˆï¼ŸğŸŒ"}
  O -->|"No"| NG["403ã§æ‹’å¦ğŸ›¡ï¸"]
  O -->|"Yes"| T{"CSRFãƒˆãƒ¼ã‚¯ãƒ³ç¢ºèª<br/>ï¼ˆå¿…è¦ãªã‚‰ï¼‰ğŸŸï¸"}
  T -->|"No"| NG
  T -->|"Yes"| OK2["å‡¦ç†ã—ã¦OKğŸ‰"]
```

[1]: https://owasp.org/www-community/attacks/csrf?utm_source=chatgpt.com "Cross Site Request Forgery (CSRF)"
[2]: https://developer.mozilla.org/en-US/docs/Web/HTTP/Guides/Cookies?utm_source=chatgpt.com "Using HTTP cookies - MDN Web Docs - Mozilla"
[3]: https://nextjs.org/docs/app/guides/data-security?utm_source=chatgpt.com "Guides: Data Security"
[4]: https://nextjs.org/blog/security-nextjs-server-components-actions?utm_source=chatgpt.com "How to Think About Security in Next.js"
[5]: https://en.nextjs.im/docs/app/building-your-application/routing/route-handlers?utm_source=chatgpt.com "Route Handlers | Next.js English"
[6]: https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html?utm_source=chatgpt.com "Cross-Site Request Forgery Prevention Cheat Sheet"
