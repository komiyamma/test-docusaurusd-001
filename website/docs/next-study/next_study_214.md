# ç¬¬214ç« ï¼šCIã§å›ã™ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆå¤±æ•—ã—ãŸã‚‰æ­¢ã‚ã‚‹ï¼‰ğŸš¦

CIï¼ˆã‚·ãƒ¼ã‚¢ã‚¤ï¼‰ã£ã¦ä¸€è¨€ã§ã„ã†ã¨ã€**ã€ŒGitHubã«push / PRã—ãŸã‚‰ã€è‡ªå‹•ã§ãƒ†ã‚¹ãƒˆã‚„ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€ãƒ€ãƒ¡ãªã‚‰èµ¤ä¿¡å·ã§æ­¢ã‚ã¦ãã‚Œã‚‹ä»•çµ„ã¿ã€**ã ã‚ˆã€œğŸš¥ğŸ’¥
äººé–“ã®ã€Œã†ã£ã‹ã‚ŠãƒŸã‚¹ã€ã‚’æ©Ÿæ¢°ãŒå…ˆã«è¦‹ã¤ã‘ã¦ãã‚Œã‚‹ã‹ã‚‰ã€ãƒãƒ¼ãƒ ã§ã‚‚ä¸€äººé–‹ç™ºã§ã‚‚ã‚ã£ã¡ã‚ƒå®‰å¿ƒã§ã™ğŸ«¶ğŸ˜Š ([GitHub Docs][1])

---

## 1) ä»Šæ—¥ã®ã‚´ãƒ¼ãƒ«ğŸ¯ğŸ’–

* âœ… push / PR ã®ãŸã³ã« **lint â†’ test â†’ build** ãŒè‡ªå‹•ã§èµ°ã‚‹
* âœ… ã©ã‚Œã‹1ã¤ã§ã‚‚å¤±æ•—ã—ãŸã‚‰ **ãã“ã§æ­¢ã¾ã£ã¦ã€Œå¤±æ•—ã€æ‰±ã„ã«ãªã‚‹**
* âœ…ï¼ˆã§ãã‚Œã°ï¼‰PRã‚’**ã€ŒCIãŒé€šã‚‰ãªã„ã¨ãƒãƒ¼ã‚¸ã§ããªã„ã€**çŠ¶æ…‹ã«ã™ã‚‹ğŸ”’

---

## 2) CIã®æµã‚Œã‚’å›³ã§ã¤ã‹ã‚€ğŸ—ºï¸âœ¨ï¼ˆã¾ãšã¯ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰

![ci_pipeline](./picture/next_study_214_ci_pipeline.png)

```mermaid
flowchart TD
  A["GitHubã«push / PRä½œæˆ"] --> B["GitHub ActionsãŒèµ·å‹•âš™ï¸"]
  B --> C["â‘  Lintãƒã‚§ãƒƒã‚¯ğŸ§¹"]
  C -->|"OK"| D["â‘¡ ãƒ†ã‚¹ãƒˆå®Ÿè¡ŒğŸ§ª"]
  C -->|"NG"| X["å¤±æ•—ã§åœæ­¢ğŸš¦âŒ"]
  D -->|"OK"| E["â‘¢ next buildğŸ—ï¸"]
  D -->|"NG"| X
  E -->|"OK"| F["CIæˆåŠŸâœ… â†’ ãƒãƒ¼ã‚¸OK(#quot;è¨­å®šæ¬¡ç¬¬#quot;)ğŸ‰"]
  E -->|"NG"| X
```

ãƒã‚¤ãƒ³ãƒˆã¯ã“ã‚ŒğŸ‘‡
**ã€Œé †ç•ªã«ãƒã‚§ãƒƒã‚¯ã—ã¦ã€ã©ã“ã‹ã§å¤±æ•—ã—ãŸã‚‰å³çµ‚äº†ã€**ï¼ğŸš¦ã‚¹ãƒˆãƒƒãƒ—ï¼

---

## 3) æœ€ä½é™ã®CIã‚’ä½œã‚ã†ğŸ§©ğŸ’»ï¼ˆGitHub Actionsï¼‰

ã“ã“ã§ã¯ä¸€ç•ªã‚ˆãä½¿ã‚ã‚Œã‚‹ **GitHub Actions** ã§ä½œã‚‹ã‚ˆã€œâœ¨

### 3-1. ã¾ãš package.json ã® scripts ã‚’ç¢ºèªğŸ‘€

ã ã„ãŸã„ã“ã†ãªã£ã¦ã‚Œã°OKï¼ˆã™ã§ã«ã‚ã‚‹ã¯ãšï¼‰ğŸ‘‡

* `npm run lint`
* `npm run test`
* `npm run build`

â€» Next.jsã®lintã¯ `next lint` ãŒä¸­èº«ã ã‚ˆğŸ§¹ ([Next.js][2])

---

### 3-2. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ä½œã‚‹ğŸ“âœ¨

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹ã«ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã£ã¦ã­ğŸ‘‡

* `.github/workflows/ci.yml`

ä¸­èº«ã¯ã“ã‚Œï¼ˆã‚³ãƒ”ãƒšOKï¼‰ğŸ‘‡

```yaml
name: CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Test
        run: npm run test

      - name: Build
        run: npm run build
```

* `npm ci` ã¯CIå‘ã‘ã®ã€Œãã£ã¡ã‚ŠåŒã˜ä¾å­˜é–¢ä¿‚ã‚’å…¥ã‚Œã‚‹ã€ã‚³ãƒãƒ³ãƒ‰ã§å®‰å®šã—ã‚„ã™ã„ã‚ˆğŸ“¦âœ¨ ([GitHub Docs][3])
* `actions/setup-node@v4` ã® `cache: npm` ã§ã€npmã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚ä½¿ãˆã‚‹ã‚ˆâš¡ ([GitHub][4])

ä½œã£ãŸã‚‰ **commit â†’ push** ã—ã¦ã­ğŸš€
ã™ã‚‹ã¨ GitHub ã® **Actions** ã‚¿ãƒ–ã§å®Ÿè¡Œãƒ­ã‚°ãŒè¦‹ã‚‰ã‚Œã‚‹ã‚ˆğŸ‘€âœ¨

---

## 4) ã€Œå¤±æ•—ã—ãŸã‚‰æ­¢ã‚ã‚‹ã€ã£ã¦ã©ã†ã„ã†ã“ã¨ï¼ŸğŸš¦ğŸ’¥

GitHub Actionsã¯ã€åŸºæœ¬ã“ã†å‹•ãã‚ˆğŸ‘‡

* å„ stepï¼ˆLint/Test/Buildï¼‰ã¯ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹
* **å¤±æ•—ã™ã‚‹ã¨ã‚³ãƒãƒ³ãƒ‰ãŒâ€œã‚¨ãƒ©ãƒ¼çµ‚äº†ï¼ˆçµ‚äº†ã‚³ãƒ¼ãƒ‰ãŒ0ã˜ã‚ƒãªã„ï¼‰â€**ã«ãªã‚‹
* ã™ã‚‹ã¨ãã®æ™‚ç‚¹ã§ **ã‚¸ãƒ§ãƒ–ãŒFailedã«ãªã£ã¦ã€ãã‚Œä»¥é™ã®stepã¯å®Ÿè¡Œã•ã‚Œãªã„** ğŸš¦ğŸ›‘

ã¤ã¾ã‚Šã€ãƒ†ã‚¹ãƒˆãŒè½ã¡ãŸã‚‰ **buildã¾ã§è¡Œã‹ãªã„**ï¼
ãƒ ãƒ€ãªæ™‚é–“ã‚’ä½¿ã‚ãªã„è³¢ã„ä»•çµ„ã¿ã€œğŸ˜³âœ¨

---

## 5) ï¼ˆé‡è¦ğŸ’¡ï¼‰CIãŒé€šã‚‰ãªã„ã¨ãƒãƒ¼ã‚¸ã§ããªã„ã‚ˆã†ã«ã™ã‚‹ğŸ”’âœ…

ã€Œèµ¤ã„ã®ã«ã†ã£ã‹ã‚Šãƒãƒ¼ã‚¸ã€ã£ã¦ã€ãŸã¾ã«èµ·ãã‚‹ã®ã­ğŸ¥²ğŸ’¦
ãã‚Œã‚’é˜²ãã«ã¯ GitHub ã®è¨­å®šã§ã€

* **Branch protection**
* **Require status checks to pass**

ã¿ãŸã„ãªã®ã‚’ONã«ã™ã‚‹ã‚ˆï¼ˆãƒªãƒã‚¸ãƒˆãƒªè¨­å®šã‹ã‚‰ï¼‰ğŸ”âœ¨
ã“ã‚Œã§ **CIãŒç·‘âœ…ã«ãªã‚‰ãªã„ã¨ãƒãƒ¼ã‚¸ãƒœã‚¿ãƒ³ãŒæŠ¼ã›ãªã„**çŠ¶æ…‹ã«ã§ãã‚‹ï¼

---

## 6) ã¡ã‚‡ã„é€Ÿãã™ã‚‹å°æŠ€ï¼šNext.jsã®ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ğŸ§Šâš¡ï¼ˆä»»æ„ï¼‰

Next.js ã¯ãƒ“ãƒ«ãƒ‰ã§ `.next/cache` ã‚’ä½¿ã†ã‚“ã ã‘ã©ã€CIã§ã‚‚ã“ã‚Œã‚’ä¿å­˜ã—ã¦ãŠãã¨é€Ÿããªã‚‹ã“ã¨ãŒã‚ã‚‹ã‚ˆğŸš€
ï¼ˆä¿å­˜ã—ã¦ãªã„ã¨ â€œNo Cache Detectedâ€ ã¿ãŸã„ãªè©±ãŒå‡ºã‚‹ã“ã¨ã‚‚ã‚ã‚‹ï¼‰ ([Next.js][5])

è¿½åŠ ã™ã‚‹ãªã‚‰ã€`Setup Node` ã®å¾Œã‚ãŸã‚Šã«ã“ã‚Œã‚’è¶³ã™ã‚¤ãƒ¡ãƒ¼ã‚¸ğŸ‘‡

```yaml
      - name: Cache Next.js build cache
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextcache-${{ hashFiles('package-lock.json') }}-${{ hashFiles('next.config.*', 'app/**', 'src/**') }}
          restore-keys: |
            ${{ runner.os }}-nextcache-${{ hashFiles('package-lock.json') }}-
            ${{ runner.os }}-nextcache-
```

â€» â€œé€Ÿããªã‚‹â€ ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¬¡ç¬¬ã ã‹ã‚‰ã€ã¾ãšã¯æœ€ä½é™CIã§OKã ã‚ˆã€œğŸ˜ŠğŸ«¶

---

## 7) ãƒŸãƒ‹ç·´ç¿’ğŸ“âœ¨ï¼ˆã‚ã–ã¨å¤±æ•—â†’ç›´ã™ï¼ï¼‰

1. ä½•ã‹ã‚’å¤‰æ›´ã—ã¦PRã‚’ä½œã‚‹ğŸ’Œ
2. ã‚ã–ã¨ãƒ†ã‚¹ãƒˆãŒè½ã¡ã‚‹å¤‰æ›´ã‚’å…¥ã‚Œã‚‹ï¼ˆä¾‹ï¼šãƒ†ã‚¹ãƒˆã§æœŸå¾…ã•ã‚Œã‚‹æ–‡è¨€ã‚’å¤‰ãˆã¡ã‚ƒã†ï¼‰ğŸ˜ˆğŸ§ª
3. PRã®ãƒã‚§ãƒƒã‚¯ãŒ **èµ¤âŒ** ã«ãªã‚‹ã®ã‚’ç¢ºèªğŸ‘€
4. ç›´ã—ã¦pushã™ã‚‹ã¨ **ç·‘âœ…** ã«æˆ»ã‚‹ã®ã‚’ç¢ºèªğŸ‰

ã“ã‚Œã‚„ã‚‹ã¨ã€ŒCIã£ã¦ã“ã†æ­¢ã¾ã‚‹ã‚“ã ï¼ã€ãŒä¸€æ°—ã«è…‘ã«è½ã¡ã‚‹ã‚ˆğŸ˜†âœ¨

---

## ã¾ã¨ã‚ğŸ’–

* CIã¯ã€Œpush/PRã®ãŸã³ã«è‡ªå‹•ãƒã‚§ãƒƒã‚¯ã€ğŸ§ªâš™ï¸ ([GitHub Docs][1])
* **Lint â†’ Test â†’ Build** ã¿ãŸã„ã«é †ç•ªã«å›ã—ã¦ã€å¤±æ•—ã—ãŸã‚‰ğŸš¦ã§æ­¢ã‚ã‚‹
* GitHub Actionsãªã‚‰ `.github/workflows/ci.yml` ã§ã‚µã‚¯ãƒƒã¨ä½œã‚Œã‚‹âœ¨ ([GitHub Docs][3])
* ä½™è£•ãŒå‡ºãŸã‚‰ `.next/cache` ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚æ¤œè¨ğŸ§Šâš¡ ([Next.js][5])

æ¬¡ã«ã‚„ã‚‹ãªã‚‰ã€**ã€ŒPRã§ã ã‘E2Eã‚’èµ°ã‚‰ã›ã‚‹ã€ã€Œmainã«ãƒãƒ¼ã‚¸ã•ã‚ŒãŸã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ã€**ã¿ãŸã„ã«è‚²ã¦ã¦ã„ãã¨è¶…ãã‚Œã£ã½ããªã‚‹ã‚ˆã€œğŸŒ±ğŸš€ğŸ’•

[1]: https://docs.github.com/en/actions/get-started/continuous-integration?utm_source=chatgpt.com "Continuous integration"
[2]: https://nextjs.org/docs/app/api-reference/config/eslint?utm_source=chatgpt.com "Configuration: ESLint"
[3]: https://docs.github.com/ja/actions/tutorials/build-and-test-code/nodejs?utm_source=chatgpt.com "Node.js ã®ãƒ“ãƒ«ãƒ‰ã¨ãƒ†ã‚¹ãƒˆ - GitHub Actions"
[4]: https://github.com/actions/setup-node?utm_source=chatgpt.com "actions/setup-node"
[5]: https://nextjs.org/docs/pages/guides/ci-build-caching?utm_source=chatgpt.com "Guides: CI Build Caching"
