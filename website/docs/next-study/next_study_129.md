# ç¬¬129ç« ï¼šãƒ­ã‚°ã®è€ƒãˆæ–¹ï¼ˆä½•ã‚’æ®‹ã™ï¼Ÿï¼‰ğŸ“

ãƒ­ã‚°ã£ã¦ã­ã€ã–ã£ãã‚Šè¨€ã†ã¨ **ã€Œã‚ã¨ã§è‡ªåˆ†ï¼ˆor ãƒãƒ¼ãƒ ï¼‰ãŒåŠ©ã‹ã‚‹ãƒ¡ãƒ¢ã€** ã ã‚ˆã€œğŸ“’ğŸ’•

ã€Œãªã‚“ã‹å‹•ã‹ãªã„ğŸ˜­ã€ã£ã¦ãªã£ãŸã¨ãã«ã€ãƒ­ã‚°ãŒã‚ã‚‹ã¨ **åŸå› ã«æœ€çŸ­ã§ãŸã©ã‚Šç€ã‘ã‚‹** ã‹ã‚‰ã€é‹ç”¨ã§ã¯ã‚ã¡ã‚ƒå¤§äº‹ï¼ğŸš‘ğŸ’¨

---

## 1) ãƒ­ã‚°ã‚’æ®‹ã™ç›®çš„ã¯3ã¤ã ã‘è¦šãˆã‚ˆã£ğŸ§ ğŸ’¡

* **â‘  ãƒ‡ãƒãƒƒã‚°ï¼ˆé–‹ç™ºä¸­ï¼‰**ï¼šä»Šã©ã“é€šã£ã¦ã‚‹ï¼Ÿå€¤ã©ã†ãªã£ã¦ã‚‹ï¼ŸğŸ‘€
* **â‘¡ ç›£è¦–ï¼ˆæœ¬ç•ªï¼‰**ï¼šã‚¨ãƒ©ãƒ¼å¢—ãˆã¦ãªã„ï¼Ÿä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã£ã½ããªã„ï¼ŸğŸš¨
* **â‘¢ è¿½è·¡ï¼ˆèª¿æŸ»ï¼‰**ï¼šã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã“ã®æ“ä½œã€ã©ã“ã§å¤±æ•—ã—ãŸï¼ŸğŸ•µï¸â€â™€ï¸

ãƒ­ã‚°ãŒå¤šã™ãã‚‹ã¨é€†ã«æ¢ã›ãªã„ã‹ã‚‰ã€**ã€Œç›®çš„â†’å¿…è¦ãªæƒ…å ±ã ã‘ã€** ãŒã‚³ãƒ„ã ã‚ˆâœ‚ï¸âœ¨

---

## 2) â€œæ®‹ã™ã¨å¼·ã„â€ãƒ­ã‚°ã®æœ€å°ã‚»ãƒƒãƒˆâœ…ğŸ§©

æœ€ä½é™ã“ã‚ŒãŒã‚ã‚‹ã¨è¶…ã¤ã‚ˆã„ğŸ’ªâœ¨ï¼ˆå…¨éƒ¨ãã‚ãˆãªãã¦ã‚‚OKã ã‚ˆã€œï¼‰

* **ã„ã¤**ï¼š`ts`ï¼ˆISOå½¢å¼ãŒãŠã™ã™ã‚ï¼‰â°
* **ä½•ãŒèµ·ããŸ**ï¼š`event`ï¼ˆä¾‹ï¼š`auth_block`ï¼‰ğŸ·ï¸
* **ã©ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**ï¼š`requestId`ï¼ˆè¿½è·¡ã®å‘½ï¼ï¼‰ğŸ§µ
* **ã©ã“**ï¼š`pathname`ï¼ˆä¾‹ï¼š`/dashboard`ï¼‰ğŸ—ºï¸
* **ã©ã†ã„ã†çµæœ**ï¼š`allowed/blocked` ã‚„ `reason` ğŸš¦
* **ãƒ¬ãƒ™ãƒ«**ï¼š`info / warn / error` ğŸ”¥

---

## 3) â€œæ®‹ã—ã¡ã‚ƒãƒ€ãƒ¡å¯„ã‚Šâ€ã®ã‚‚ã®ğŸ™…â€â™€ï¸ğŸ”’

ãƒ­ã‚°ã¯æœ¬ç•ªã ã¨ã€ã‚ã¨ã‹ã‚‰è‰²ã‚“ãªäººãŒè¦‹ã‚‹å¯èƒ½æ€§ã‚ã‚‹ã‚ˆã­ğŸ‘€ğŸ’¦
ã ã‹ã‚‰ã“ã‚Œã¯é¿ã‘ã‚ˆã€œï¼

* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ãƒˆãƒ¼ã‚¯ãƒ³ã€Cookieä¸¸ã”ã¨ğŸªâŒ
* å€‹äººæƒ…å ±ï¼ˆãƒ¡ãƒ¼ãƒ«/é›»è©±/ä½æ‰€ãªã©ï¼‰ğŸ‘¤âŒ
* ãƒ•ã‚©ãƒ¼ãƒ ã®æœ¬æ–‡ï¼ˆãŠå•ã„åˆã‚ã›å†…å®¹ã¨ã‹ï¼‰ğŸ“âŒ

ã€Œå¿…è¦ãªã‚‰ **ä¼ã›ã‚‹ï¼ˆãƒã‚¹ã‚¯ã™ã‚‹ï¼‰**ã€ãŒåŸºæœ¬ã ã‚ˆã€œğŸ«¶âœ¨

---

## 4) Next.js ã ã¨ãƒ­ã‚°ã¯ã©ã“ã§å‡ºã™ï¼ŸğŸ§¤ğŸ§Š

* **Middlewareï¼ˆé–€ç•ªï¼‰**ï¼šé€šã™/æ­¢ã‚ã‚‹åˆ¤æ–­ã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆç†ç”±ã‚’æ®‹ã™ã®ãŒå¼·ã„ğŸšªâœ¨
* **Route Handlerï¼ˆAPIï¼‰**ï¼šAPIã®æˆåŠŸ/å¤±æ•—ã€å…¥åŠ›ãƒã‚§ãƒƒã‚¯å¤±æ•—ãªã©ğŸ“¡
* **Server Actions / Serverå´å‡¦ç†**ï¼šDBå¤±æ•—ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—ãªã©ğŸ§¯

é–‹ç™ºä¸­ã¯ `console.log()` ã§ã‚‚å…¨ç„¶OKã ã‚ˆã€œğŸ˜Š
ï¼ˆæœ¬ç•ªã§æœ¬æ ¼é‹ç”¨ã™ã‚‹ãªã‚‰ã€JSONå½¢å¼ã§æƒãˆã‚‹ã¨èª­ã¿ã‚„ã™ã„âœ¨ï¼‰

---

## å›³è§£ï¼šã©ã“ã§ãƒ­ã‚°ãŒå‡ºã‚‹ã¨å¬‰ã—ã„ï¼ŸğŸ—ºï¸ğŸ“

![ã‚¤ãƒ¡ãƒ¼ã‚¸å›³](./picture/next_study_129_logging.png)

```mermaid
flowchart LR
  U["Browser"] --> M["Middleware<br/>å…¥å£ã®é–€ç•ªğŸ§¤"]
  M -->|"é€šã™"| P["Page / RSC<br/>è¡¨ç¤ºğŸ§Š"]
  M -->|"æ­¢ã‚ã‚‹"| L["Redirect / Block<br/>ãƒ­ã‚°æ®‹ã™ğŸš¦"]
  P --> A["Route Handler / Server Actions<br/>å‡¦ç†ğŸ“¡"]
  A --> R["Response"]
  R --> U
```

---

## 5) å®Ÿè·µï¼šMiddlewareã§â€œè¿½è·¡ã—ã‚„ã™ã„ãƒ­ã‚°â€ã‚’å‡ºã—ã¦ã¿ã‚ˆğŸ§¤ğŸ§µâœ¨

### ã­ã‚‰ã„ğŸ¯

* ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã« **requestId** ã‚’ä½œã‚‹
* ã€Œé€šã—ãŸ/æ­¢ã‚ãŸã€ã‚’ **ç†ç”±ã¤ã** ã§ãƒ­ã‚°ã«æ®‹ã™
* ã¤ã„ã§ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ã« `x-request-id` ã‚’ä»˜ã‘ã‚‹ï¼ˆç¢ºèªã—ã‚„ã™ã„ï¼ï¼‰ğŸ§¡

### `middleware.ts`ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹ï¼‰ğŸ“„

```ts
import { NextRequest, NextResponse } from "next/server";

export function middleware(req: NextRequest) {
  const requestId = crypto.randomUUID(); // è¿½è·¡ç”¨IDğŸ§µ
  const ts = new Date().toISOString();
  const { pathname } = req.nextUrl;

  // âœ… å…¥å£ãƒ­ã‚°ï¼ˆã¾ãšã¯ã€Œæ¥ãŸã€ã ã‘åˆ†ã‹ã‚Œã°OKï¼‰
  console.log(
    JSON.stringify({
      level: "info",
      event: "middleware_request",
      ts,
      requestId,
      method: req.method,
      pathname,
    })
  );

  // ä¾‹ï¼š/dashboard ã¯ â€œticket=okâ€ cookie ãŒç„¡ã„ã¨å…¥ã‚Œãªã„æƒ³å®šğŸª
  const isDashboard = pathname.startsWith("/dashboard");
  const hasTicket = req.cookies.get("ticket")?.value === "ok";

  if (isDashboard && !hasTicket) {
    console.warn(
      JSON.stringify({
        level: "warn",
        event: "auth_block",
        ts: new Date().toISOString(),
        requestId,
        pathname,
        reason: "missing_ticket",
      })
    );

    const url = req.nextUrl.clone();
    url.pathname = "/login";
    url.searchParams.set("from", pathname); // ã©ã“ã‹ã‚‰æ¥ãŸã‹æ®‹ã™ğŸ§­
    return NextResponse.redirect(url);
  }

  // âœ… é€šã™
  const res = NextResponse.next();
  res.headers.set("x-request-id", requestId); // ãƒ‡ãƒãƒƒã‚°ã—ã‚„ã™ã„ğŸ§¡
  return res;
}

// ï¼ˆä»»æ„ï¼‰é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ç³»ã‚’é™¤å¤–ã—ãŸã„æ™‚ã«è¨­å®šã™ã‚‹ã“ã¨ãŒå¤šã„ã‚ˆã€œ
// export const config = {
//   matcher: ["/((?!_next/static|_next/image|favicon.ico).*)"],
// };
```

---

## 6) å‹•ä½œãƒã‚§ãƒƒã‚¯ï¼ˆWindowsã§OKï¼‰ğŸ§ªğŸªŸ

1. `npm run dev` â–¶ï¸
2. `/dashboard` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã‚‹ï¼ˆã¾ã å¼¾ã‹ã‚Œã‚‹ã¯ãšï¼‰ğŸš«
3. ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«ãƒ­ã‚°ãŒå‡ºã‚‹ã®ã‚’ç¢ºèªğŸ‘€âœ¨
4. ãƒ–ãƒ©ã‚¦ã‚¶ã® DevTools â†’ Network ã‚’è¦‹ã¦ã€**`x-request-id`** ãŒä»˜ã„ã¦ã‚‹ã‹ç¢ºèªğŸ”ğŸ§¡

---

## 7) ä»Šæ—¥ã®ã¾ã¨ã‚ï¼ˆã“ã‚Œã ã‘è¦šãˆãŸã‚‰å‹ã¡ï¼‰ğŸ†ğŸ’•

* ãƒ­ã‚°ã¯ **æœªæ¥ã®è‡ªåˆ†ã‚’åŠ©ã‘ã‚‹ãƒ¡ãƒ¢** ğŸ“’âœ¨
* **requestId ãŒã‚ã‚‹ã¨è¿½è·¡ãŒæ¿€ãƒ©ã‚¯** ğŸ§µ
* æ®‹ã™ã®ã¯ã€Œã„ã¤ãƒ»ã©ã“ãƒ»ä½•ãŒãƒ»ç†ç”±ã€ãã‚‰ã„ã§OKğŸ‘Œ
* **ç§˜å¯†ãƒ»å€‹äººæƒ…å ±ã¯ãƒ­ã‚°ã«å‡ºã•ãªã„** ğŸ”’ğŸ™…â€â™€ï¸

---

æ¬¡ã®ç« ã§ã¯ã€ã“ã®ãƒ­ã‚°ãŒã€Œé‹ç”¨ã€ã§ã©ã†åŠ¹ã„ã¦ãã‚‹ã‹ï¼ˆæ¡ˆå†…ã®å‡ºã—æ–¹ã¨ã‹ï¼‰ã«ç¹‹ãŒã£ã¦ã„ãã‚ˆã€œğŸ«¶âœ¨
