# ç¬¬89ç« ï¼šãƒ‡ãƒ¼ã‚¿å–å¾—ã®è¨­è¨ˆï¼šã¾ãšâ€œèª­ã¿å–ã‚Šâ€ã‚’å›ºã‚ã‚‹ğŸ“š

ã“ã®ç« ã¯ã­ã€ã€Œãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆfetchï¼‰ã£ã¦çµå±€ã©ã†ç½®ã‘ã°ã„ã„ã®ï¼ŸğŸ¥ºã€ã‚’è¿·ã‚ãªã„å½¢ã«ã™ã‚‹å›ã ã‚ˆã€œï¼ğŸ’ªğŸ’–
**â€œã¾ãšèª­ã¿å–ã‚Šï¼ˆä¸€è¦§ãƒ»è©³ç´°ï¼‰ã‚’å®‰å®šã•ã›ã‚‹â€**ã ã‘ã§ã€é–‹ç™ºãŒã‚ã£ã¡ã‚ƒãƒ©ã‚¯ã«ãªã‚‹ã‚ˆğŸ˜ŠğŸŒ¸

---

## ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ğŸ¯âœ¨

* ã€Œä¸€è¦§ãƒšãƒ¼ã‚¸ã€ã€Œè©³ç´°ãƒšãƒ¼ã‚¸ã€ã§ **åŒã˜ãƒ«ãƒ¼ãƒ«ã§ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã‚€**ã‚ˆã†ã«ã™ã‚‹ğŸ“–
* fetchã®ç½®ãå ´æ‰€ã‚’å›ºå®šã—ã¦ã€**ã©ã“ã‚’è¦‹ã‚Œã°ã„ã„ã‹è¿·ã‚ãªã„**ğŸ—ºï¸
* **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆé€Ÿã•ï¼‰ã¨é®®åº¦ï¼ˆæ–°ã—ã•ï¼‰**ã‚’â€œæ„å›³ã—ã¦â€æ±ºã‚ã‚‰ã‚Œã‚‹ğŸ§Šâ±ï¸
* ã‚¨ãƒ©ãƒ¼/ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚‚å«ã‚ã¦ã€èª­ã¿å–ã‚Šä½“é¨“ã‚’æ•´ãˆã‚‹ğŸ§¯â³

---

## â€œèª­ã¿å–ã‚Šã‚’å›ºã‚ã‚‹â€ã£ã¦ä½•ï¼ŸğŸ“šğŸ¤”

æ›¸ãè¾¼ã¿ï¼ˆè¿½åŠ /æ›´æ–°/å‰Šé™¤ï¼‰ã‚ˆã‚Šå…ˆã«ã€ã¾ãšã¯

* ä¸€è¦§ã‚’è¡¨ç¤ºã™ã‚‹ğŸ“‹
* è©³ç´°ã‚’è¡¨ç¤ºã™ã‚‹ğŸ”

ã“ã®2ã¤ã‚’ **åŒã˜è¨­è¨ˆã§ã‚¹ãƒƒã¨ä½œã‚Œã‚‹çŠ¶æ…‹**ã«ã™ã‚‹ã“ã¨ã ã‚ˆğŸ˜Š
Next.jsï¼ˆApp Routerï¼‰ã¯ **Server Component ã§ãƒ‡ãƒ¼ã‚¿å–å¾—**ãŒåŸºæœ¬ãªã®ã§ã€èª­ã¿å–ã‚Šã‚’ã“ã“ã«å¯„ã›ã‚‹ã¨ã‚¹ãƒƒã‚­ãƒªã™ã‚‹ã‚ˆã€œğŸµ
ï¼ˆServer Component ã§ `fetch` ãªã©ã®I/OãŒã§ãã‚‹ã‚ˆï¼‰ ([Next.js][1])

---

## ã¾ãšæ±ºã‚ã‚‹ã®ã¯ã“ã®3ã¤ã ã‘ğŸ§ âœ¨

### â‘  ä½•ã‚’èª­ã‚€ï¼Ÿï¼ˆãƒ‡ãƒ¼ã‚¿ã®å½¢ï¼‰ğŸ§©

ã€Œãƒšãƒ¼ã‚¸ã«å¿…è¦ãªå½¢ã ã‘ã€æ±ºã‚ã‚ˆã†ğŸ€
ä¾‹ï¼šæŠ•ç¨¿ä¸€è¦§ãªã‚‰ `id, title` ãŒã‚ã‚Œã°OKã€è©³ç´°ãªã‚‰ `body` ã‚‚è¦ã‚‹ã€ã¿ãŸã„ã«ã­ğŸ˜Š

### â‘¡ ã©ã“ã§èª­ã‚€ï¼Ÿï¼ˆç½®ãå ´æ‰€ï¼‰ğŸ“¦

ãŠã™ã™ã‚ã¯ **`lib/` ã«â€œèª­ã¿å–ã‚Šé–¢æ•°â€ã‚’é›†ç´„**ï¼
ãƒšãƒ¼ã‚¸å´ã¯ `await getPosts()` ã¿ãŸã„ã«å‘¼ã¶ã ã‘ã«ã™ã‚‹âœ¨

### â‘¢ ã©ã‚Œãã‚‰ã„æ–°ã—ãã—ãŸã„ï¼Ÿï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ–¹é‡ï¼‰ğŸ§Šâ±ï¸

Next.js ã® `fetch` ã¯ã‚µãƒ¼ãƒãƒ¼å´ã§ **ã‚­ãƒ£ãƒƒã‚·ãƒ¥/å†æ¤œè¨¼ã‚’è¨­å®šã§ãã‚‹**ã‚ˆï¼ˆæ‹¡å¼µ `fetch`ï¼‰ ([Next.js][2])
è¿·ã£ãŸã‚‰æœ€åˆã¯ã“ã®2æŠã§OKğŸ‘‡

* ã ã„ãŸã„æ›´æ–°ã•ã‚Œãªã„ï¼š`revalidate: 60`ï¼ˆ1åˆ†ã”ã¨ã«æ›´æ–°ï¼‰â±ï¸
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«é•ã†/å¸¸ã«æœ€æ–°ï¼š`cache: "no-store"`ğŸ”¥

ï¼ˆâ€» `cache: "no-store"` ã‚„ `revalidate: 0` ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’é¿ã‘ã‚‰ã‚Œã‚‹ã‚ˆï¼‰ ([Next.js][3])

---

## å›³è§£ï¼šèª­ã¿å–ã‚Šè¨­è¨ˆã®â€œå‹â€ğŸ“¦â¡ï¸ğŸ“„ï¼ˆã“ã‚Œã«å¯„ã›ã‚‹ã¨å‹ã¡ğŸ«¶ï¼‰

![Fetch Design Pattern](./picture/next_study_089_fetch_pattern.png)

```mermaid
flowchart LR
  UI["Page / Component"] -->|"call"| Lib["lib/* : èª­ã¿å–ã‚Šé–¢æ•°"]
  Lib -->|"fetch"| API["(#quot;å¤–éƒ¨API / DB#quot;)"]
  API --> Lib
  Lib --> UI
  UI --> UX["loading.tsx / error.tsx ã§ä½“é¨“ã‚’æ•´ãˆã‚‹"]
```

---

## ä¾‹ï¼šæŠ•ç¨¿ã€Œä¸€è¦§ â†’ è©³ç´°ã€ã®èª­ã¿å–ã‚Šã‚’â€œå‹â€ã§ä½œã‚‹ğŸ§âœ¨

ã“ã“ã§ã¯å¤–éƒ¨APIã¨ã—ã¦ã€ã‚ˆãã‚ã‚‹ç·´ç¿’ç”¨ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ã†ã‚ˆï¼ˆURLã¯ã‚³ãƒ¼ãƒ‰ã«å…¥ã‚Œã¦ã­ğŸ’¡ï¼‰

### ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆï¼ˆèª­ã¿å–ã‚ŠãŒè¿·å­ã«ãªã‚‰ãªã„ï¼‰ğŸ—‚ï¸

```text
src/
  app/
    posts/
      page.tsx
      loading.tsx
      error.tsx
      [id]/
        page.tsx
  lib/
    posts.ts
```

---

## 1) `lib/posts.ts`ï¼šèª­ã¿å–ã‚Šé–¢æ•°ã‚’ã“ã“ã«é›†ç´„ğŸ“šâœ¨

ãƒã‚¤ãƒ³ãƒˆã¯ğŸ‘‡

* **å‹ã‚’ç½®ã**
* **fetchã‚’ã“ã“ã«é–‰ã˜è¾¼ã‚ã‚‹**
* **ã‚¨ãƒ©ãƒ¼ã¯æŠ•ã’ã‚‹ï¼ˆãƒšãƒ¼ã‚¸å´ã® error.tsx ã§æ‹¾ãˆã‚‹ï¼‰**

```ts
// src/lib/posts.ts
export type Post = {
  id: number;
  title: string;
  body: string;
};

const API_BASE = "https://jsonplaceholder.typicode.com";

async function fetchJson<T>(input: RequestInfo, init?: RequestInit): Promise<T> {
  const res = await fetch(input, init);

  if (!res.ok) {
    // error.tsx ã«æµã‚Œã‚‹ã‚ˆã†ã«ã€ŒæŠ•ã’ã‚‹ã€âœ¨
    throw new Error(`Fetch failed: ${res.status} ${res.statusText}`);
  }
  return (await res.json()) as T;
}

// ä¸€è¦§ï¼šã»ã©ã»ã©ã«æ–°ã—ã‘ã‚Œã°OKï¼ˆä¾‹ï¼š60ç§’ã§å†æ¤œè¨¼ï¼‰â±ï¸
export async function getPosts(): Promise<Pick<Post, "id" | "title">[]> {
  return fetchJson(`${API_BASE}/posts`, {
    next: { revalidate: 60 },
  });
}

// è©³ç´°ï¼šãƒ‡ãƒ¢ã¨ã—ã¦ã€Œå¸¸ã«æœ€æ–°ã€ã«ã—ãŸã„ãªã‚‰ no-store ğŸ”¥
//ï¼ˆé‹ç”¨ã§ã¯ã“ã“ã‚‚ revalidate ã«æƒãˆã¦ã‚‚OKã ã‚ˆğŸ˜Šï¼‰
export async function getPost(id: string): Promise<Post> {
  return fetchJson(`${API_BASE}/posts/${id}`, {
    cache: "no-store",
  });
}
```

`fetch` ã« `next: { revalidate }` ã‚„ `cache` ã‚’ä»˜ã‘ã¦ã€ã‚µãƒ¼ãƒãƒ¼å´ã®ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥æŒ™å‹•ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã‚ˆ ([Next.js][2])

---

## 2) ä¸€è¦§ãƒšãƒ¼ã‚¸ `app/posts/page.tsx` ğŸ“‹âœ¨

```tsx
// src/app/posts/page.tsx
import Link from "next/link";
import { getPosts } from "@/lib/posts";

export default async function PostsPage() {
  const posts = await getPosts();

  return (
    <main style={{ padding: 16 }}>
      <h1>æŠ•ç¨¿ä¸€è¦§ğŸ“š</h1>

      <ul style={{ lineHeight: 1.9 }}>
        {posts.slice(0, 10).map((p) => (
          <li key={p.id}>
            <Link href={`/posts/${p.id}`}>#{p.id} {p.title}</Link>
          </li>
        ))}
      </ul>
    </main>
  );
}
```

---

## 3) ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° `app/posts/loading.tsx` â³ğŸ’—

```tsx
// src/app/posts/loading.tsx
export default function Loading() {
  return (
    <main style={{ padding: 16 }}>
      <p>èª­ã¿è¾¼ã¿ä¸­ã ã‚ˆâ€¦â³âœ¨</p>
      <p>ã¡ã‚‡ã£ã¨å¾…ã£ã¦ã­ğŸ«¶</p>
    </main>
  );
}
```

---

## 4) ã‚¨ãƒ©ãƒ¼ `app/posts/error.tsx` ğŸ§¯ğŸ¥º

```tsx
// src/app/posts/error.tsx
"use client";

export default function Error({ error, reset }: { error: Error; reset: () => void }) {
  return (
    <main style={{ padding: 16 }}>
      <h2>ã”ã‚ã‚“ã­ã€èª­ã¿è¾¼ã¿å¤±æ•—ã—ã¡ã‚ƒã£ãŸğŸ¥ºğŸ§¯</h2>
      <p style={{ opacity: 0.8 }}>{error.message}</p>

      <button onClick={() => reset()} style={{ marginTop: 12, padding: "8px 12px" }}>
        ã‚‚ã†ä¸€å›ã‚„ã£ã¦ã¿ã‚‹ğŸ”âœ¨
      </button>
    </main>
  );
}
```

---

## 5) è©³ç´°ãƒšãƒ¼ã‚¸ `app/posts/[id]/page.tsx` ğŸ”âœ¨

```tsx
// src/app/posts/[id]/page.tsx
import Link from "next/link";
import { getPost } from "@/lib/posts";

export default async function PostDetailPage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = await params;
  const post = await getPost(id);

  return (
    <main style={{ padding: 16 }}>
      <Link href="/posts">â† ä¸€è¦§ã¸æˆ»ã‚‹ğŸ“‹</Link>

      <h1 style={{ marginTop: 12 }}>#{post.id} {post.title} âœ¨</h1>
      <p style={{ whiteSpace: "pre-wrap", lineHeight: 1.9 }}>{post.body}</p>
    </main>
  );
}
```

---

## ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­è¨ˆã®â€œãƒŸãƒ‹åˆ¤æ–­â€ğŸ§ŠğŸ§ 

ã€Œã©ã‚Œä½¿ã†ï¼Ÿã€ã£ã¦è¿·ã£ãŸã‚‰ã€ã¾ãšã“ã®åˆ†å²ã§OKã ã‚ˆğŸ˜Š

```mermaid
flowchart TD
  Q1{"ãƒ‡ãƒ¼ã‚¿ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ï¼ŸğŸ‘¤"} -->|"Yes"| NS["cache: #quot;no-store#quot; ğŸ”¥"]
  Q1 -->|"No"| Q2{"é »ç¹ã«æ›´æ–°ã•ã‚Œã‚‹ï¼Ÿâ±ï¸"}
  Q2 -->|"Yes"| RV["next: {#quot; revalidate: 30ã€œ300 #quot;} â±ï¸"]
  Q2 -->|"No"| FC["ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ/é•·ã‚revalidate ğŸ§Š"]
```

ã¡ãªã¿ã«ã€`cache: "no-store"` ã‚„ `revalidate: 0` ãªã©ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’é¿ã‘ã‚‰ã‚Œã‚‹ã‚ˆ ([Next.js][3])
ï¼ˆã‚ã¨ `cookies()` ã‚„ `headers()` ã¿ãŸã„ãª â€œDynamic APIâ€ ã‚’ä½¿ã†ã¨å‹•çš„æ‰±ã„ã«ãªã‚Šã‚„ã™ã„â€¦ã¿ãŸã„ãªãƒ«ãƒ¼ãƒ«ã‚‚ã‚ã‚‹ã‚ˆï¼‰ ([Next.js][3])

---

## ã“ã®ç« ã®â€œå‹â€ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆâœ…ğŸ’–

èª­ã¿å–ã‚Šã‚’å›ºã‚ã‚‹æ™‚ã¯ã€ã“ã‚ŒãŒæƒã£ã¦ãŸã‚‰å‹ã¡ã€œï¼ğŸ‰

* [ ] `lib/` ã« **èª­ã¿å–ã‚Šé–¢æ•°**ãŒã¾ã¨ã¾ã£ã¦ã‚‹ğŸ“¦
* [ ] **ä¸€è¦§**ï¼ˆRead manyï¼‰ã¨ **è©³ç´°**ï¼ˆRead oneï¼‰ãŒã‚ã‚‹ğŸ“‹ğŸ”
* [ ] ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ–¹é‡ãŒ **é–¢æ•°å´ã§è¦‹ãˆã‚‹**ï¼ˆ`revalidate` / `no-store`ï¼‰ğŸ§ŠğŸ”¥
* [ ] `loading.tsx` ã¨ `error.tsx` ãŒã‚ã‚‹â³ğŸ§¯
* [ ] ãƒšãƒ¼ã‚¸å´ã¯ã€Œå–ã£ã¦è¡¨ç¤ºã€ã ã‘ï¼ˆã”ã¡ã‚ƒã”ã¡ã‚ƒã—ãªã„ï¼‰âœ¨

---

## ãƒŸãƒ‹ç·´ç¿’ï¼ˆèª­ã¿å–ã‚Šè¨­è¨ˆã®ç­‹ãƒˆãƒ¬ğŸ‹ï¸â€â™€ï¸âœ¨ï¼‰

1. **è©³ç´°ã‚‚ `revalidate: 60` ã«æƒãˆã‚‹**ï¼ˆä¸€è¦§ã¨åŒã˜é®®åº¦ã«ã™ã‚‹ï¼‰ğŸ§Š
2. ä¸€è¦§è¡¨ç¤ºã‚’ `slice(0, 10)` â†’ `slice(0, 30)` ã«ã—ã¦ã€é‡ããªã‚Šãã†ãªã‚‰ã€Œä½•ã‚’å‰Šã‚‹ï¼Ÿã€ã‚’è€ƒãˆã‚‹ğŸ§ 
3. `fetchJson` ã« `console.log("fetching...")` ã‚’å…¥ã‚Œã¦ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®šã‚’å¤‰ãˆãŸæ™‚ã®æŒ™å‹•ã®é•ã„ã‚’è¦³å¯ŸğŸ‘€âœ¨ï¼ˆé–‹ç™ºä¸­ã¯å·®ãŒè¦‹ãˆã«ãã„ã“ã¨ã‚‚ã‚ã‚‹ã‚ˆï¼‰

---

ã“ã“ã¾ã§ã§ããŸã‚‰ã€ã‚‚ã† **ã€Œèª­ã¿å–ã‚Šã¯ã“ã®å‹ã§ä½œã‚‹ï¼ã€**ãŒå®Œæˆã ã‚ˆğŸ“šğŸ’—
ãƒ‡ãƒ¼ã‚¿å–å¾—ãŒãƒ–ãƒ¬ãªããªã‚‹ã¨ã€æ¬¡ã®æ©Ÿèƒ½è¿½åŠ ãŒã‚ã£ã¡ã‚ƒæ°—æŒã¡ã‚ˆãé€²ã‚€ã€œï¼ğŸ˜†âœ¨

[1]: https://nextjs.org/docs/app/getting-started/fetching-data?utm_source=chatgpt.com "Getting Started: Fetching Data"
[2]: https://nextjs.org/docs/app/api-reference/functions/fetch?utm_source=chatgpt.com "Functions: fetch"
[3]: https://nextjs.org/docs/14/app/building-your-application/data-fetching/fetching-caching-and-revalidating?utm_source=chatgpt.com "Data Fetching, Caching, and Revalidating"
